<!DOCTYPE html>
<html class="writer-html5" lang="en"> <head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="bebo" name="author"/><link href="../../img/favicon.ico" rel="shortcut icon"/><title>Security Model - Opossum Search Documentation</title><link href="../../css/theme.css" rel="stylesheet"/><link href="../../css/theme_extra.css" rel="stylesheet"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/><link href="../../assets/_mkdocstrings.css" rel="stylesheet"/><link href="../../stylesheets/extra.css" rel="stylesheet"/><script>
        // Current page data
        var mkdocs_page_name = "Security Model";
        var mkdocs_page_input_path = "technical\\security-model.md";
        var mkdocs_page_url = null;
      </script><!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script><script>hljs.highlightAll();</script></head> <body class="wy-body-for-nav" role="document"> <div class="wy-grid-for-nav"> <nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift"> <div class="wy-side-scroll"> <div class="wy-side-nav-search"> <a class="icon icon-home" href="../.."> Opossum Search Documentation </a><div role="search"> <form action="../../search.html" class="wy-form" id="rtd-search-form" method="get"> <input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/> </form> </div> </div> <div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation"> <ul> <li class="toctree-l1"><a class="reference internal" href="../..">Home</a> </li> </ul> <p class="caption"><span class="caption-text">Getting Started</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../getting-started/">First Steps</a> </li> <li class="toctree-l1"><a class="reference internal" href="../system-architecture-overview/">System Overview</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/getting-started/">API Reference</a> </li> <li class="toctree-l1"><a class="reference internal" href="../devops-guide/">Developer Quickstart</a> </li> </ul> <p class="caption"><span class="caption-text">Core Components</span></p> <ul class="current"> <li class="toctree-l1 current"><a class="reference internal current">Architecture</a> <ul class="current"> <li class="toctree-l2"><a class="reference internal" href="../system-architecture-overview/">System Overview</a> </li> <li class="toctree-l2"><a class="reference internal" href="../mcp-architecture/">Model Context Protocol (MCP)</a> </li> <li class="toctree-l2"><a class="reference internal" href="../graphql-api/">GraphQL API</a> </li> <li class="toctree-l2 current"><a class="reference internal current" href="#">Security Model</a> <ul class="current"> <li class="toctree-l3"><a class="reference internal" href="#security-architecture-overview">Security Architecture Overview</a> </li> <li class="toctree-l3"><a class="reference internal" href="#authentication-and-authorization">Authentication and Authorization</a> <ul> <li class="toctree-l4"><a class="reference internal" href="#authentication-mechanisms">Authentication Mechanisms</a> </li> <li class="toctree-l4"><a class="reference internal" href="#authorization-framework">Authorization Framework</a> </li> <li class="toctree-l4"><a class="reference internal" href="#permission-model">Permission Model</a> </li> </ul> </li> <li class="toctree-l3"><a class="reference internal" href="#data-security">Data Security</a> <ul> <li class="toctree-l4"><a class="reference internal" href="#data-classification">Data Classification</a> </li> <li class="toctree-l4"><a class="reference internal" href="#encryption-implementation">Encryption Implementation</a> </li> <li class="toctree-l4"><a class="reference internal" href="#database-security">Database Security</a> </li> <li class="toctree-l4"><a class="reference internal" href="#data-retention-policies">Data Retention Policies</a> </li> </ul> </li> <li class="toctree-l3"><a class="reference internal" href="#api-security">API Security</a> <ul> <li class="toctree-l4"><a class="reference internal" href="#graphql-security-controls">GraphQL Security Controls</a> </li> <li class="toctree-l4"><a class="reference internal" href="#rate-limiting-implementation">Rate Limiting Implementation</a> </li> <li class="toctree-l4"><a class="reference internal" href="#input-validation">Input Validation</a> </li> </ul> </li> <li class="toctree-l3"><a class="reference internal" href="#image-processing-security">Image Processing Security</a> <ul> <li class="toctree-l4"><a class="reference internal" href="#image-validation">Image Validation</a> </li> <li class="toctree-l4"><a class="reference internal" href="#svg-sanitization">SVG Sanitization</a> </li> </ul> </li> <li class="toctree-l3"><a class="reference internal" href="#model-security">Model Security</a> <ul> <li class="toctree-l4"><a class="reference internal" href="#prompt-injection-protection">Prompt Injection Protection</a> </li> <li class="toctree-l4"><a class="reference internal" href="#response-filtering">Response Filtering</a> </li> </ul> </li> <li class="toctree-l3"><a class="reference internal" href="#infrastructure-security">Infrastructure Security</a> <ul> <li class="toctree-l4"><a class="reference internal" href="#network-security-configuration">Network Security Configuration</a> </li> <li class="toctree-l4"><a class="reference internal" href="#container-security">Container Security</a> </li> <li class="toctree-l4"><a class="reference internal" href="#secret-management">Secret Management</a> </li> </ul> </li> <li class="toctree-l3"><a class="reference internal" href="#monitoring-and-incident-response">Monitoring and Incident Response</a> <ul> <li class="toctree-l4"><a class="reference internal" href="#security-logging">Security Logging</a> </li> <li class="toctree-l4"><a class="reference internal" href="#intrusion-detection">Intrusion Detection</a> </li> <li class="toctree-l4"><a class="reference internal" href="#incident-response-plan">Incident Response Plan</a> </li> </ul> </li> <li class="toctree-l3"><a class="reference internal" href="#compliance-framework">Compliance Framework</a> <ul> <li class="toctree-l4"><a class="reference internal" href="#compliance-controls">Compliance Controls</a> </li> <li class="toctree-l4"><a class="reference internal" href="#privacy-by-design">Privacy by Design</a> </li> <li class="toctree-l4"><a class="reference internal" href="#data-subject-rights">Data Subject Rights</a> </li> </ul> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="../prompt-management/">Prompt Management</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Model Integration</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/architecture/">Architecture</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/backend-selection/">Backend Selection</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/capability-matrix/">Capability Matrix</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/providers/">Provider Integration</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/configuration/">Configuration</a> </li> <li class="toctree-l2"><a class="reference internal" href="../hybrid-model-selection/">Hybrid Selection</a> </li> <li class="toctree-l2"><a class="reference internal" href="../prompt-management/">Prompt Management</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/dspy-integration/">DSPy Integration</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/dspy-technical/">DSPy Technical Implementation</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/dspy-examples/">DSPy Usage Examples</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../model-integration/dspy-metrics/">DSPy Metrics &amp; Performance</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Service Availability</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../service-availability/context-and-scope/">Context and Scope</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../service-availability/quality-requirements/">Quality Requirements</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../service-availability/architecture-constraints/">Architecture Constraints</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../service-availability/availability-monitoring/">Availability Monitoring</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../service-availability/service-outage/">Error Handling</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Resilience Patterns</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../resilience-patterns/">Core Strategies</a> </li> <li class="toctree-l2"><a class="reference internal" href="../error-handling-resilience/">Error Handling</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../service-availability/rate-limiting-throttling/">Rate Limiting</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../service-availability/log-alerts/">Logging and Alerts</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../service-availability/testing-validation/">Testing and Validation</a> </li> </ul> </li> </ul> <p class="caption"><span class="caption-text">Features</span></p> <ul> <li class="toctree-l1"><a class="reference internal">Conversation</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../conversation/topic-detection/">Topic Detection</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../conversation/conversation-flow/">Conversation Flow</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../conversation/response-generation/">Response Generation</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../conversation/nlp-components/">NLP Components</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../conversation/markov-generation/">Markov Generation</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Image Processing</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../image-processing/overview/">Overview</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../image-processing/effects/">Effects and Filters</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../image-processing/svg-generation/">SVG Generation</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../image-processing/optimization/">Performance Optimization</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../image-processing/caching/">Caching Strategy</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Visualizations &amp; Fun</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../features/service-vizualizations/">Service Visualizations</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../features/national-day/">National Opossum Day</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../features/opossum-xenzia/">Opossum Xenzia</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../features/easter-eggs/">Easter Eggs</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../features/special-events/">Special Events</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../features/background-stories/">Background Stories</a> </li> </ul> </li> </ul> <p class="caption"><span class="caption-text">Technical Reference</span></p> <ul> <li class="toctree-l1"><a class="reference internal">Infrastructure</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../redis-caching-architecture/">Redis Caching</a> </li> <li class="toctree-l2"><a class="reference internal" href="../image-processing-pipeline/">Image Pipeline</a> </li> <li class="toctree-l2"><a class="reference internal" href="../opentelemetry-integration/">OpenTelemetry</a> </li> <li class="toctree-l2"><a class="reference internal" href="../svg-markup/">SVG Markup</a> </li> <li class="toctree-l2"><a class="reference internal" href="../bot-user-simulation/">Bot User Simulation</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../infrastructure/optimization-strategies/">Optimization Strategies</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../infrastructure/pipeline-optimization/">Pipeline Optimization</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../infrastructure/constraint-mapping/">Constraint Mapping</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">API Documentation</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../api/routes/">Routes</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../api/request-response/">Request/Response</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../api/oauth-configuration/">OAuth Configuration</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../api/error-codes/">Error Codes</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../api/rate-limits/">Rate Limits</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../api/webhooks/">Webhook Integration</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../api/health-endpoints/">Health Endpoints</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../api/compliance/">Compliance</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">DSPy Tutorials</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../tutorials/dspy/getting-started/">Getting Started with DSPy</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../tutorials/dspy/optimizing-prompts/">Optimizing Prompts</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../tutorials/dspy/building-pipelines/">Building Pipelines</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../tutorials/dspy/advanced-reasoning/">Advanced Reasoning</a> </li> </ul> </li> </ul> <p class="caption"><span class="caption-text">About</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../about/history/">Project History</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/opossumial-way/">The Opossumial Way</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/team/">Team</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/roadmap-vision/">Roadmap &amp; Vision</a> </li> </ul> </div> </div> </nav> <section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"> <nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation"> <i class="fa fa-bars" data-toggle="wy-nav-top"></i> <a href="../..">Opossum Search Documentation</a> </nav> <div class="wy-nav-content"> <div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation"> <ul class="wy-breadcrumbs"> <li><a aria-label="Docs" class="icon icon-home" href="../.."></a></li> <li class="breadcrumb-item">Core Components</li> <li class="breadcrumb-item">Architecture</li> <li class="breadcrumb-item active">Security Model</li> <li class="wy-breadcrumbs-aside"> </li> </ul> <hr/> </div> <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main"> <div class="section" itemprop="articleBody"> <h1 id="technical-documentation-security-model">Technical Documentation: Security Model<a class="headerlink" href="#technical-documentation-security-model" title="Permanent link">¶</a></h1> <h2 id="security-architecture-overview">Security Architecture Overview<a class="headerlink" href="#security-architecture-overview" title="Permanent link">¶</a></h2> <p>Opossum Search implements a comprehensive security model to protect user data, API infrastructure, and backend services. The security architecture follows these key principles:</p> <ul> <li><strong>Defense in Depth</strong>: Multiple security controls at different layers</li> <li><strong>Principle of Least Privilege</strong>: Minimal access rights for components</li> <li><strong>Secure by Default</strong>: Conservative security defaults</li> <li><strong>Fail Secure</strong>: Systems fail to a secure state</li> <li><strong>Input/Output Validation</strong>: All data is validated at entry and exit points</li> </ul> <pre class="mermaid"><code>flowchart TD
    A[Client] --&gt; |TLS| B[Load Balancer]
    B --&gt; |TLS| C[API Gateway]
    C --&gt; D{Authentication}
    D --&gt; |Authenticated| E[GraphQL API]
    D --&gt; |Unauthenticated| F[Error Response]
    E --&gt; G[API Key Validation]
    E --&gt; H[Rate Limiting]
    E --&gt; I[Input Validation]

    I --&gt; J[GraphQL Resolvers]
    J --&gt; K[Backend Services]

    K --&gt; L[Redis Cache]
    K --&gt; M[Ollama Service]
    K --&gt; N[Gemini API]

    style A fill:#A4C2F4
    style B fill:#F9CB9C
    style D fill:#F9CB9C
    style F fill:#EA9999
    style G fill:#B6D7A8
    style H fill:#B6D7A8
    style I fill:#B6D7A8</code></pre> <h2 id="authentication-and-authorization">Authentication and Authorization<a class="headerlink" href="#authentication-and-authorization" title="Permanent link">¶</a></h2> <h3 id="authentication-mechanisms">Authentication Mechanisms<a class="headerlink" href="#authentication-mechanisms" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># app/auth/authentication.py</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">authenticate_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="sd">"""Authenticate incoming request"""</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="c1"># Check for API key</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"x-api-key"</span><span class="p">)</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"api_key"</span><span class="p">)</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="k">return</span> <span class="k">await</span> <span class="n">validate_api_key</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="c1"># Check for JWT token</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"authorization"</span><span class="p">)</span>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">if</span> <span class="n">auth_header</span> <span class="ow">and</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"Bearer "</span><span class="p">):</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"Bearer "</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="k">return</span> <span class="k">await</span> <span class="n">validate_jwt_token</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="c1"># No valid authentication found</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div> <h3 id="authorization-framework">Authorization Framework<a class="headerlink" href="#authorization-framework" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># GraphQL auth directive implementation</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuthDirective</span><span class="p">(</span><span class="n">SchemaDirectiveVisitor</span><span class="p">):</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visit_field_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">object_type</span><span class="p">):</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="n">original_resolver</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">resolve</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="n">required_role</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"requires"</span><span class="p">,</span> <span class="s2">"USER"</span><span class="p">)</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">resolve_with_auth</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>            <span class="c1"># Get user from context</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>            <span class="n">user</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"user"</span><span class="p">)</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>            <span class="c1"># Check authentication</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>                <span class="k">raise</span> <span class="n">GraphQLError</span><span class="p">(</span><span class="s2">"Authentication required"</span><span class="p">)</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>            <span class="c1"># Check authorization</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>            <span class="k">if</span> <span class="n">required_role</span> <span class="o">==</span> <span class="s2">"ADMIN"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"is_admin"</span><span class="p">):</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>                <span class="k">raise</span> <span class="n">GraphQLError</span><span class="p">(</span><span class="s2">"Admin privileges required"</span><span class="p">)</span>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>            <span class="c1"># Call original resolver</span>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>            <span class="k">return</span> <span class="k">await</span> <span class="n">original_resolver</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>        <span class="n">field</span><span class="o">.</span><span class="n">resolve</span> <span class="o">=</span> <span class="n">resolve_with_auth</span>
<a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>        <span class="k">return</span> <span class="n">field</span>
</code></pre></div> <h3 id="permission-model">Permission Model<a class="headerlink" href="#permission-model" title="Permanent link">¶</a></h3> <table> <thead> <tr> <th>Role</th> <th>Capabilities</th> <th>Access Control</th> </tr> </thead> <tbody> <tr> <td><strong>Anonymous</strong></td> <td>Basic search queries only</td> <td>Rate limited to 10 requests/minute</td> </tr> <tr> <td><strong>User</strong></td> <td>Standard search, chat, image processing</td> <td>Rate limited to 50 requests/minute</td> </tr> <tr> <td><strong>Admin</strong></td> <td>All features, system management</td> <td>Rate limited to 100 requests/minute</td> </tr> </tbody> </table> <h2 id="data-security">Data Security<a class="headerlink" href="#data-security" title="Permanent link">¶</a></h2> <h3 id="data-classification">Data Classification<a class="headerlink" href="#data-classification" title="Permanent link">¶</a></h3> <table> <thead> <tr> <th>Category</th> <th>Description</th> <th>Examples</th> <th>Protection</th> </tr> </thead> <tbody> <tr> <td><strong>Public</strong></td> <td>Non-sensitive, publicly available</td> <td>Public documentation</td> <td>Basic validation</td> </tr> <tr> <td><strong>Internal</strong></td> <td>Non-sensitive, internal use</td> <td>Metrics, logs</td> <td>Access control</td> </tr> <tr> <td><strong>Confidential</strong></td> <td>Business sensitive</td> <td>API keys, user search history</td> <td>Encryption, access control</td> </tr> <tr> <td><strong>Restricted</strong></td> <td>Highly sensitive</td> <td>Authentication tokens</td> <td>Encryption, strict access</td> </tr> </tbody> </table> <h3 id="encryption-implementation">Encryption Implementation<a class="headerlink" href="#encryption-implementation" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1"># app/security/encryption.py</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">cryptography.fernet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fernet</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">DataEncryption</span><span class="p">:</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_encryption_key</span><span class="p">()</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_encryption_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">        </span><span class="sd">"""Get encryption key from secure storage"""</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"ENCRYPTION_KEY"</span><span class="p">)</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">"Encryption key not configured"</span><span class="p">)</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="sd">"""Encrypt sensitive data"""</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>
<a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">        </span><span class="sd">"""Decrypt sensitive data"""</span>
<a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</code></pre></div> <h3 id="database-security">Database Security<a class="headerlink" href="#database-security" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="c1"># Redis security configuration in config.py</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">REDIS_HOST</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"REDIS_HOST"</span><span class="p">,</span> <span class="s2">"localhost"</span><span class="p">)</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="n">REDIS_PORT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"REDIS_PORT"</span><span class="p">,</span> <span class="s2">"6379"</span><span class="p">))</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="n">REDIS_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"REDIS_PASSWORD"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="n">REDIS_USE_SSL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"REDIS_USE_SSL"</span><span class="p">,</span> <span class="s2">"False"</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">"true"</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1"># Redis connection with security settings</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_redis_client</span><span class="p">():</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="sd">"""Get Redis client with security settings"""</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="k">return</span> <span class="n">aioredis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>        <span class="n">host</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">REDIS_HOST</span><span class="p">,</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>        <span class="n">port</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">REDIS_PORT</span><span class="p">,</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>        <span class="n">password</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>        <span class="n">ssl</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">REDIS_USE_SSL</span><span class="p">,</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>        <span class="n">ssl_cert_reqs</span><span class="o">=</span><span class="s2">"required"</span> <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">REDIS_USE_SSL</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="n">ssl_ca_certs</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">REDIS_CA_CERT</span> <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">REDIS_USE_SSL</span> <span class="k">else</span> <span class="kc">None</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>    <span class="p">)</span>
</code></pre></div> <h3 id="data-retention-policies">Data Retention Policies<a class="headerlink" href="#data-retention-policies" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1"># app/policies/retention.py</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply_retention_policies</span><span class="p">():</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="sd">"""Apply data retention policies"""</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="n">redis</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_redis_client</span><span class="p">()</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>    <span class="c1"># User search history - keep 90 days</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>    <span class="n">retention_days</span> <span class="o">=</span> <span class="mi">90</span>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">retention_days</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">)</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>    <span class="c1"># Remove expired search history</span>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>    <span class="n">user_keys</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="s2">"user:*:searches"</span><span class="p">)</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">user_keys</span><span class="p">:</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>        <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">zremrangebyscore</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="c1"># Image data - keep 7 days</span>
<a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>    <span class="n">image_retention_days</span> <span class="o">=</span> <span class="mi">7</span>
<a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>    <span class="n">image_cutoff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">image_retention_days</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">)</span>
<a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>
<a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>    <span class="c1"># Remove expired image data</span>
<a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>    <span class="n">image_keys</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="s2">"image:data:*"</span><span class="p">)</span>
<a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">image_keys</span><span class="p">:</span>
<a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>        <span class="n">timestamp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">"timestamp"</span><span class="p">)</span>
<a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">image_cutoff</span><span class="p">:</span>
<a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a>            <span class="k">await</span> <span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div> <h2 id="api-security">API Security<a class="headerlink" href="#api-security" title="Permanent link">¶</a></h2> <h3 id="graphql-security-controls">GraphQL Security Controls<a class="headerlink" href="#graphql-security-controls" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># GraphQL security configuration</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">graphql_app</span> <span class="o">=</span> <span class="n">GraphQL</span><span class="p">(</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="n">schema</span><span class="p">,</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="n">debug</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="n">validation_rules</span><span class="o">=</span><span class="p">[</span>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>        <span class="n">cost_analysis_validation</span><span class="p">,</span>   <span class="c1"># Prevent resource-intensive queries</span>
<a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>        <span class="n">depth_limit_validation</span><span class="p">,</span>     <span class="c1"># Prevent deeply nested queries</span>
<a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>        <span class="n">query_complexity_validation</span> <span class="c1"># Limit overall query complexity</span>
<a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="p">],</span>
<a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>    <span class="n">introspection</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">GRAPHQL_INTROSPECTION_ENABLED</span>
<a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="p">)</span>
</code></pre></div> <h3 id="rate-limiting-implementation">Rate Limiting Implementation<a class="headerlink" href="#rate-limiting-implementation" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1"># app/security/rate_limiting.py</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">RateLimiter</span><span class="p">:</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">):</span>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">is_rate_limited</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">limit_key</span><span class="o">=</span><span class="s2">"default"</span><span class="p">):</span>
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">        </span><span class="sd">"""Check if client is rate limited"""</span>
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>        <span class="c1"># Get rate limit configuration</span>
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>        <span class="n">limits</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">RATE_LIMITS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">limit_key</span><span class="p">,</span> <span class="p">[</span><span class="s2">"100 per day"</span><span class="p">])</span>
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>
<a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>        <span class="c1"># Check each limit</span>
<a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a>        <span class="k">for</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
<a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a>            <span class="n">count</span><span class="p">,</span> <span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
<a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a>            <span class="n">rate_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"ratelimit:</span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">limit_key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a>
<a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a>            <span class="c1"># Check current count</span>
<a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a>            <span class="n">current</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rate_key</span><span class="p">)</span>
<a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a>            <span class="k">if</span> <span class="n">current</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">:</span>
<a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a>                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Rate limited</span>
<a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a>
<a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a>        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># Not rate limited</span>
<a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a>
<a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">increment_rate_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">limit_key</span><span class="o">=</span><span class="s2">"default"</span><span class="p">):</span>
<a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">        </span><span class="sd">"""Increment rate counters for all applicable limits"""</span>
<a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a>        <span class="n">limits</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">RATE_LIMITS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">limit_key</span><span class="p">,</span> <span class="p">[</span><span class="s2">"100 per day"</span><span class="p">])</span>
<a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a>
<a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a>        <span class="k">for</span> <span class="n">limit</span> <span class="ow">in</span> <span class="n">limits</span><span class="p">:</span>
<a href="#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a>            <span class="n">count</span><span class="p">,</span> <span class="n">period</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
<a href="#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a>            <span class="n">seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_period_to_seconds</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
<a href="#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a>            <span class="n">rate_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"ratelimit:</span><span class="si">{</span><span class="n">client_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">limit_key</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">period</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a>
<a href="#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a>            <span class="c1"># Increment counter and set expiration</span>
<a href="#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="n">rate_key</span><span class="p">)</span>
<a href="#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">rate_key</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-6-35" id="__codelineno-6-35" name="__codelineno-6-35"></a>
<a href="#__codelineno-6-36" id="__codelineno-6-36" name="__codelineno-6-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
<a href="#__codelineno-6-37" id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">        </span><span class="sd">"""Parse limit string like '100 per day'"""</span>
<a href="#__codelineno-6-38" id="__codelineno-6-38" name="__codelineno-6-38"></a>        <span class="n">parts</span> <span class="o">=</span> <span class="n">limit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" per "</span><span class="p">)</span>
<a href="#__codelineno-6-39" id="__codelineno-6-39" name="__codelineno-6-39"></a>        <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a href="#__codelineno-6-40" id="__codelineno-6-40" name="__codelineno-6-40"></a>        <span class="n">period</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a href="#__codelineno-6-41" id="__codelineno-6-41" name="__codelineno-6-41"></a>        <span class="k">return</span> <span class="n">count</span><span class="p">,</span> <span class="n">period</span>
<a href="#__codelineno-6-42" id="__codelineno-6-42" name="__codelineno-6-42"></a>
<a href="#__codelineno-6-43" id="__codelineno-6-43" name="__codelineno-6-43"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_period_to_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
<a href="#__codelineno-6-44" id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">        </span><span class="sd">"""Convert period to seconds"""</span>
<a href="#__codelineno-6-45" id="__codelineno-6-45" name="__codelineno-6-45"></a>        <span class="k">if</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">"second"</span><span class="p">:</span>
<a href="#__codelineno-6-46" id="__codelineno-6-46" name="__codelineno-6-46"></a>            <span class="k">return</span> <span class="mi">1</span>
<a href="#__codelineno-6-47" id="__codelineno-6-47" name="__codelineno-6-47"></a>        <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">"minute"</span><span class="p">:</span>
<a href="#__codelineno-6-48" id="__codelineno-6-48" name="__codelineno-6-48"></a>            <span class="k">return</span> <span class="mi">60</span>
<a href="#__codelineno-6-49" id="__codelineno-6-49" name="__codelineno-6-49"></a>        <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">"hour"</span><span class="p">:</span>
<a href="#__codelineno-6-50" id="__codelineno-6-50" name="__codelineno-6-50"></a>            <span class="k">return</span> <span class="mi">3600</span>
<a href="#__codelineno-6-51" id="__codelineno-6-51" name="__codelineno-6-51"></a>        <span class="k">elif</span> <span class="n">period</span> <span class="o">==</span> <span class="s2">"day"</span><span class="p">:</span>
<a href="#__codelineno-6-52" id="__codelineno-6-52" name="__codelineno-6-52"></a>            <span class="k">return</span> <span class="mi">86400</span>
<a href="#__codelineno-6-53" id="__codelineno-6-53" name="__codelineno-6-53"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-6-54" id="__codelineno-6-54" name="__codelineno-6-54"></a>            <span class="k">return</span> <span class="mi">86400</span>  <span class="c1"># Default to day</span>
</code></pre></div> <h3 id="input-validation">Input Validation<a class="headerlink" href="#input-validation" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1"># app/validators/input_validator.py</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">InputValidator</span><span class="p">:</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span class="nd">@staticmethod</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate_query</span><span class="p">(</span><span class="n">query_text</span><span class="p">):</span>
<a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">        </span><span class="sd">"""Validate search query text"""</span>
<a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">query_text</span><span class="p">:</span>
<a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">"Query cannot be empty"</span><span class="p">)</span>
<a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a>
<a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Config</span><span class="o">.</span><span class="n">MAX_QUERY_LENGTH</span><span class="p">:</span>
<a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Query exceeds maximum length of </span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">MAX_QUERY_LENGTH</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a>
<a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>        <span class="c1"># Check for potentially malicious patterns</span>
<a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a>        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'&lt;script|javascript:|data:text/html'</span><span class="p">,</span> <span class="n">query_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
<a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">"Query contains potentially unsafe content"</span><span class="p">)</span>
<a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a>        <span class="k">return</span> <span class="n">query_text</span>
<a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a>
<a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a>    <span class="nd">@staticmethod</span>
<a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">sanitize_output</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">        </span><span class="sd">"""Sanitize output text"""</span>
<a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a>        <span class="c1"># Remove potential XSS vectors</span>
<a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'&lt;script.*?&gt;.*?&lt;/script&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'javascript:'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a href="#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a>
<a href="#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a>        <span class="c1"># Allow safe HTML tags if configured</span>
<a href="#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a>        <span class="k">if</span> <span class="n">Config</span><span class="o">.</span><span class="n">ALLOW_SAFE_HTML</span><span class="p">:</span>
<a href="#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a>            <span class="c1"># Use a whitelist approach</span>
<a href="#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a>            <span class="n">allowed_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'p'</span><span class="p">,</span> <span class="s1">'br'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'i'</span><span class="p">,</span> <span class="s1">'em'</span><span class="p">,</span> <span class="s1">'strong'</span><span class="p">,</span> <span class="s1">'ul'</span><span class="p">,</span> <span class="s1">'ol'</span><span class="p">,</span> <span class="s1">'li'</span><span class="p">,</span> <span class="s1">'code'</span><span class="p">]</span>
<a href="#__codelineno-7-29" id="__codelineno-7-29" name="__codelineno-7-29"></a>            <span class="c1"># Implementation would use a proper HTML sanitizer like bleach</span>
<a href="#__codelineno-7-30" id="__codelineno-7-30" name="__codelineno-7-30"></a>            <span class="k">return</span> <span class="n">text</span>
<a href="#__codelineno-7-31" id="__codelineno-7-31" name="__codelineno-7-31"></a>
<a href="#__codelineno-7-32" id="__codelineno-7-32" name="__codelineno-7-32"></a>        <span class="c1"># Otherwise strip all HTML</span>
<a href="#__codelineno-7-33" id="__codelineno-7-33" name="__codelineno-7-33"></a>        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'&lt;.*?&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div> <h2 id="image-processing-security">Image Processing Security<a class="headerlink" href="#image-processing-security" title="Permanent link">¶</a></h2> <h3 id="image-validation">Image Validation<a class="headerlink" href="#image-validation" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1"># app/security/image_validation.py</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate_image</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span> <span class="n">mime_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="sd">"""Validate image for security concerns"""</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a>    <span class="c1"># Check size limits</span>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Config</span><span class="o">.</span><span class="n">MAX_IMAGE_SIZE</span><span class="p">:</span>
<a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a>        <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Image exceeds maximum size of </span><span class="si">{</span><span class="n">Config</span><span class="o">.</span><span class="n">MAX_IMAGE_SIZE</span><span class="si">}</span><span class="s2"> bytes"</span><span class="p">)</span>
<a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a>
<a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a>    <span class="c1"># Verify image format</span>
<a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a>    <span class="n">allowed_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'image/jpeg'</span><span class="p">,</span> <span class="s1">'image/png'</span><span class="p">,</span> <span class="s1">'image/gif'</span><span class="p">,</span> <span class="s1">'image/webp'</span><span class="p">]</span>
<a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a>    <span class="k">if</span> <span class="n">mime_type</span> <span class="ow">and</span> <span class="n">mime_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_formats</span><span class="p">:</span>
<a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a>        <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Image format not allowed: </span><span class="si">{</span><span class="n">mime_type</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a>
<a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="c1"># Validate image integrity</span>
<a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a>    <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a>        <span class="k">with</span> <span class="n">wand</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">blob</span><span class="o">=</span><span class="n">image_data</span><span class="p">)</span> <span class="k">as</span> <span class="n">img</span><span class="p">:</span>
<a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a>            <span class="c1"># Check for suspiciously large dimensions</span>
<a href="#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a>            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">10000</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
<a href="#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a>                <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Image dimensions too large: </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">width</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a>
<a href="#__codelineno-8-20" id="__codelineno-8-20" name="__codelineno-8-20"></a>            <span class="c1"># Validate image format matches claimed format</span>
<a href="#__codelineno-8-21" id="__codelineno-8-21" name="__codelineno-8-21"></a>            <span class="k">if</span> <span class="n">mime_type</span> <span class="ow">and</span> <span class="sa">f</span><span class="s2">"image/</span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span> <span class="o">!=</span> <span class="n">mime_type</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a href="#__codelineno-8-22" id="__codelineno-8-22" name="__codelineno-8-22"></a>                <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">"Image format doesn't match claimed format"</span><span class="p">)</span>
<a href="#__codelineno-8-23" id="__codelineno-8-23" name="__codelineno-8-23"></a>
<a href="#__codelineno-8-24" id="__codelineno-8-24" name="__codelineno-8-24"></a>            <span class="c1"># Check for format-specific exploits</span>
<a href="#__codelineno-8-25" id="__codelineno-8-25" name="__codelineno-8-25"></a>            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'svg'</span><span class="p">:</span>
<a href="#__codelineno-8-26" id="__codelineno-8-26" name="__codelineno-8-26"></a>                <span class="c1"># SVG can contain script tags</span>
<a href="#__codelineno-8-27" id="__codelineno-8-27" name="__codelineno-8-27"></a>                <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="s2">"SVG format not accepted for upload"</span><span class="p">)</span>
<a href="#__codelineno-8-28" id="__codelineno-8-28" name="__codelineno-8-28"></a>
<a href="#__codelineno-8-29" id="__codelineno-8-29" name="__codelineno-8-29"></a>            <span class="k">return</span> <span class="kc">True</span>
<a href="#__codelineno-8-30" id="__codelineno-8-30" name="__codelineno-8-30"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a href="#__codelineno-8-31" id="__codelineno-8-31" name="__codelineno-8-31"></a>        <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Image validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</code></pre></div> <h3 id="svg-sanitization">SVG Sanitization<a class="headerlink" href="#svg-sanitization" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1"># app/security/svg_sanitization.py</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">sanitize_svg</span><span class="p">(</span><span class="n">svg_markup</span><span class="p">):</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="sd">"""Sanitize SVG markup for secure display"""</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>    <span class="c1"># Remove any script tags</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>    <span class="n">svg_markup</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'&lt;script.*?&lt;/script&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">svg_markup</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>    <span class="c1"># Remove event handlers</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>    <span class="n">svg_markup</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'on\w+=".*?"'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">svg_markup</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a>    <span class="c1"># Remove external references</span>
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>    <span class="n">svg_markup</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'href="(?!#).*?"'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">svg_markup</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a>
<a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a>    <span class="c1"># Remove potentially dangerous tags</span>
<a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a>    <span class="n">dangerous_tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'foreignObject'</span><span class="p">,</span> <span class="s1">'use'</span><span class="p">]</span>
<a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">dangerous_tags</span><span class="p">:</span>
<a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a>        <span class="n">svg_markup</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">f</span><span class="s1">'&lt;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">.*?&lt;/</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">svg_markup</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a>        <span class="n">svg_markup</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">f</span><span class="s1">'&lt;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">.*?/&gt;'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="n">svg_markup</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="o">|</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
<a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a>
<a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a>    <span class="c1"># Ensure SVG namespace is correct</span>
<a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a>    <span class="k">if</span> <span class="s1">'xmlns="http://www.w3.org/2000/svg"'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">svg_markup</span><span class="p">:</span>
<a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a>        <span class="n">svg_markup</span> <span class="o">=</span> <span class="n">svg_markup</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;svg'</span><span class="p">,</span> <span class="s1">'&lt;svg xmlns="http://www.w3.org/2000/svg"'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a>
<a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a>    <span class="k">return</span> <span class="n">svg_markup</span>
</code></pre></div> <h2 id="model-security">Model Security<a class="headerlink" href="#model-security" title="Permanent link">¶</a></h2> <h3 id="prompt-injection-protection">Prompt Injection Protection<a class="headerlink" href="#prompt-injection-protection" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1"># app/security/prompt_security.py</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">secure_prompt</span><span class="p">(</span><span class="n">user_input</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="sd">"""Secure prompt template from injection attacks"""</span>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="c1"># Escape special characters</span>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>    <span class="n">safe_input</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">user_input</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Use JSON encoding but remove quotes</span>
<a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>
<a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>    <span class="c1"># Use a whitelist approach for allowed characters if needed</span>
<a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">'^[a-zA-Z0-9\s.,?!</span><span class="se">\'</span><span class="s1">"-:;()]+$'</span><span class="p">,</span> <span class="n">user_input</span><span class="p">):</span>
<a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Potentially unsafe characters in prompt: </span><span class="si">{</span><span class="n">user_input</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>
<a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>    <span class="c1"># Apply template with escaped input</span>
<a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>    <span class="n">prompt</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"</span><span class="si">{user_input}</span><span class="s2">"</span><span class="p">,</span> <span class="n">safe_input</span><span class="p">)</span>
<a href="#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>
<a href="#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a>    <span class="c1"># Add safety instructions to prompt preamble</span>
<a href="#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a>    <span class="n">safety_instructions</span> <span class="o">=</span> <span class="s2">"""</span>
<a href="#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="s2">    Important: Respond only to the user query. </span>
<a href="#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="s2">    Do not execute commands. </span>
<a href="#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="s2">    Do not engage with harmful, illegal, unethical or deceptive content.</span>
<a href="#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="s2">    """</span>
<a href="#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a>
<a href="#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a>    <span class="k">return</span> <span class="n">safety_instructions</span> <span class="o">+</span> <span class="n">prompt</span>
</code></pre></div> <h3 id="response-filtering">Response Filtering<a class="headerlink" href="#response-filtering" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1"># app/security/content_filtering.py</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">ContentFilter</span><span class="p">:</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a>        <span class="c1"># Load blocklisted patterns and terms</span>
<a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocklisted_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_blocklist</span><span class="p">()</span>
<a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a>
<a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_load_blocklist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">        </span><span class="sd">"""Load blocklisted patterns"""</span>
<a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"config/content_blocklists.json"</span><span class="p">,</span> <span class="s2">"r"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a>            <span class="n">blocklists</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a>
<a href="#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a>        <span class="c1"># Compile regex patterns for performance</span>
<a href="#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a>        <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a>            <span class="n">category</span><span class="p">:</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> 
<a href="#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a>                      <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">]</span>
<a href="#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a>            <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">patterns</span> <span class="ow">in</span> <span class="n">blocklists</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a href="#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a>        <span class="p">}</span>
<a href="#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a>
<a href="#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">filter_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<a href="#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">        </span><span class="sd">"""Filter potentially harmful content from responses"""</span>
<a href="#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a>        <span class="c1"># Check for harmful content</span>
<a href="#__codelineno-11-22" id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span class="n">filtered_response</span> <span class="o">=</span> <span class="n">response</span>
<a href="#__codelineno-11-23" id="__codelineno-11-23" name="__codelineno-11-23"></a>
<a href="#__codelineno-11-24" id="__codelineno-11-24" name="__codelineno-11-24"></a>        <span class="c1"># Check against each category</span>
<a href="#__codelineno-11-25" id="__codelineno-11-25" name="__codelineno-11-25"></a>        <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">patterns</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocklisted_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-11-26" id="__codelineno-11-26" name="__codelineno-11-26"></a>            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
<a href="#__codelineno-11-27" id="__codelineno-11-27" name="__codelineno-11-27"></a>                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
<a href="#__codelineno-11-28" id="__codelineno-11-28" name="__codelineno-11-28"></a>                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Found potentially problematic content in category: </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-11-29" id="__codelineno-11-29" name="__codelineno-11-29"></a>
<a href="#__codelineno-11-30" id="__codelineno-11-30" name="__codelineno-11-30"></a>                    <span class="c1"># Apply redaction based on category</span>
<a href="#__codelineno-11-31" id="__codelineno-11-31" name="__codelineno-11-31"></a>                    <span class="k">if</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">"pii"</span><span class="p">:</span>
<a href="#__codelineno-11-32" id="__codelineno-11-32" name="__codelineno-11-32"></a>                        <span class="c1"># Redact PII but keep response</span>
<a href="#__codelineno-11-33" id="__codelineno-11-33" name="__codelineno-11-33"></a>                        <span class="n">filtered_response</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">"[REDACTED]"</span><span class="p">,</span> <span class="n">filtered_response</span><span class="p">)</span>
<a href="#__codelineno-11-34" id="__codelineno-11-34" name="__codelineno-11-34"></a>                    <span class="k">elif</span> <span class="n">category</span> <span class="o">==</span> <span class="s2">"harmful"</span><span class="p">:</span>
<a href="#__codelineno-11-35" id="__codelineno-11-35" name="__codelineno-11-35"></a>                        <span class="c1"># Replace entire response for harmful content</span>
<a href="#__codelineno-11-36" id="__codelineno-11-36" name="__codelineno-11-36"></a>                        <span class="k">return</span> <span class="n">Config</span><span class="o">.</span><span class="n">HARMFUL_CONTENT_RESPONSE</span>
<a href="#__codelineno-11-37" id="__codelineno-11-37" name="__codelineno-11-37"></a>
<a href="#__codelineno-11-38" id="__codelineno-11-38" name="__codelineno-11-38"></a>        <span class="k">return</span> <span class="n">filtered_response</span>
</code></pre></div> <h2 id="infrastructure-security">Infrastructure Security<a class="headerlink" href="#infrastructure-security" title="Permanent link">¶</a></h2> <h3 id="network-security-configuration">Network Security Configuration<a class="headerlink" href="#network-security-configuration" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1"># docker-compose network configuration</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nt">services</span><span class="p">:</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">  </span><span class="nt">app</span><span class="p">:</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">frontend</span>
<a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a>
<a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">  </span><span class="nt">redis</span><span class="p">:</span>
<a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">    </span><span class="c1"># Not exposed to outside world</span>
<a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a>
<a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">  </span><span class="nt">ollama</span><span class="p">:</span>
<a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<a href="#__codelineno-12-15" id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">backend</span>
<a href="#__codelineno-12-16" id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">    </span><span class="c1"># Not exposed to outside world</span>
<a href="#__codelineno-12-17" id="__codelineno-12-17" name="__codelineno-12-17"></a>
<a href="#__codelineno-12-18" id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="nt">networks</span><span class="p">:</span>
<a href="#__codelineno-12-19" id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">  </span><span class="nt">frontend</span><span class="p">:</span>
<a href="#__codelineno-12-20" id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="c1"># External-facing network</span>
<a href="#__codelineno-12-21" id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">  </span><span class="nt">backend</span><span class="p">:</span>
<a href="#__codelineno-12-22" id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="nt">internal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Not exposed externally</span>
</code></pre></div> <h3 id="container-security">Container Security<a class="headerlink" href="#container-security" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c"># Dockerfile with security best practices</span>
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>
<a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c"># Use non-root user</span>
<a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="k">RUN</span><span class="w"> </span>groupadd<span class="w"> </span>-r<span class="w"> </span>opossum<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>useradd<span class="w"> </span>-r<span class="w"> </span>-g<span class="w"> </span>opossum<span class="w"> </span>opossum
<a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a>
<a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="c"># Install dependencies</span>
<a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>.
<a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt
<a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a>
<a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.11-slim</span>
<a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a>
<a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="c"># Copy only necessary files</span>
<a href="#__codelineno-13-14" id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/usr/local/lib/python3.11/site-packages<span class="w"> </span>/usr/local/lib/python3.11/site-packages
<a href="#__codelineno-13-15" id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="k">COPY</span><span class="w"> </span>app/<span class="w"> </span>/app/
<a href="#__codelineno-13-16" id="__codelineno-13-16" name="__codelineno-13-16"></a>
<a href="#__codelineno-13-17" id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="c"># Set working directory</span>
<a href="#__codelineno-13-18" id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<a href="#__codelineno-13-19" id="__codelineno-13-19" name="__codelineno-13-19"></a>
<a href="#__codelineno-13-20" id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="c"># Use non-root user</span>
<a href="#__codelineno-13-21" id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="k">USER</span><span class="w"> </span><span class="s">opossum</span>
<a href="#__codelineno-13-22" id="__codelineno-13-22" name="__codelineno-13-22"></a>
<a href="#__codelineno-13-23" id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="c"># Set secure env defaults</span>
<a href="#__codelineno-13-24" id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-13-25" id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">    </span><span class="nv">PYTHONDONTWRITEBYTECODE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-13-26" id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="w">    </span><span class="nv">PIP_DISABLE_PIP_VERSION_CHECK</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-13-27" id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="w">    </span><span class="nv">PIP_NO_CACHE_DIR</span><span class="o">=</span><span class="m">1</span>
<a href="#__codelineno-13-28" id="__codelineno-13-28" name="__codelineno-13-28"></a>
<a href="#__codelineno-13-29" id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="c"># Use unbuffered output, but don't write bytecode</span>
<a href="#__codelineno-13-30" id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="c"># Healthcheck to verify application is running properly</span>
<a href="#__codelineno-13-31" id="__codelineno-13-31" name="__codelineno-13-31"></a><span class="k">HEALTHCHECK</span><span class="w"> </span>--interval<span class="o">=</span>30s<span class="w"> </span>--timeout<span class="o">=</span>5s<span class="w"> </span>--start-period<span class="o">=</span>5s<span class="w"> </span>--retries<span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-13-32" id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="w">  </span>CMD<span class="w"> </span>curl<span class="w"> </span>-f<span class="w"> </span>http://localhost:8000/health<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a href="#__codelineno-13-33" id="__codelineno-13-33" name="__codelineno-13-33"></a>
<a href="#__codelineno-13-34" id="__codelineno-13-34" name="__codelineno-13-34"></a><span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">"python"</span><span class="p">,</span><span class="w"> </span><span class="s2">"main.py"</span><span class="p">]</span>
</code></pre></div> <h3 id="secret-management">Secret Management<a class="headerlink" href="#secret-management" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># Kubernetes secrets configuration</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="nt">metadata</span><span class="p">:</span>
<a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opossum-secrets</span>
<a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Opaque</span>
<a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="nt">data</span><span class="p">:</span>
<a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">  </span><span class="nt">gemini-api-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;base64-encoded-key&gt;</span>
<a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">  </span><span class="nt">redis-password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;base64-encoded-password&gt;</span>
<a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">  </span><span class="nt">encryption-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;base64-encoded-key&gt;</span>
</code></pre></div> <h2 id="monitoring-and-incident-response">Monitoring and Incident Response<a class="headerlink" href="#monitoring-and-incident-response" title="Permanent link">¶</a></h2> <h3 id="security-logging">Security Logging<a class="headerlink" href="#security-logging" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># app/monitoring/security_logging.py</span>
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">SecurityLogger</span><span class="p">:</span>
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">"security"</span><span class="p">)</span>
<a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a>        <span class="c1"># Configure structured logging</span>
<a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a>        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
<a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a>            <span class="s1">'{"timestamp": "</span><span class="si">%(asctime)s</span><span class="s1">", "level": "</span><span class="si">%(levelname)s</span><span class="s1">", '</span>
<a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a>            <span class="s1">'"event": "</span><span class="si">%(message)s</span><span class="s1">", "context": </span><span class="si">%(context)s</span><span class="s1">}'</span>
<a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a>        <span class="p">)</span>
<a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a>        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a>        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a>
<a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">log_security_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">severity</span><span class="o">=</span><span class="s2">"INFO"</span><span class="p">):</span>
<a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">        </span><span class="sd">"""Log security-related event"""</span>
<a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a>        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a>            <span class="s2">"event_type"</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
<a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a>            <span class="s2">"details"</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
<a href="#__codelineno-15-20" id="__codelineno-15-20" name="__codelineno-15-20"></a>            <span class="s2">"severity"</span><span class="p">:</span> <span class="n">severity</span>
<a href="#__codelineno-15-21" id="__codelineno-15-21" name="__codelineno-15-21"></a>        <span class="p">}</span>
<a href="#__codelineno-15-22" id="__codelineno-15-22" name="__codelineno-15-22"></a>
<a href="#__codelineno-15-23" id="__codelineno-15-23" name="__codelineno-15-23"></a>        <span class="c1"># Add to context</span>
<a href="#__codelineno-15-24" id="__codelineno-15-24" name="__codelineno-15-24"></a>        <span class="n">context_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-15-25" id="__codelineno-15-25" name="__codelineno-15-25"></a>
<a href="#__codelineno-15-26" id="__codelineno-15-26" name="__codelineno-15-26"></a>        <span class="c1"># Log event</span>
<a href="#__codelineno-15-27" id="__codelineno-15-27" name="__codelineno-15-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"security_</span><span class="si">{</span><span class="n">event_type</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">"context"</span><span class="p">:</span> <span class="n">context_json</span><span class="p">})</span>
<a href="#__codelineno-15-28" id="__codelineno-15-28" name="__codelineno-15-28"></a>
<a href="#__codelineno-15-29" id="__codelineno-15-29" name="__codelineno-15-29"></a>        <span class="c1"># For high-severity events, push to alerts</span>
<a href="#__codelineno-15-30" id="__codelineno-15-30" name="__codelineno-15-30"></a>        <span class="k">if</span> <span class="n">severity</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"CRITICAL"</span><span class="p">,</span> <span class="s2">"HIGH"</span><span class="p">]:</span>
<a href="#__codelineno-15-31" id="__codelineno-15-31" name="__codelineno-15-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_push_security_alert</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">severity</span><span class="p">)</span>
<a href="#__codelineno-15-32" id="__codelineno-15-32" name="__codelineno-15-32"></a>
<a href="#__codelineno-15-33" id="__codelineno-15-33" name="__codelineno-15-33"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_push_security_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span> <span class="n">severity</span><span class="p">):</span>
<a href="#__codelineno-15-34" id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="w">        </span><span class="sd">"""Push high-severity security alerts"""</span>
<a href="#__codelineno-15-35" id="__codelineno-15-35" name="__codelineno-15-35"></a>        <span class="n">alert</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-15-36" id="__codelineno-15-36" name="__codelineno-15-36"></a>            <span class="s2">"event_type"</span><span class="p">:</span> <span class="n">event_type</span><span class="p">,</span>
<a href="#__codelineno-15-37" id="__codelineno-15-37" name="__codelineno-15-37"></a>            <span class="s2">"details"</span><span class="p">:</span> <span class="n">details</span><span class="p">,</span>
<a href="#__codelineno-15-38" id="__codelineno-15-38" name="__codelineno-15-38"></a>            <span class="s2">"severity"</span><span class="p">:</span> <span class="n">severity</span><span class="p">,</span>
<a href="#__codelineno-15-39" id="__codelineno-15-39" name="__codelineno-15-39"></a>            <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a href="#__codelineno-15-40" id="__codelineno-15-40" name="__codelineno-15-40"></a>        <span class="p">}</span>
<a href="#__codelineno-15-41" id="__codelineno-15-41" name="__codelineno-15-41"></a>
<a href="#__codelineno-15-42" id="__codelineno-15-42" name="__codelineno-15-42"></a>        <span class="c1"># Push to Redis for alerting</span>
<a href="#__codelineno-15-43" id="__codelineno-15-43" name="__codelineno-15-43"></a>        <span class="n">redis_client</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span><span class="s2">"security:alerts"</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">alert</span><span class="p">))</span>
<a href="#__codelineno-15-44" id="__codelineno-15-44" name="__codelineno-15-44"></a>        <span class="n">redis_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="s2">"security:alerts:channel"</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">alert</span><span class="p">))</span>
</code></pre></div> <h3 id="intrusion-detection">Intrusion Detection<a class="headerlink" href="#intrusion-detection" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1"># app/security/intrusion_detection.py</span>
<a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">IntrusionDetection</span><span class="p">:</span>
<a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">):</span>
<a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
<a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">security_logger</span> <span class="o">=</span> <span class="n">SecurityLogger</span><span class="p">()</span>
<a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a>
<a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_request_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">):</span>
<a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">        </span><span class="sd">"""Check for suspicious request patterns"""</span>
<a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a>        <span class="c1"># Track requests per IP</span>
<a href="#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a>        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"security:requests:</span><span class="si">{</span><span class="n">client_ip</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<a href="#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>  <span class="c1"># Expire after 1 hour</span>
<a href="#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a>
<a href="#__codelineno-16-14" id="__codelineno-16-14" name="__codelineno-16-14"></a>        <span class="c1"># Get request count in last hour</span>
<a href="#__codelineno-16-15" id="__codelineno-16-15" name="__codelineno-16-15"></a>        <span class="n">request_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-16-16" id="__codelineno-16-16" name="__codelineno-16-16"></a>
<a href="#__codelineno-16-17" id="__codelineno-16-17" name="__codelineno-16-17"></a>        <span class="c1"># Check for rate-based attacks</span>
<a href="#__codelineno-16-18" id="__codelineno-16-18" name="__codelineno-16-18"></a>        <span class="k">if</span> <span class="n">request_count</span> <span class="o">&gt;</span> <span class="n">Config</span><span class="o">.</span><span class="n">SECURITY_REQUEST_THRESHOLD</span><span class="p">:</span>
<a href="#__codelineno-16-19" id="__codelineno-16-19" name="__codelineno-16-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">security_logger</span><span class="o">.</span><span class="n">log_security_event</span><span class="p">(</span>
<a href="#__codelineno-16-20" id="__codelineno-16-20" name="__codelineno-16-20"></a>                <span class="s2">"rate_limit_exceeded"</span><span class="p">,</span>
<a href="#__codelineno-16-21" id="__codelineno-16-21" name="__codelineno-16-21"></a>                <span class="p">{</span><span class="s2">"client_ip"</span><span class="p">:</span> <span class="n">client_ip</span><span class="p">,</span> <span class="s2">"request_count"</span><span class="p">:</span> <span class="n">request_count</span><span class="p">},</span>
<a href="#__codelineno-16-22" id="__codelineno-16-22" name="__codelineno-16-22"></a>                <span class="s2">"MEDIUM"</span>
<a href="#__codelineno-16-23" id="__codelineno-16-23" name="__codelineno-16-23"></a>            <span class="p">)</span>
<a href="#__codelineno-16-24" id="__codelineno-16-24" name="__codelineno-16-24"></a>
<a href="#__codelineno-16-25" id="__codelineno-16-25" name="__codelineno-16-25"></a>        <span class="c1"># Check for path traversal attempts</span>
<a href="#__codelineno-16-26" id="__codelineno-16-26" name="__codelineno-16-26"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span>
<a href="#__codelineno-16-27" id="__codelineno-16-27" name="__codelineno-16-27"></a>        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\.\./'</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'etc/passwd'</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<a href="#__codelineno-16-28" id="__codelineno-16-28" name="__codelineno-16-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">security_logger</span><span class="o">.</span><span class="n">log_security_event</span><span class="p">(</span>
<a href="#__codelineno-16-29" id="__codelineno-16-29" name="__codelineno-16-29"></a>                <span class="s2">"path_traversal_attempt"</span><span class="p">,</span>
<a href="#__codelineno-16-30" id="__codelineno-16-30" name="__codelineno-16-30"></a>                <span class="p">{</span><span class="s2">"client_ip"</span><span class="p">:</span> <span class="n">client_ip</span><span class="p">,</span> <span class="s2">"path"</span><span class="p">:</span> <span class="n">path</span><span class="p">},</span>
<a href="#__codelineno-16-31" id="__codelineno-16-31" name="__codelineno-16-31"></a>                <span class="s2">"HIGH"</span>
<a href="#__codelineno-16-32" id="__codelineno-16-32" name="__codelineno-16-32"></a>            <span class="p">)</span>
<a href="#__codelineno-16-33" id="__codelineno-16-33" name="__codelineno-16-33"></a>            <span class="k">return</span> <span class="kc">True</span>
<a href="#__codelineno-16-34" id="__codelineno-16-34" name="__codelineno-16-34"></a>
<a href="#__codelineno-16-35" id="__codelineno-16-35" name="__codelineno-16-35"></a>        <span class="c1"># Check for SQL injection attempts</span>
<a href="#__codelineno-16-36" id="__codelineno-16-36" name="__codelineno-16-36"></a>        <span class="n">query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"query"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
<a href="#__codelineno-16-37" id="__codelineno-16-37" name="__codelineno-16-37"></a>        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'UNION\s+SELECT|SELECT\s+FROM'</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
<a href="#__codelineno-16-38" id="__codelineno-16-38" name="__codelineno-16-38"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">security_logger</span><span class="o">.</span><span class="n">log_security_event</span><span class="p">(</span>
<a href="#__codelineno-16-39" id="__codelineno-16-39" name="__codelineno-16-39"></a>                <span class="s2">"sql_injection_attempt"</span><span class="p">,</span>
<a href="#__codelineno-16-40" id="__codelineno-16-40" name="__codelineno-16-40"></a>                <span class="p">{</span><span class="s2">"client_ip"</span><span class="p">:</span> <span class="n">client_ip</span><span class="p">,</span> <span class="s2">"query"</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span>
<a href="#__codelineno-16-41" id="__codelineno-16-41" name="__codelineno-16-41"></a>                <span class="s2">"HIGH"</span>
<a href="#__codelineno-16-42" id="__codelineno-16-42" name="__codelineno-16-42"></a>            <span class="p">)</span>
<a href="#__codelineno-16-43" id="__codelineno-16-43" name="__codelineno-16-43"></a>            <span class="k">return</span> <span class="kc">True</span>
<a href="#__codelineno-16-44" id="__codelineno-16-44" name="__codelineno-16-44"></a>
<a href="#__codelineno-16-45" id="__codelineno-16-45" name="__codelineno-16-45"></a>        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># No intrusion detected</span>
</code></pre></div> <h3 id="incident-response-plan">Incident Response Plan<a class="headerlink" href="#incident-response-plan" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># app/security/incident_response.py</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">IncidentResponse</span><span class="p">:</span>
<a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">security_logger</span> <span class="o">=</span> <span class="n">SecurityLogger</span><span class="p">()</span>
<a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_security_incident</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">incident_type</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
<a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">        </span><span class="sd">"""Handle security incident based on type and severity"""</span>
<a href="#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a>        <span class="c1"># Log the incident</span>
<a href="#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">security_logger</span><span class="o">.</span><span class="n">log_security_event</span><span class="p">(</span>
<a href="#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a>            <span class="n">incident_type</span><span class="p">,</span>
<a href="#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a>            <span class="n">details</span><span class="p">,</span>
<a href="#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a>            <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"severity"</span><span class="p">,</span> <span class="s2">"MEDIUM"</span><span class="p">)</span>
<a href="#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a>        <span class="p">)</span>
<a href="#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a>
<a href="#__codelineno-17-15" id="__codelineno-17-15" name="__codelineno-17-15"></a>        <span class="c1"># Take automated action based on incident type</span>
<a href="#__codelineno-17-16" id="__codelineno-17-16" name="__codelineno-17-16"></a>        <span class="k">if</span> <span class="n">incident_type</span> <span class="o">==</span> <span class="s2">"api_key_compromise"</span><span class="p">:</span>
<a href="#__codelineno-17-17" id="__codelineno-17-17" name="__codelineno-17-17"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_compromised_api_key</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
<a href="#__codelineno-17-18" id="__codelineno-17-18" name="__codelineno-17-18"></a>        <span class="k">elif</span> <span class="n">incident_type</span> <span class="o">==</span> <span class="s2">"rate_limit_abuse"</span><span class="p">:</span>
<a href="#__codelineno-17-19" id="__codelineno-17-19" name="__codelineno-17-19"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_rate_abuse</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
<a href="#__codelineno-17-20" id="__codelineno-17-20" name="__codelineno-17-20"></a>        <span class="k">elif</span> <span class="n">incident_type</span> <span class="o">==</span> <span class="s2">"injection_attempt"</span><span class="p">:</span>
<a href="#__codelineno-17-21" id="__codelineno-17-21" name="__codelineno-17-21"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_injection_attempt</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
<a href="#__codelineno-17-22" id="__codelineno-17-22" name="__codelineno-17-22"></a>
<a href="#__codelineno-17-23" id="__codelineno-17-23" name="__codelineno-17-23"></a>        <span class="c1"># Notify security team for high severity incidents</span>
<a href="#__codelineno-17-24" id="__codelineno-17-24" name="__codelineno-17-24"></a>        <span class="k">if</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"severity"</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"HIGH"</span><span class="p">,</span> <span class="s2">"CRITICAL"</span><span class="p">]:</span>
<a href="#__codelineno-17-25" id="__codelineno-17-25" name="__codelineno-17-25"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_notify_security_team</span><span class="p">(</span><span class="n">incident_type</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
<a href="#__codelineno-17-26" id="__codelineno-17-26" name="__codelineno-17-26"></a>
<a href="#__codelineno-17-27" id="__codelineno-17-27" name="__codelineno-17-27"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_handle_compromised_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
<a href="#__codelineno-17-28" id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="w">        </span><span class="sd">"""Handle potentially compromised API key"""</span>
<a href="#__codelineno-17-29" id="__codelineno-17-29" name="__codelineno-17-29"></a>        <span class="c1"># Disable the API key</span>
<a href="#__codelineno-17-30" id="__codelineno-17-30" name="__codelineno-17-30"></a>        <span class="n">api_key</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"api_key"</span><span class="p">)</span>
<a href="#__codelineno-17-31" id="__codelineno-17-31" name="__codelineno-17-31"></a>        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
<a href="#__codelineno-17-32" id="__codelineno-17-32" name="__codelineno-17-32"></a>            <span class="c1"># Mark as compromised</span>
<a href="#__codelineno-17-33" id="__codelineno-17-33" name="__codelineno-17-33"></a>            <span class="k">await</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">"security:compromised_key:</span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-17-34" id="__codelineno-17-34" name="__codelineno-17-34"></a>            <span class="c1"># Set short expiry for any active sessions</span>
<a href="#__codelineno-17-35" id="__codelineno-17-35" name="__codelineno-17-35"></a>            <span class="k">await</span> <span class="n">redis_client</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="sa">f</span><span class="s2">"session:key:</span><span class="si">{</span><span class="n">api_key</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
</code></pre></div> <h2 id="compliance-framework">Compliance Framework<a class="headerlink" href="#compliance-framework" title="Permanent link">¶</a></h2> <h3 id="compliance-controls">Compliance Controls<a class="headerlink" href="#compliance-controls" title="Permanent link">¶</a></h3> <table> <thead> <tr> <th>Requirement</th> <th>Implementation</th> <th>Verification</th> </tr> </thead> <tbody> <tr> <td><strong>Data Encryption</strong></td> <td>All sensitive data encrypted at rest and in transit</td> <td>Regular security audits</td> </tr> <tr> <td><strong>Access Control</strong></td> <td>Role-based access with least privilege</td> <td>Permission reviews</td> </tr> <tr> <td><strong>Audit Logging</strong></td> <td>Comprehensive logging of security events</td> <td>Log monitoring</td> </tr> <tr> <td><strong>Data Protection</strong></td> <td>Data retention policies, minimization</td> <td>Periodic data reviews</td> </tr> <tr> <td><strong>Vulnerability Management</strong></td> <td>Regular dependency updates, scanning</td> <td>CI/CD pipeline checks</td> </tr> </tbody> </table> <h3 id="privacy-by-design">Privacy by Design<a class="headerlink" href="#privacy-by-design" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1"># app/privacy/data_minimization.py</span>
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DataMinimization</span><span class="p">:</span>
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a>    <span class="nd">@staticmethod</span>
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">minimize_query_logs</span><span class="p">(</span><span class="n">query_data</span><span class="p">):</span>
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">        </span><span class="sd">"""Minimize data stored in query logs"""</span>
<a href="#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a>        <span class="c1"># Only store necessary fields</span>
<a href="#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a>        <span class="n">minimized</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-18-8" id="__codelineno-18-8" name="__codelineno-18-8"></a>            <span class="s2">"query_type"</span><span class="p">:</span> <span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"query_type"</span><span class="p">),</span>
<a href="#__codelineno-18-9" id="__codelineno-18-9" name="__codelineno-18-9"></a>            <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"timestamp"</span><span class="p">),</span>
<a href="#__codelineno-18-10" id="__codelineno-18-10" name="__codelineno-18-10"></a>            <span class="s2">"backend_used"</span><span class="p">:</span> <span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"backend_used"</span><span class="p">),</span>
<a href="#__codelineno-18-11" id="__codelineno-18-11" name="__codelineno-18-11"></a>            <span class="s2">"response_time"</span><span class="p">:</span> <span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"response_time"</span><span class="p">)</span>
<a href="#__codelineno-18-12" id="__codelineno-18-12" name="__codelineno-18-12"></a>        <span class="p">}</span>
<a href="#__codelineno-18-13" id="__codelineno-18-13" name="__codelineno-18-13"></a>
<a href="#__codelineno-18-14" id="__codelineno-18-14" name="__codelineno-18-14"></a>        <span class="c1"># Generate non-identifying hash of original query</span>
<a href="#__codelineno-18-15" id="__codelineno-18-15" name="__codelineno-18-15"></a>        <span class="n">query_text</span> <span class="o">=</span> <span class="n">query_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"query_text"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span>
<a href="#__codelineno-18-16" id="__codelineno-18-16" name="__codelineno-18-16"></a>        <span class="k">if</span> <span class="n">query_text</span><span class="p">:</span>
<a href="#__codelineno-18-17" id="__codelineno-18-17" name="__codelineno-18-17"></a>            <span class="n">minimized</span><span class="p">[</span><span class="s2">"query_hash"</span><span class="p">]</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">query_text</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<a href="#__codelineno-18-18" id="__codelineno-18-18" name="__codelineno-18-18"></a>
<a href="#__codelineno-18-19" id="__codelineno-18-19" name="__codelineno-18-19"></a>        <span class="c1"># Don't store PII</span>
<a href="#__codelineno-18-20" id="__codelineno-18-20" name="__codelineno-18-20"></a>        <span class="k">if</span> <span class="s2">"user_id"</span> <span class="ow">in</span> <span class="n">query_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Config</span><span class="o">.</span><span class="n">STORE_USER_ASSOCIATION</span><span class="p">:</span>
<a href="#__codelineno-18-21" id="__codelineno-18-21" name="__codelineno-18-21"></a>            <span class="n">minimized</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">]</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span>
<a href="#__codelineno-18-22" id="__codelineno-18-22" name="__codelineno-18-22"></a>                <span class="n">query_data</span><span class="p">[</span><span class="s2">"user_id"</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a href="#__codelineno-18-23" id="__codelineno-18-23" name="__codelineno-18-23"></a>            <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<a href="#__codelineno-18-24" id="__codelineno-18-24" name="__codelineno-18-24"></a>
<a href="#__codelineno-18-25" id="__codelineno-18-25" name="__codelineno-18-25"></a>        <span class="k">return</span> <span class="n">minimized</span>
</code></pre></div> <h3 id="data-subject-rights">Data Subject Rights<a class="headerlink" href="#data-subject-rights" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1"># app/privacy/dsr.py</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">DataSubjectRights</span><span class="p">:</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redis_client</span><span class="p">):</span>
<a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">redis</span> <span class="o">=</span> <span class="n">redis_client</span>
<a href="#__codelineno-19-5" id="__codelineno-19-5" name="__codelineno-19-5"></a>
<a href="#__codelineno-19-6" id="__codelineno-19-6" name="__codelineno-19-6"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a href="#__codelineno-19-7" id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">        </span><span class="sd">"""Get all data associated with a user"""</span>
<a href="#__codelineno-19-8" id="__codelineno-19-8" name="__codelineno-19-8"></a>        <span class="c1"># Collect all data related to user</span>
<a href="#__codelineno-19-9" id="__codelineno-19-9" name="__codelineno-19-9"></a>        <span class="n">user_data</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-19-10" id="__codelineno-19-10" name="__codelineno-19-10"></a>
<a href="#__codelineno-19-11" id="__codelineno-19-11" name="__codelineno-19-11"></a>        <span class="c1"># Get user profile</span>
<a href="#__codelineno-19-12" id="__codelineno-19-12" name="__codelineno-19-12"></a>        <span class="n">profile</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="sa">f</span><span class="s2">"user:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:profile"</span><span class="p">)</span>
<a href="#__codelineno-19-13" id="__codelineno-19-13" name="__codelineno-19-13"></a>        <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
<a href="#__codelineno-19-14" id="__codelineno-19-14" name="__codelineno-19-14"></a>            <span class="n">user_data</span><span class="p">[</span><span class="s2">"profile"</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>
<a href="#__codelineno-19-15" id="__codelineno-19-15" name="__codelineno-19-15"></a>
<a href="#__codelineno-19-16" id="__codelineno-19-16" name="__codelineno-19-16"></a>        <span class="c1"># Get user search history</span>
<a href="#__codelineno-19-17" id="__codelineno-19-17" name="__codelineno-19-17"></a>        <span class="n">searches</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">zrange</span><span class="p">(</span>
<a href="#__codelineno-19-18" id="__codelineno-19-18" name="__codelineno-19-18"></a>            <span class="sa">f</span><span class="s2">"user:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:searches"</span><span class="p">,</span> 
<a href="#__codelineno-19-19" id="__codelineno-19-19" name="__codelineno-19-19"></a>            <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
<a href="#__codelineno-19-20" id="__codelineno-19-20" name="__codelineno-19-20"></a>            <span class="n">withscores</span><span class="o">=</span><span class="kc">True</span>
<a href="#__codelineno-19-21" id="__codelineno-19-21" name="__codelineno-19-21"></a>        <span class="p">)</span>
<a href="#__codelineno-19-22" id="__codelineno-19-22" name="__codelineno-19-22"></a>        <span class="k">if</span> <span class="n">searches</span><span class="p">:</span>
<a href="#__codelineno-19-23" id="__codelineno-19-23" name="__codelineno-19-23"></a>            <span class="n">user_data</span><span class="p">[</span><span class="s2">"searches"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
<a href="#__codelineno-19-24" id="__codelineno-19-24" name="__codelineno-19-24"></a>                <span class="p">{</span><span class="s2">"query"</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
<a href="#__codelineno-19-25" id="__codelineno-19-25" name="__codelineno-19-25"></a>                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">searches</span>
<a href="#__codelineno-19-26" id="__codelineno-19-26" name="__codelineno-19-26"></a>            <span class="p">]</span>
<a href="#__codelineno-19-27" id="__codelineno-19-27" name="__codelineno-19-27"></a>
<a href="#__codelineno-19-28" id="__codelineno-19-28" name="__codelineno-19-28"></a>        <span class="k">return</span> <span class="n">user_data</span>
<a href="#__codelineno-19-29" id="__codelineno-19-29" name="__codelineno-19-29"></a>
<a href="#__codelineno-19-30" id="__codelineno-19-30" name="__codelineno-19-30"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_user_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a href="#__codelineno-19-31" id="__codelineno-19-31" name="__codelineno-19-31"></a><span class="w">        </span><span class="sd">"""Delete all data for a user (right to be forgotten)"""</span>
<a href="#__codelineno-19-32" id="__codelineno-19-32" name="__codelineno-19-32"></a>        <span class="c1"># Collect keys related to user</span>
<a href="#__codelineno-19-33" id="__codelineno-19-33" name="__codelineno-19-33"></a>        <span class="n">user_keys</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="sa">f</span><span class="s2">"user:</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:*"</span><span class="p">)</span>
<a href="#__codelineno-19-34" id="__codelineno-19-34" name="__codelineno-19-34"></a>
<a href="#__codelineno-19-35" id="__codelineno-19-35" name="__codelineno-19-35"></a>        <span class="c1"># Delete all keys</span>
<a href="#__codelineno-19-36" id="__codelineno-19-36" name="__codelineno-19-36"></a>        <span class="k">if</span> <span class="n">user_keys</span><span class="p">:</span>
<a href="#__codelineno-19-37" id="__codelineno-19-37" name="__codelineno-19-37"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">user_keys</span><span class="p">)</span>
<a href="#__codelineno-19-38" id="__codelineno-19-38" name="__codelineno-19-38"></a>
<a href="#__codelineno-19-39" id="__codelineno-19-39" name="__codelineno-19-39"></a>        <span class="c1"># Log deletion for compliance</span>
<a href="#__codelineno-19-40" id="__codelineno-19-40" name="__codelineno-19-40"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">lpush</span><span class="p">(</span>
<a href="#__codelineno-19-41" id="__codelineno-19-41" name="__codelineno-19-41"></a>            <span class="s2">"privacy:deletion_log"</span><span class="p">,</span>
<a href="#__codelineno-19-42" id="__codelineno-19-42" name="__codelineno-19-42"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
<a href="#__codelineno-19-43" id="__codelineno-19-43" name="__codelineno-19-43"></a>                <span class="s2">"user_id_hash"</span><span class="p">:</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">user_id</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span>
<a href="#__codelineno-19-44" id="__codelineno-19-44" name="__codelineno-19-44"></a>                <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a href="#__codelineno-19-45" id="__codelineno-19-45" name="__codelineno-19-45"></a>                <span class="s2">"keys_deleted"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_keys</span><span class="p">)</span>
<a href="#__codelineno-19-46" id="__codelineno-19-46" name="__codelineno-19-46"></a>            <span class="p">})</span>
<a href="#__codelineno-19-47" id="__codelineno-19-47" name="__codelineno-19-47"></a>        <span class="p">)</span>
<a href="#__codelineno-19-48" id="__codelineno-19-48" name="__codelineno-19-48"></a>
<a href="#__codelineno-19-49" id="__codelineno-19-49" name="__codelineno-19-49"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">"deleted"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"key_count"</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_keys</span><span class="p">)}</span>
</code></pre></div> <p>The Opossum Search security model provides comprehensive protection across all layers of the application, from user authentication through data processing to infrastructure security. By implementing these security controls, the system maintains confidentiality, integrity, and availability while meeting regulatory compliance requirements.</p> </div> </div><footer> <div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation"> <a class="btn btn-neutral float-left" href="../graphql-api/" title="GraphQL API"><span class="icon icon-circle-arrow-left"></span> Previous</a> <a class="btn btn-neutral float-right" href="../prompt-management/" title="Prompt Management">Next <span class="icon icon-circle-arrow-right"></span></a> </div> <hr/> <div role="contentinfo"> <!-- Copyright etc --> </div> Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. </footer> </div> </div> </section> </div> <div aria-label="Versions" class="rst-versions" role="note"> <span class="rst-current-version" data-toggle="rst-current-version"> <span><a href="../graphql-api/" style="color: #fcfcfc">« Previous</a></span> <span><a href="../prompt-management/" style="color: #fcfcfc">Next »</a></span> </span> </div> <script src="../../js/jquery-3.6.0.min.js"></script> <script>var base_url = "../..";</script> <script src="../../js/theme_extra.js"></script> <script src="../../js/theme.js"></script> <script src="../../search/main.js"></script> <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script> </body> </html> 