<!DOCTYPE html><html class=writer-html5 lang=en> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=author content=bebo><link rel="shortcut icon" href=../../img/favicon.ico><title>OpenTelemetry - Opossum Search Documentation</title><link rel=stylesheet href=../../css/theme.css><link rel=stylesheet href=../../css/theme_extra.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css><link href=../../assets/_mkdocstrings.css rel=stylesheet><link href=../../stylesheets/extra.css rel=stylesheet><script>
        // Current page data
        var mkdocs_page_name = "OpenTelemetry";
        var mkdocs_page_input_path = "technical\\opentelemetry-integration.md";
        var mkdocs_page_url = null;
      </script><!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.highlightAll();</script></head> <body class=wy-body-for-nav role=document> <div class=wy-grid-for-nav> <nav data-toggle=wy-nav-shift class="wy-nav-side stickynav"> <div class=wy-side-scroll> <div class=wy-side-nav-search> <a href=../.. class="icon icon-home"> Opossum Search Documentation </a><div role=search> <form id=rtd-search-form class=wy-form action=../../search.html method=get> <input type=text name=q placeholder="Search docs" aria-label="Search docs" title="Type search term here"> </form> </div> </div> <div class="wy-menu wy-menu-vertical" data-spy=affix role=navigation aria-label="Navigation menu"> <ul> <li class=toctree-l1><a class="reference internal" href=../..>Home</a> </li> </ul> <p class=caption><span class=caption-text>Getting Started</span></p> <ul> <li class=toctree-l1><a href=../getting-started/ class="reference internal">First Steps</a> </li> <li class=toctree-l1><a href=../system-architecture-overview/ class="reference internal">System Overview</a> </li> <li class=toctree-l1><a href=../../api/getting-started/ class="reference internal">API Reference</a> </li> <li class=toctree-l1><a href=../devops-guide/ class="reference internal">Developer Quickstart</a> </li> </ul> <p class=caption><span class=caption-text>Core Components</span></p> <ul> <li class=toctree-l1><a class="reference internal">Architecture</a> <ul> <li class=toctree-l2><a href=../system-architecture-overview/ class="reference internal">System Overview</a> </li> <li class=toctree-l2><a href=../graphql-api/ class="reference internal">GraphQL API</a> </li> <li class=toctree-l2><a href=../security-model/ class="reference internal">Security Model</a> </li> <li class=toctree-l2><a href=../prompt-management/ class="reference internal">Prompt Management</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Model Integration</a> <ul> <li class=toctree-l2><a href=../../model-integration/architecture/ class="reference internal">Architecture</a> </li> <li class=toctree-l2><a href=../../model-integration/backend-selection/ class="reference internal">Backend Selection</a> </li> <li class=toctree-l2><a href=../../model-integration/capability-matrix/ class="reference internal">Capability Matrix</a> </li> <li class=toctree-l2><a href=../../model-integration/providers/ class="reference internal">Provider Integration</a> </li> <li class=toctree-l2><a href=../../model-integration/configuration/ class="reference internal">Configuration</a> </li> <li class=toctree-l2><a href=../hybrid-model-selection/ class="reference internal">Hybrid Selection</a> </li> <li class=toctree-l2><a href=../prompt-management/ class="reference internal">Prompt Management</a> </li> <li class=toctree-l2><a href=../../model-integration/dspy-integration/ class="reference internal">DSPy Integration</a> </li> <li class=toctree-l2><a href=../../model-integration/dspy-technical/ class="reference internal">DSPy Technical Implementation</a> </li> <li class=toctree-l2><a href=../../model-integration/dspy-examples/ class="reference internal">DSPy Usage Examples</a> </li> <li class=toctree-l2><a href=../../model-integration/dspy-metrics/ class="reference internal">DSPy Metrics & Performance</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Service Availability</a> <ul> <li class=toctree-l2><a href=../../service-availability/context-and-scope/ class="reference internal">Context and Scope</a> </li> <li class=toctree-l2><a href=../../service-availability/quality-requirements/ class="reference internal">Quality Requirements</a> </li> <li class=toctree-l2><a href=../../service-availability/architecture-constraints/ class="reference internal">Architecture Constraints</a> </li> <li class=toctree-l2><a href=../../service-availability/availability-monitoring/ class="reference internal">Availability Monitoring</a> </li> <li class=toctree-l2><a href=../../service-availability/service-outage/ class="reference internal">Error Handling</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Resilience Patterns</a> <ul> <li class=toctree-l2><a href=../resilience-patterns/ class="reference internal">Core Strategies</a> </li> <li class=toctree-l2><a href=../error-handling-resilience/ class="reference internal">Error Handling</a> </li> <li class=toctree-l2><a href=../../service-availability/rate-limiting-throttling/ class="reference internal">Rate Limiting</a> </li> <li class=toctree-l2><a href=../../service-availability/log-alerts/ class="reference internal">Logging and Alerts</a> </li> <li class=toctree-l2><a href=../../service-availability/testing-validation/ class="reference internal">Testing and Validation</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>Features</span></p> <ul> <li class=toctree-l1><a class="reference internal">Conversation</a> <ul> <li class=toctree-l2><a href=../../conversation/topic-detection/ class="reference internal">Topic Detection</a> </li> <li class=toctree-l2><a href=../../conversation/conversation-flow/ class="reference internal">Conversation Flow</a> </li> <li class=toctree-l2><a href=../../conversation/response-generation/ class="reference internal">Response Generation</a> </li> <li class=toctree-l2><a href=../../conversation/nlp-components/ class="reference internal">NLP Components</a> </li> <li class=toctree-l2><a href=../../conversation/markov-generation/ class="reference internal">Markov Generation</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Image Processing</a> <ul> <li class=toctree-l2><a href=../../image-processing/overview/ class="reference internal">Overview</a> </li> <li class=toctree-l2><a href=../../image-processing/effects/ class="reference internal">Effects and Filters</a> </li> <li class=toctree-l2><a href=../../image-processing/svg-generation/ class="reference internal">SVG Generation</a> </li> <li class=toctree-l2><a href=../../image-processing/optimization/ class="reference internal">Performance Optimization</a> </li> <li class=toctree-l2><a href=../../image-processing/caching/ class="reference internal">Caching Strategy</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Visualizations & Fun</a> <ul> <li class=toctree-l2><a href=../../features/service-vizualizations/ class="reference internal">Service Visualizations</a> </li> <li class=toctree-l2><a href=../../features/national-day/ class="reference internal">National Opossum Day</a> </li> <li class=toctree-l2><a href=../../features/easter-eggs/ class="reference internal">Easter Eggs</a> </li> <li class=toctree-l2><a href=../../features/special-events/ class="reference internal">Special Events</a> </li> <li class=toctree-l2><a href=../../features/background-stories/ class="reference internal">Background Stories</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>Technical Reference</span></p> <ul class=current> <li class="toctree-l1 current"><a class="reference internal current">Infrastructure</a> <ul class=current> <li class=toctree-l2><a href=../redis-caching-architecture/ class="reference internal">Redis Caching</a> </li> <li class=toctree-l2><a href=../image-processing-pipeline/ class="reference internal">Image Pipeline</a> </li> <li class="toctree-l2 current"><a class="reference internal current" href=#>OpenTelemetry</a> <ul class=current> <li class=toctree-l3><a class="reference internal" href=#1-overview>1. Overview</a> </li> <li class=toctree-l3><a class="reference internal" href=#2-opentelemetry-configuration>2. OpenTelemetry Configuration</a> <ul> <li class=toctree-l4><a class="reference internal" href=#21-initialization>2.1 Initialization</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#3-tracing-request-flow>3. Tracing Request Flow</a> <ul> <li class=toctree-l4><a class="reference internal" href=#31-graphql-request-tracing>3.1 GraphQL Request Tracing</a> </li> <li class=toctree-l4><a class="reference internal" href=#32-model-backend-tracing>3.2 Model Backend Tracing</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#4-custom-metrics-and-events>4. Custom Metrics and Events</a> <ul> <li class=toctree-l4><a class="reference internal" href=#41-service-availability-monitoring>4.1 Service Availability Monitoring</a> </li> <li class=toctree-l4><a class="reference internal" href=#42-cache-hitmiss-monitoring>4.2 Cache Hit/Miss Monitoring</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#5-custom-context-propagation>5. Custom Context Propagation</a> </li> <li class=toctree-l3><a class="reference internal" href=#6-external-service-integration>6. External Service Integration</a> <ul> <li class=toctree-l4><a class="reference internal" href=#61-ollama-api-tracing>6.1 Ollama API Tracing</a> </li> <li class=toctree-l4><a class="reference internal" href=#62-gemini-api-tracing>6.2 Gemini API Tracing</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#7-visualization-and-monitoring>7. Visualization and Monitoring</a> </li> <li class=toctree-l3><a class="reference internal" href=#8-deployment-configuration>8. Deployment Configuration</a> <ul> <li class=toctree-l4><a class="reference internal" href=#81-collector-configuration>8.1 Collector Configuration</a> </li> </ul> </li> </ul> </li> <li class=toctree-l2><a href=../svg-markup/ class="reference internal">SVG Markup</a> </li> <li class=toctree-l2><a href=../bot-user-simulation/ class="reference internal">Bot User Simulation</a> </li> <li class=toctree-l2><a href=../../infrastructure/optimization-strategies/ class="reference internal">Optimization Strategies</a> </li> <li class=toctree-l2><a href=../../infrastructure/pipeline-optimization/ class="reference internal">Pipeline Optimization</a> </li> <li class=toctree-l2><a href=../../infrastructure/constraint-mapping/ class="reference internal">Constraint Mapping</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">API Documentation</a> <ul> <li class=toctree-l2><a href=../../api/routes/ class="reference internal">Routes</a> </li> <li class=toctree-l2><a href=../../api/request-response/ class="reference internal">Request/Response</a> </li> <li class=toctree-l2><a href=../../api/oauth-configuration/ class="reference internal">OAuth Configuration</a> </li> <li class=toctree-l2><a href=../../api/error-codes/ class="reference internal">Error Codes</a> </li> <li class=toctree-l2><a href=../../api/rate-limits/ class="reference internal">Rate Limits</a> </li> <li class=toctree-l2><a href=../../api/webhooks/ class="reference internal">Webhook Integration</a> </li> <li class=toctree-l2><a href=../../api/health-endpoints/ class="reference internal">Health Endpoints</a> </li> <li class=toctree-l2><a href=../../api/compliance/ class="reference internal">Compliance</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">DSPy Tutorials</a> <ul> <li class=toctree-l2><a href=../../tutorials/dspy/getting-started/ class="reference internal">Getting Started with DSPy</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/optimizing-prompts/ class="reference internal">Optimizing Prompts</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/building-pipelines/ class="reference internal">Building Pipelines</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/advanced-reasoning/ class="reference internal">Advanced Reasoning</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>About</span></p> <ul> <li class=toctree-l1><a href=../../about/history/ class="reference internal">Project History</a> </li> <li class=toctree-l1><a href=../../about/team/ class="reference internal">Team</a> </li> <li class=toctree-l1><a href=../../about/roadmap/ class="reference internal">Roadmap</a> </li> </ul> </div> </div> </nav> <section data-toggle=wy-nav-shift class=wy-nav-content-wrap> <nav class=wy-nav-top role=navigation aria-label="Mobile navigation menu"> <i data-toggle=wy-nav-top class="fa fa-bars"></i> <a href=../..>Opossum Search Documentation</a> </nav> <div class=wy-nav-content> <div class=rst-content><div role=navigation aria-label="breadcrumbs navigation"> <ul class=wy-breadcrumbs> <li><a href=../.. class="icon icon-home" aria-label=Docs></a></li> <li class=breadcrumb-item>Technical Reference</li> <li class=breadcrumb-item>Infrastructure</li> <li class="breadcrumb-item active">OpenTelemetry</li> <li class=wy-breadcrumbs-aside> </li> </ul> <hr> </div> <div role=main class=document itemscope=itemscope itemtype=http://schema.org/Article> <div class=section itemprop=articleBody> <h1 id=technical-documentation-opentelemetry-integration>Technical Documentation: OpenTelemetry Integration<a class=headerlink href=#technical-documentation-opentelemetry-integration title="Permanent link">&para;</a></h1> <h2 id=1-overview>1. Overview<a class=headerlink href=#1-overview title="Permanent link">&para;</a></h2> <p>Opossum Search implements comprehensive observability using OpenTelemetry to monitor application performance, track request flows, and diagnose issues across its distributed architecture. This integration enables detailed visibility into system behavior, performance bottlenecks, and service dependencies.</p> <h2 id=2-opentelemetry-configuration>2. OpenTelemetry Configuration<a class=headerlink href=#2-opentelemetry-configuration title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># OpenTelemetry Configuration</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=n>OTEL_EXPORTER_OTLP_ENDPOINT</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&quot;OTEL_EXPORTER_OTLP_ENDPOINT&quot;</span><span class=p>,</span> <span class=s2>&quot;http://localhost:4318/v1/traces&quot;</span><span class=p>)</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=n>OTEL_SERVICE_NAME</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&quot;OTEL_SERVICE_NAME&quot;</span><span class=p>,</span> <span class=s2>&quot;opossum-search&quot;</span><span class=p>)</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=n>OTEL_ENABLED</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&quot;OTEL_ENABLED&quot;</span><span class=p>,</span> <span class=s2>&quot;True&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;true&quot;</span>
</code></pre></div> <h3 id=21-initialization>2.1 Initialization<a class=headerlink href=#21-initialization title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry</span><span class=w> </span><span class=kn>import</span> <span class=n>trace</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry.sdk.trace</span><span class=w> </span><span class=kn>import</span> <span class=n>TracerProvider</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry.sdk.trace.export</span><span class=w> </span><span class=kn>import</span> <span class=n>BatchSpanProcessor</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry.exporter.otlp.proto.http.trace_exporter</span><span class=w> </span><span class=kn>import</span> <span class=n>OTLPSpanExporter</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry.sdk.resources</span><span class=w> </span><span class=kn>import</span> <span class=n>Resource</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry.semconv.resource</span><span class=w> </span><span class=kn>import</span> <span class=n>ResourceAttributes</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=k>def</span><span class=w> </span><span class=nf>initialize_telemetry</span><span class=p>():</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Initialize OpenTelemetry for distributed tracing&quot;&quot;&quot;</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>Config</span><span class=o>.</span><span class=n>OTEL_ENABLED</span><span class=p>:</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        <span class=k>return</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>    <span class=c1># Create resource information</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>    <span class=n>resource</span> <span class=o>=</span> <span class=n>Resource</span><span class=o>.</span><span class=n>create</span><span class=p>({</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>        <span class=n>ResourceAttributes</span><span class=o>.</span><span class=n>SERVICE_NAME</span><span class=p>:</span> <span class=n>Config</span><span class=o>.</span><span class=n>OTEL_SERVICE_NAME</span><span class=p>,</span>
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>        <span class=n>ResourceAttributes</span><span class=o>.</span><span class=n>SERVICE_VERSION</span><span class=p>:</span> <span class=s2>&quot;1.0.0&quot;</span><span class=p>,</span>
<a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>        <span class=s2>&quot;environment&quot;</span><span class=p>:</span> <span class=n>Config</span><span class=o>.</span><span class=n>ENV</span>
<a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>    <span class=p>})</span>
<a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>
<a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>    <span class=c1># Set up tracer provider</span>
<a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>    <span class=n>provider</span> <span class=o>=</span> <span class=n>TracerProvider</span><span class=p>(</span><span class=n>resource</span><span class=o>=</span><span class=n>resource</span><span class=p>)</span>
<a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a>
<a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a>    <span class=c1># Create OTLP exporter</span>
<a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>    <span class=n>otlp_exporter</span> <span class=o>=</span> <span class=n>OTLPSpanExporter</span><span class=p>(</span><span class=n>endpoint</span><span class=o>=</span><span class=n>Config</span><span class=o>.</span><span class=n>OTEL_EXPORTER_OTLP_ENDPOINT</span><span class=p>)</span>
<a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>    <span class=n>span_processor</span> <span class=o>=</span> <span class=n>BatchSpanProcessor</span><span class=p>(</span><span class=n>otlp_exporter</span><span class=p>)</span>
<a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a>    <span class=n>provider</span><span class=o>.</span><span class=n>add_span_processor</span><span class=p>(</span><span class=n>span_processor</span><span class=p>)</span>
<a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a>
<a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a>    <span class=c1># Set global tracer provider</span>
<a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a>    <span class=n>trace</span><span class=o>.</span><span class=n>set_tracer_provider</span><span class=p>(</span><span class=n>provider</span><span class=p>)</span>
<a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a>
<a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a>    <span class=c1># Create global tracer</span>
<a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a>    <span class=k>return</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_tracer</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</code></pre></div> <h2 id=3-tracing-request-flow>3. Tracing Request Flow<a class=headerlink href=#3-tracing-request-flow title="Permanent link">&para;</a></h2> <h3 id=31-graphql-request-tracing>3.1 GraphQL Request Tracing<a class=headerlink href=#31-graphql-request-tracing title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry.instrumentation.fastapi</span><span class=w> </span><span class=kn>import</span> <span class=n>FastAPIInstrumentor</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=c1># Instrument FastAPI application</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=k>def</span><span class=w> </span><span class=nf>instrument_fastapi</span><span class=p>(</span><span class=n>app</span><span class=p>):</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Instrument FastAPI with OpenTelemetry&quot;&quot;&quot;</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>    <span class=k>if</span> <span class=n>Config</span><span class=o>.</span><span class=n>OTEL_ENABLED</span><span class=p>:</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>        <span class=n>FastAPIInstrumentor</span><span class=o>.</span><span class=n>instrument_app</span><span class=p>(</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>            <span class=n>app</span><span class=p>,</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>            <span class=n>excluded_urls</span><span class=o>=</span><span class=s2>&quot;/health,/metrics&quot;</span><span class=p>,</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>            <span class=n>tracer_provider</span><span class=o>=</span><span class=n>trace</span><span class=o>.</span><span class=n>get_tracer_provider</span><span class=p>()</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>        <span class=p>)</span>
</code></pre></div> <h3 id=32-model-backend-tracing>3.2 Model Backend Tracing<a class=headerlink href=#32-model-backend-tracing title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>generate_response</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prompt</span><span class=p>,</span> <span class=n>model_name</span><span class=p>):</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Generate response with OpenTelemetry tracing&quot;&quot;&quot;</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=n>tracer</span> <span class=o>=</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_tracer</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    <span class=k>with</span> <span class=n>tracer</span><span class=o>.</span><span class=n>start_as_current_span</span><span class=p>(</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>        <span class=s2>&quot;model.generate&quot;</span><span class=p>,</span> 
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>        <span class=n>attributes</span><span class=o>=</span><span class=p>{</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>            <span class=s2>&quot;prompt.length&quot;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>prompt</span><span class=p>),</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>            <span class=s2>&quot;model.name&quot;</span><span class=p>:</span> <span class=n>model_name</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>        <span class=p>}</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>    <span class=p>)</span> <span class=k>as</span> <span class=n>span</span><span class=p>:</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>        <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>            <span class=c1># Record start time</span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>            <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>            <span class=c1># Call model backend</span>
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>            <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_call_model_backend</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>model_name</span><span class=p>)</span>
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>            <span class=c1># Calculate and record duration</span>
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;duration_seconds&quot;</span><span class=p>,</span> <span class=n>duration</span><span class=p>)</span>
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;response.length&quot;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>response</span><span class=p>))</span>
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>
<a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>            <span class=k>return</span> <span class=n>response</span>
<a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>            <span class=c1># Record error information</span>
<a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>            <span class=n>span</span><span class=o>.</span><span class=n>record_exception</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
<a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_status</span><span class=p>(</span><span class=n>trace</span><span class=o>.</span><span class=n>StatusCode</span><span class=o>.</span><span class=n>ERROR</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>            <span class=k>raise</span>
</code></pre></div> <h2 id=4-custom-metrics-and-events>4. Custom Metrics and Events<a class=headerlink href=#4-custom-metrics-and-events title="Permanent link">&para;</a></h2> <h3 id=41-service-availability-monitoring>4.1 Service Availability Monitoring<a class=headerlink href=#41-service-availability-monitoring title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>check_service</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service_name</span><span class=p>):</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Check service availability with metrics recording&quot;&quot;&quot;</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    <span class=n>tracer</span> <span class=o>=</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_tracer</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>    <span class=k>with</span> <span class=n>tracer</span><span class=o>.</span><span class=n>start_as_current_span</span><span class=p>(</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>        <span class=s2>&quot;service.check&quot;</span><span class=p>,</span> 
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>        <span class=n>attributes</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;service.name&quot;</span><span class=p>:</span> <span class=n>service_name</span><span class=p>}</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=p>)</span> <span class=k>as</span> <span class=n>span</span><span class=p>:</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>        <span class=c1># Record check attempt</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>        <span class=n>span</span><span class=o>.</span><span class=n>add_event</span><span class=p>(</span><span class=s2>&quot;check_started&quot;</span><span class=p>)</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>        <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>            <span class=c1># Perform actual check</span>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>            <span class=n>is_available</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_perform_actual_check</span><span class=p>(</span><span class=n>service_name</span><span class=p>)</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>            <span class=c1># Record result</span>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;service.available&quot;</span><span class=p>,</span> <span class=n>is_available</span><span class=p>)</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>            <span class=n>span</span><span class=o>.</span><span class=n>add_event</span><span class=p>(</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>                <span class=s2>&quot;check_completed&quot;</span><span class=p>,</span> 
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>                <span class=p>{</span><span class=s2>&quot;result&quot;</span><span class=p>:</span> <span class=s2>&quot;available&quot;</span> <span class=k>if</span> <span class=n>is_available</span> <span class=k>else</span> <span class=s2>&quot;unavailable&quot;</span><span class=p>}</span>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a>            <span class=p>)</span>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a>            <span class=k>return</span> <span class=n>is_available</span>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a>            <span class=c1># Record error</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a>            <span class=n>span</span><span class=o>.</span><span class=n>record_exception</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_status</span><span class=p>(</span><span class=n>trace</span><span class=o>.</span><span class=n>StatusCode</span><span class=o>.</span><span class=n>ERROR</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a>            <span class=n>span</span><span class=o>.</span><span class=n>add_event</span><span class=p>(</span><span class=s2>&quot;check_failed&quot;</span><span class=p>,</span> <span class=p>{</span><span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)})</span>
<a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a>            <span class=k>return</span> <span class=kc>False</span>
</code></pre></div> <h3 id=42-cache-hitmiss-monitoring>4.2 Cache Hit/Miss Monitoring<a class=headerlink href=#42-cache-hitmiss-monitoring title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_cached_item</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Get cached item with telemetry&quot;&quot;&quot;</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>    <span class=n>tracer</span> <span class=o>=</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_tracer</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>    <span class=k>with</span> <span class=n>tracer</span><span class=o>.</span><span class=n>start_as_current_span</span><span class=p>(</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>        <span class=s2>&quot;cache.get&quot;</span><span class=p>,</span> 
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>        <span class=n>attributes</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;cache.key&quot;</span><span class=p>:</span> <span class=n>key</span><span class=p>}</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    <span class=p>)</span> <span class=k>as</span> <span class=n>span</span><span class=p>:</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>        <span class=c1># Try to get from cache</span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>        <span class=n>value</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>        <span class=c1># Record hit/miss</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>        <span class=n>hit</span> <span class=o>=</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>        <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;cache.hit&quot;</span><span class=p>,</span> <span class=n>hit</span><span class=p>)</span>
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>        <span class=c1># Record in aggregated metrics</span>
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>        <span class=k>if</span> <span class=n>hit</span><span class=p>:</span>
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span><span class=o>.</span><span class=n>incr</span><span class=p>(</span><span class=s2>&quot;metrics:cache:hits&quot;</span><span class=p>)</span>
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>        <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span><span class=o>.</span><span class=n>incr</span><span class=p>(</span><span class=s2>&quot;metrics:cache:misses&quot;</span><span class=p>)</span>
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>        <span class=k>return</span> <span class=n>value</span>
</code></pre></div> <h2 id=5-custom-context-propagation>5. Custom Context Propagation<a class=headerlink href=#5-custom-context-propagation title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry.context</span><span class=w> </span><span class=kn>import</span> <span class=n>Context</span><span class=p>,</span> <span class=n>get_current</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=kn>from</span><span class=w> </span><span class=nn>opentelemetry.trace.propagation.tracecontext</span><span class=w> </span><span class=kn>import</span> <span class=n>TraceContextTextMapPropagator</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=k>class</span><span class=w> </span><span class=nc>ContextCarrier</span><span class=p>:</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Carries context between async tasks&quot;&quot;&quot;</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>context</span> <span class=o>=</span> <span class=p>{}</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>    <span class=k>def</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>default</span><span class=p>)</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>    <span class=k>def</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>        <span class=bp>self</span><span class=o>.</span><span class=n>context</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=k>def</span><span class=w> </span><span class=nf>extract_context_for_background_task</span><span class=p>():</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Extract current context to pass to background task&quot;&quot;&quot;</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>    <span class=n>carrier</span> <span class=o>=</span> <span class=n>ContextCarrier</span><span class=p>()</span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>    <span class=n>propagator</span> <span class=o>=</span> <span class=n>TraceContextTextMapPropagator</span><span class=p>()</span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>    <span class=n>propagator</span><span class=o>.</span><span class=n>inject</span><span class=p>(</span><span class=n>carrier</span><span class=p>,</span> <span class=n>get_current</span><span class=p>())</span>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>    <span class=k>return</span> <span class=n>carrier</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>run_in_background</span><span class=p>(</span><span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=n>parent_context</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Run function in background with parent trace context&quot;&quot;&quot;</span>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>    <span class=k>if</span> <span class=n>parent_context</span> <span class=ow>and</span> <span class=n>Config</span><span class=o>.</span><span class=n>OTEL_ENABLED</span><span class=p>:</span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>        <span class=n>propagator</span> <span class=o>=</span> <span class=n>TraceContextTextMapPropagator</span><span class=p>()</span>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>        <span class=n>context</span> <span class=o>=</span> <span class=n>propagator</span><span class=o>.</span><span class=n>extract</span><span class=p>(</span><span class=n>parent_context</span><span class=p>)</span>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>        <span class=n>token</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>attach</span><span class=p>()</span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a>        <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a>        <span class=k>finally</span><span class=p>:</span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a>            <span class=n>context</span><span class=o>.</span><span class=n>detach</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a>        <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</code></pre></div> <h2 id=6-external-service-integration>6. External Service Integration<a class=headerlink href=#6-external-service-integration title="Permanent link">&para;</a></h2> <h3 id=61-ollama-api-tracing>6.1 Ollama API Tracing<a class=headerlink href=#61-ollama-api-tracing title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>generate_ollama_response</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prompt</span><span class=p>,</span> <span class=n>model</span><span class=p>):</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Trace Ollama API requests&quot;&quot;&quot;</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>    <span class=n>tracer</span> <span class=o>=</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_tracer</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    <span class=k>with</span> <span class=n>tracer</span><span class=o>.</span><span class=n>start_as_current_span</span><span class=p>(</span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>        <span class=s2>&quot;ollama.generate&quot;</span><span class=p>,</span> 
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>        <span class=n>attributes</span><span class=o>=</span><span class=p>{</span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>            <span class=s2>&quot;prompt.length&quot;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>prompt</span><span class=p>),</span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>            <span class=s2>&quot;model.name&quot;</span><span class=p>:</span> <span class=n>model</span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>        <span class=p>}</span>
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>    <span class=p>)</span> <span class=k>as</span> <span class=n>span</span><span class=p>:</span>
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>        <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>            <span class=c1># Create request</span>
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>            <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>Config</span><span class=o>.</span><span class=n>OLLAMA_BASE_URL</span><span class=si>}</span><span class=s2>/api/generate&quot;</span>
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>            <span class=n>payload</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a>                <span class=s2>&quot;prompt&quot;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>,</span>
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a>                <span class=s2>&quot;model&quot;</span><span class=p>:</span> <span class=n>model</span><span class=p>,</span>
<a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a>                <span class=s2>&quot;stream&quot;</span><span class=p>:</span> <span class=kc>False</span>
<a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a>            <span class=p>}</span>
<a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a>
<a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a>            <span class=c1># Add request details to span</span>
<a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;http.url&quot;</span><span class=p>,</span> <span class=n>url</span><span class=p>)</span>
<a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;http.method&quot;</span><span class=p>,</span> <span class=s2>&quot;POST&quot;</span><span class=p>)</span>
<a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a>
<a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>            <span class=c1># Send request</span>
<a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a>            <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a>            <span class=k>async</span> <span class=k>with</span> <span class=n>httpx</span><span class=o>.</span><span class=n>AsyncClient</span><span class=p>()</span> <span class=k>as</span> <span class=n>client</span><span class=p>:</span>
<a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a>                <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mf>60.0</span><span class=p>)</span>
<a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a>
<a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a>            <span class=c1># Add response details</span>
<a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;http.status_code&quot;</span><span class=p>,</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=p>)</span>
<a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;http.response_time&quot;</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>)</span>
<a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a>
<a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a>            <span class=c1># Handle response</span>
<a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a>            <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
<a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a>                <span class=n>data</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
<a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a>                <span class=k>return</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;response&quot;</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>)</span>
<a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a>            <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a>                <span class=n>error_msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Ollama API error: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a>                <span class=n>span</span><span class=o>.</span><span class=n>set_status</span><span class=p>(</span><span class=n>trace</span><span class=o>.</span><span class=n>StatusCode</span><span class=o>.</span><span class=n>ERROR</span><span class=p>,</span> <span class=n>error_msg</span><span class=p>)</span>
<a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
<a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a>
<a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a>            <span class=n>span</span><span class=o>.</span><span class=n>record_exception</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
<a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_status</span><span class=p>(</span><span class=n>trace</span><span class=o>.</span><span class=n>StatusCode</span><span class=o>.</span><span class=n>ERROR</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a>            <span class=k>raise</span>
</code></pre></div> <h3 id=62-gemini-api-tracing>6.2 Gemini API Tracing<a class=headerlink href=#62-gemini-api-tracing title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>generate_gemini_response</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prompt</span><span class=p>,</span> <span class=n>image_data</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Trace Gemini API requests&quot;&quot;&quot;</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=n>tracer</span> <span class=o>=</span> <span class=n>trace</span><span class=o>.</span><span class=n>get_tracer</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>    <span class=k>with</span> <span class=n>tracer</span><span class=o>.</span><span class=n>start_as_current_span</span><span class=p>(</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>        <span class=s2>&quot;gemini.generate&quot;</span><span class=p>,</span> 
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        <span class=n>attributes</span><span class=o>=</span><span class=p>{</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>            <span class=s2>&quot;prompt.length&quot;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>prompt</span><span class=p>),</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>            <span class=s2>&quot;has_image&quot;</span><span class=p>:</span> <span class=n>image_data</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>        <span class=p>}</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>    <span class=p>)</span> <span class=k>as</span> <span class=n>span</span><span class=p>:</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>        <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>            <span class=c1># Initialize Gemini client</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>            <span class=n>gemini_client</span> <span class=o>=</span> <span class=n>AsyncGeminiClient</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>Config</span><span class=o>.</span><span class=n>GEMINI_API_KEY</span><span class=p>)</span>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>            <span class=n>model</span> <span class=o>=</span> <span class=n>Config</span><span class=o>.</span><span class=n>MODEL_CONFIGS</span><span class=p>[</span><span class=s2>&quot;gemini-thinking&quot;</span><span class=p>][</span><span class=s2>&quot;api_name&quot;</span><span class=p>]</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>            <span class=c1># Add request details to span</span>
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;model.name&quot;</span><span class=p>,</span> <span class=n>model</span><span class=p>)</span>
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>
<a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>            <span class=c1># Prepare content parts</span>
<a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>            <span class=n>content_parts</span> <span class=o>=</span> <span class=p>[{</span><span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}]</span>
<a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>            <span class=k>if</span> <span class=n>image_data</span><span class=p>:</span>
<a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>                <span class=c1># Add image to content parts</span>
<a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a>                <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;image.size&quot;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>image_data</span><span class=p>))</span>
<a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a>                <span class=n>content_parts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
<a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>                    <span class=s2>&quot;inline_data&quot;</span><span class=p>:</span> <span class=p>{</span>
<a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a>                        <span class=s2>&quot;mime_type&quot;</span><span class=p>:</span> <span class=s2>&quot;image/jpeg&quot;</span><span class=p>,</span>
<a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>                        <span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
<a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a>                    <span class=p>}</span>
<a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a>                <span class=p>})</span>
<a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a>
<a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a>            <span class=c1># Generate response</span>
<a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a>            <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a>            <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>gemini_client</span><span class=o>.</span><span class=n>generate_content</span><span class=p>(</span>
<a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a>                <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
<a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a>                <span class=n>contents</span><span class=o>=</span><span class=p>[{</span><span class=s2>&quot;parts&quot;</span><span class=p>:</span> <span class=n>content_parts</span><span class=p>}]</span>
<a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a>            <span class=p>)</span>
<a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a>
<a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a>            <span class=c1># Record performance metrics</span>
<a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
<a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;duration_seconds&quot;</span><span class=p>,</span> <span class=n>duration</span><span class=p>)</span>
<a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a>
<a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a>            <span class=c1># Extract response text</span>
<a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a>            <span class=k>if</span> <span class=n>response</span> <span class=ow>and</span> <span class=n>response</span><span class=o>.</span><span class=n>candidates</span><span class=p>:</span>
<a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a>                <span class=n>result</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>candidates</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>parts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
<a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a>                <span class=n>span</span><span class=o>.</span><span class=n>set_attribute</span><span class=p>(</span><span class=s2>&quot;response.length&quot;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
<a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a>                <span class=k>return</span> <span class=n>result</span>
<a id=__codelineno-8-48 name=__codelineno-8-48 href=#__codelineno-8-48></a>            <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-8-49 name=__codelineno-8-49 href=#__codelineno-8-49></a>                <span class=n>span</span><span class=o>.</span><span class=n>set_status</span><span class=p>(</span><span class=n>trace</span><span class=o>.</span><span class=n>StatusCode</span><span class=o>.</span><span class=n>ERROR</span><span class=p>,</span> <span class=s2>&quot;Empty response from Gemini&quot;</span><span class=p>)</span>
<a id=__codelineno-8-50 name=__codelineno-8-50 href=#__codelineno-8-50></a>                <span class=k>return</span> <span class=s2>&quot;No response generated&quot;</span>
<a id=__codelineno-8-51 name=__codelineno-8-51 href=#__codelineno-8-51></a>
<a id=__codelineno-8-52 name=__codelineno-8-52 href=#__codelineno-8-52></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-8-53 name=__codelineno-8-53 href=#__codelineno-8-53></a>            <span class=n>span</span><span class=o>.</span><span class=n>record_exception</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
<a id=__codelineno-8-54 name=__codelineno-8-54 href=#__codelineno-8-54></a>            <span class=n>span</span><span class=o>.</span><span class=n>set_status</span><span class=p>(</span><span class=n>trace</span><span class=o>.</span><span class=n>StatusCode</span><span class=o>.</span><span class=n>ERROR</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-8-55 name=__codelineno-8-55 href=#__codelineno-8-55></a>            <span class=k>raise</span>
</code></pre></div> <h2 id=7-visualization-and-monitoring>7. Visualization and Monitoring<a class=headerlink href=#7-visualization-and-monitoring title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=c1># Visualization endpoints</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/metrics&quot;</span><span class=p>)</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>metrics</span><span class=p>():</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Expose metrics for Prometheus scraping&quot;&quot;&quot;</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>Config</span><span class=o>.</span><span class=n>OTEL_ENABLED</span><span class=p>:</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=s2>&quot;OpenTelemetry is disabled&quot;</span><span class=p>}</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>    <span class=k>return</span> <span class=n>Response</span><span class=p>(</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>        <span class=n>content</span><span class=o>=</span><span class=n>generate_latest</span><span class=p>()</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&quot;utf-8&quot;</span><span class=p>),</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>        <span class=n>media_type</span><span class=o>=</span><span class=s2>&quot;text/plain&quot;</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>    <span class=p>)</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/traces/recent&quot;</span><span class=p>)</span>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>recent_traces</span><span class=p>():</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Get recent traces for UI display&quot;&quot;&quot;</span>
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>    <span class=c1># This would typically be handled by a trace visualization tool like Jaeger</span>
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>    <span class=c1># This endpoint just provides basic info for quick debugging</span>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>
<a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a>    <span class=n>recent</span> <span class=o>=</span> <span class=k>await</span> <span class=n>redis_client</span><span class=o>.</span><span class=n>lrange</span><span class=p>(</span><span class=s2>&quot;traces:recent&quot;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>9</span><span class=p>)</span>
<a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a>    <span class=k>return</span> <span class=p>[</span><span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>trace</span><span class=p>)</span> <span class=k>for</span> <span class=n>trace</span> <span class=ow>in</span> <span class=n>recent</span><span class=p>]</span>
</code></pre></div> <h2 id=8-deployment-configuration>8. Deployment Configuration<a class=headerlink href=#8-deployment-configuration title="Permanent link">&para;</a></h2> <p>For production deployments, OpenTelemetry traces are sent to a collector service that can export to various backends:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1># docker-compose excerpt for OpenTelemetry collector</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=nt>services</span><span class=p>:</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>  </span><span class=nt>otel-collector</span><span class=p>:</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">otel/opentelemetry-collector:0.97.0</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=s>&quot;--config=/etc/otel-config.yaml&quot;</span><span class="p p-Indicator">]</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">./otel-config.yaml:/etc/otel-config.yaml</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;4318:4318&quot;</span><span class=w>  </span><span class=c1># OTLP HTTP receiver</span>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;9464:9464&quot;</span><span class=w>  </span><span class=c1># Prometheus exporter</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=w>  </span><span class=c1># Visualization with Jaeger</span>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jaegertracing/all-in-one:latest</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a><span class=w>    </span><span class=nt>ports</span><span class=p>:</span>
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;16686:16686&quot;</span><span class=w>  </span><span class=c1># Jaeger UI</span>
<a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=w>      </span><span class="p p-Indicator">-</span><span class=w> </span><span class=s>&quot;14250:14250&quot;</span><span class=w>  </span><span class=c1># Receive from collector</span>
</code></pre></div> <h3 id=81-collector-configuration>8.1 Collector Configuration<a class=headerlink href=#81-collector-configuration title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=c1># otel-config.yaml</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=nt>receivers</span><span class=p>:</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>  </span><span class=nt>otlp</span><span class=p>:</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>    </span><span class=nt>protocols</span><span class=p>:</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>      </span><span class=nt>http</span><span class=p>:</span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>        </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:4318</span>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=nt>processors</span><span class=p>:</span>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>  </span><span class=nt>batch</span><span class=p>:</span>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1s</span>
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>    </span><span class=nt>send_batch_size</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1024</span>
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=nt>exporters</span><span class=p>:</span>
<a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>  </span><span class=nt>jaeger</span><span class=p>:</span>
<a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">jaeger:14250</span>
<a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>    </span><span class=nt>tls</span><span class=p>:</span>
<a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>      </span><span class=nt>insecure</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span>
<a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">0.0.0.0:9464</span>
<a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">opossum</span>
<a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=w>  </span><span class=nt>logging</span><span class=p>:</span>
<a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=w>    </span><span class=nt>loglevel</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">info</span>
<a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a>
<a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=nt>service</span><span class=p>:</span>
<a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a><span class=w>  </span><span class=nt>pipelines</span><span class=p>:</span>
<a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=w>    </span><span class=nt>traces</span><span class=p>:</span>
<a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>otlp</span><span class="p p-Indicator">]</span>
<a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>batch</span><span class="p p-Indicator">]</span>
<a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>jaeger</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>logging</span><span class="p p-Indicator">]</span>
<a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span>
<a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a><span class=w>      </span><span class=nt>receivers</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>otlp</span><span class="p p-Indicator">]</span>
<a id=__codelineno-11-32 name=__codelineno-11-32 href=#__codelineno-11-32></a><span class=w>      </span><span class=nt>processors</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>batch</span><span class="p p-Indicator">]</span>
<a id=__codelineno-11-33 name=__codelineno-11-33 href=#__codelineno-11-33></a><span class=w>      </span><span class=nt>exporters</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">[</span><span class=nv>prometheus</span><span class="p p-Indicator">,</span><span class=w> </span><span class=nv>logging</span><span class="p p-Indicator">]</span>
</code></pre></div> <p>The OpenTelemetry integration provides comprehensive observability for Opossum Search, enabling performance monitoring, troubleshooting, and service dependency tracking across the distributed architecture.</p> </div> </div><footer> <div class=rst-footer-buttons role=navigation aria-label="Footer Navigation"> <a href=../image-processing-pipeline/ class="btn btn-neutral float-left" title="Image Pipeline"><span class="icon icon-circle-arrow-left"></span> Previous</a> <a href=../svg-markup/ class="btn btn-neutral float-right" title="SVG Markup">Next <span class="icon icon-circle-arrow-right"></span></a> </div> <hr> <div role=contentinfo> <!-- Copyright etc --> </div> Built with <a href=https://www.mkdocs.org/ >MkDocs</a> using a <a href=https://github.com/readthedocs/sphinx_rtd_theme>theme</a> provided by <a href=https://readthedocs.org>Read the Docs</a>. </footer> </div> </div> </section> </div> <div class=rst-versions role=note aria-label=Versions> <span class=rst-current-version data-toggle=rst-current-version> <span><a href=../image-processing-pipeline/ style="color: #fcfcfc">&laquo; Previous</a></span> <span><a href=../svg-markup/ style="color: #fcfcfc">Next &raquo;</a></span> </span> </div> <script src=../../js/jquery-3.6.0.min.js></script> <script>var base_url = "../..";</script> <script src=../../js/theme_extra.js></script> <script src=../../js/theme.js></script> <script src=../../search/main.js></script> <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script> </body> </html> 