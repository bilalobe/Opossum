<!DOCTYPE html><html class=writer-html5 lang=en> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=author content=bebo><link rel="shortcut icon" href=../../img/favicon.ico><title>Image Pipeline - Opossum Search Documentation</title><link rel=stylesheet href=../../css/theme.css><link rel=stylesheet href=../../css/theme_extra.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css><link href=../../assets/_mkdocstrings.css rel=stylesheet><link href=../../stylesheets/extra.css rel=stylesheet><script>
        // Current page data
        var mkdocs_page_name = "Image Pipeline";
        var mkdocs_page_input_path = "technical\\image-processing-pipeline.md";
        var mkdocs_page_url = null;
      </script><!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.highlightAll();</script></head> <body class=wy-body-for-nav role=document> <div class=wy-grid-for-nav> <nav data-toggle=wy-nav-shift class="wy-nav-side stickynav"> <div class=wy-side-scroll> <div class=wy-side-nav-search> <a href=../.. class="icon icon-home"> Opossum Search Documentation </a><div role=search> <form id=rtd-search-form class=wy-form action=../../search.html method=get> <input type=text name=q placeholder="Search docs" aria-label="Search docs" title="Type search term here"> </form> </div> </div> <div class="wy-menu wy-menu-vertical" data-spy=affix role=navigation aria-label="Navigation menu"> <ul> <li class=toctree-l1><a class="reference internal" href=../..>Home</a> </li> </ul> <p class=caption><span class=caption-text>Getting Started</span></p> <ul> <li class=toctree-l1><a href=../getting-started/ class="reference internal">First Steps</a> </li> <li class=toctree-l1><a href=../system-architecture-overview/ class="reference internal">System Overview</a> </li> <li class=toctree-l1><a href=../../api/getting-started/ class="reference internal">API Reference</a> </li> <li class=toctree-l1><a href=../devops-guide/ class="reference internal">Developer Quickstart</a> </li> </ul> <p class=caption><span class=caption-text>Core Components</span></p> <ul> <li class=toctree-l1><a class="reference internal">Architecture</a> <ul> <li class=toctree-l2><a href=../system-architecture-overview/ class="reference internal">System Overview</a> </li> <li class=toctree-l2><a href=../mcp-architecture/ class="reference internal">Model Context Protocol (MCP)</a> </li> <li class=toctree-l2><a href=../graphql-api/ class="reference internal">GraphQL API</a> </li> <li class=toctree-l2><a href=../security-model/ class="reference internal">Security Model</a> </li> <li class=toctree-l2><a href=../prompt-management/ class="reference internal">Prompt Management</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Model Integration</a> <ul> <li class=toctree-l2><a href=../../model-integration/architecture/ class="reference internal">Architecture</a> </li> <li class=toctree-l2><a href=../../model-integration/backend-selection/ class="reference internal">Backend Selection</a> </li> <li class=toctree-l2><a href=../../model-integration/capability-matrix/ class="reference internal">Capability Matrix</a> </li> <li class=toctree-l2><a href=../../model-integration/providers/ class="reference internal">Provider Integration</a> </li> <li class=toctree-l2><a href=../../model-integration/configuration/ class="reference internal">Configuration</a> </li> <li class=toctree-l2><a href=../hybrid-model-selection/ class="reference internal">Hybrid Selection</a> </li> <li class=toctree-l2><a href=../prompt-management/ class="reference internal">Prompt Management</a> </li> <li class=toctree-l2><a href=../../model-integration/dspy-integration/ class="reference internal">DSPy Integration</a> </li> <li class=toctree-l2><a href=../../model-integration/dspy-technical/ class="reference internal">DSPy Technical Implementation</a> </li> <li class=toctree-l2><a href=../../model-integration/dspy-examples/ class="reference internal">DSPy Usage Examples</a> </li> <li class=toctree-l2><a href=../../model-integration/dspy-metrics/ class="reference internal">DSPy Metrics & Performance</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Service Availability</a> <ul> <li class=toctree-l2><a href=../../service-availability/context-and-scope/ class="reference internal">Context and Scope</a> </li> <li class=toctree-l2><a href=../../service-availability/quality-requirements/ class="reference internal">Quality Requirements</a> </li> <li class=toctree-l2><a href=../../service-availability/architecture-constraints/ class="reference internal">Architecture Constraints</a> </li> <li class=toctree-l2><a href=../../service-availability/availability-monitoring/ class="reference internal">Availability Monitoring</a> </li> <li class=toctree-l2><a href=../../service-availability/service-outage/ class="reference internal">Error Handling</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Resilience Patterns</a> <ul> <li class=toctree-l2><a href=../resilience-patterns/ class="reference internal">Core Strategies</a> </li> <li class=toctree-l2><a href=../error-handling-resilience/ class="reference internal">Error Handling</a> </li> <li class=toctree-l2><a href=../../service-availability/rate-limiting-throttling/ class="reference internal">Rate Limiting</a> </li> <li class=toctree-l2><a href=../../service-availability/log-alerts/ class="reference internal">Logging and Alerts</a> </li> <li class=toctree-l2><a href=../../service-availability/testing-validation/ class="reference internal">Testing and Validation</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>Features</span></p> <ul> <li class=toctree-l1><a class="reference internal">Conversation</a> <ul> <li class=toctree-l2><a href=../../conversation/topic-detection/ class="reference internal">Topic Detection</a> </li> <li class=toctree-l2><a href=../../conversation/conversation-flow/ class="reference internal">Conversation Flow</a> </li> <li class=toctree-l2><a href=../../conversation/response-generation/ class="reference internal">Response Generation</a> </li> <li class=toctree-l2><a href=../../conversation/nlp-components/ class="reference internal">NLP Components</a> </li> <li class=toctree-l2><a href=../../conversation/markov-generation/ class="reference internal">Markov Generation</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Image Processing</a> <ul> <li class=toctree-l2><a href=../../image-processing/overview/ class="reference internal">Overview</a> </li> <li class=toctree-l2><a href=../../image-processing/effects/ class="reference internal">Effects and Filters</a> </li> <li class=toctree-l2><a href=../../image-processing/svg-generation/ class="reference internal">SVG Generation</a> </li> <li class=toctree-l2><a href=../../image-processing/optimization/ class="reference internal">Performance Optimization</a> </li> <li class=toctree-l2><a href=../../image-processing/caching/ class="reference internal">Caching Strategy</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Visualizations & Fun</a> <ul> <li class=toctree-l2><a href=../../features/service-vizualizations/ class="reference internal">Service Visualizations</a> </li> <li class=toctree-l2><a href=../../features/national-day/ class="reference internal">National Opossum Day</a> </li> <li class=toctree-l2><a href=../../features/opossum-xenzia/ class="reference internal">Opossum Xenzia</a> </li> <li class=toctree-l2><a href=../../features/easter-eggs/ class="reference internal">Easter Eggs</a> </li> <li class=toctree-l2><a href=../../features/special-events/ class="reference internal">Special Events</a> </li> <li class=toctree-l2><a href=../../features/background-stories/ class="reference internal">Background Stories</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>Technical Reference</span></p> <ul class=current> <li class="toctree-l1 current"><a class="reference internal current">Infrastructure</a> <ul class=current> <li class=toctree-l2><a href=../redis-caching-architecture/ class="reference internal">Redis Caching</a> </li> <li class="toctree-l2 current"><a class="reference internal current" href=#>Image Pipeline</a> <ul class=current> <li class=toctree-l3><a class="reference internal" href=#1-overview>1. Overview</a> </li> <li class=toctree-l3><a class="reference internal" href=#2-processing-stages>2. Processing Stages</a> <ul> <li class=toctree-l4><a class="reference internal" href=#21-initial-processing>2.1 Initial Processing</a> </li> <li class=toctree-l4><a class="reference internal" href=#22-transformation-pipeline>2.2 Transformation Pipeline</a> </li> <li class=toctree-l4><a class="reference internal" href=#23-parallel-processing>2.3 Parallel Processing</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#3-multimodal-routing>3. Multimodal Routing</a> <ul> <li class=toctree-l4><a class="reference internal" href=#31-model-capability-assessment>3.1 Model Capability Assessment</a> </li> <li class=toctree-l4><a class="reference internal" href=#32-image-analysis-pre-processing>3.2 Image Analysis Pre-processing</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#4-image-to-base64-conversion>4. Image-to-Base64 Conversion</a> </li> <li class=toctree-l3><a class="reference internal" href=#5-security-considerations>5. Security Considerations</a> <ul> <li class=toctree-l4><a class="reference internal" href=#51-image-validation>5.1 Image Validation</a> </li> <li class=toctree-l4><a class="reference internal" href=#52-malware-scanning>5.2 Malware Scanning</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#6-performance-optimization>6. Performance Optimization</a> <ul> <li class=toctree-l4><a class="reference internal" href=#61-image-processing-caching>6.1 Image Processing Caching</a> </li> <li class=toctree-l4><a class="reference internal" href=#62-image-compression-strategies>6.2 Image Compression Strategies</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#7-integration-with-llm-pipeline>7. Integration with LLM Pipeline</a> <ul> <li class=toctree-l4><a class="reference internal" href=#71-multimodal-message-construction>7.1 Multimodal Message Construction</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#8-error-handling>8. Error Handling</a> </li> <li class=toctree-l3><a class="reference internal" href=#9-future-enhancements>9. Future Enhancements</a> </li> </ul> </li> <li class=toctree-l2><a href=../opentelemetry-integration/ class="reference internal">OpenTelemetry</a> </li> <li class=toctree-l2><a href=../svg-markup/ class="reference internal">SVG Markup</a> </li> <li class=toctree-l2><a href=../bot-user-simulation/ class="reference internal">Bot User Simulation</a> </li> <li class=toctree-l2><a href=../../infrastructure/optimization-strategies/ class="reference internal">Optimization Strategies</a> </li> <li class=toctree-l2><a href=../../infrastructure/pipeline-optimization/ class="reference internal">Pipeline Optimization</a> </li> <li class=toctree-l2><a href=../../infrastructure/constraint-mapping/ class="reference internal">Constraint Mapping</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">API Documentation</a> <ul> <li class=toctree-l2><a href=../../api/routes/ class="reference internal">Routes</a> </li> <li class=toctree-l2><a href=../../api/request-response/ class="reference internal">Request/Response</a> </li> <li class=toctree-l2><a href=../../api/oauth-configuration/ class="reference internal">OAuth Configuration</a> </li> <li class=toctree-l2><a href=../../api/error-codes/ class="reference internal">Error Codes</a> </li> <li class=toctree-l2><a href=../../api/rate-limits/ class="reference internal">Rate Limits</a> </li> <li class=toctree-l2><a href=../../api/webhooks/ class="reference internal">Webhook Integration</a> </li> <li class=toctree-l2><a href=../../api/health-endpoints/ class="reference internal">Health Endpoints</a> </li> <li class=toctree-l2><a href=../../api/compliance/ class="reference internal">Compliance</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">DSPy Tutorials</a> <ul> <li class=toctree-l2><a href=../../tutorials/dspy/getting-started/ class="reference internal">Getting Started with DSPy</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/optimizing-prompts/ class="reference internal">Optimizing Prompts</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/building-pipelines/ class="reference internal">Building Pipelines</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/advanced-reasoning/ class="reference internal">Advanced Reasoning</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>About</span></p> <ul> <li class=toctree-l1><a href=../../about/history/ class="reference internal">Project History</a> </li> <li class=toctree-l1><a href=../../about/opossumial-way/ class="reference internal">The Opossumial Way</a> </li> <li class=toctree-l1><a href=../../about/team/ class="reference internal">Team</a> </li> <li class=toctree-l1><a href=../../about/roadmap-vision/ class="reference internal">Roadmap & Vision</a> </li> </ul> </div> </div> </nav> <section data-toggle=wy-nav-shift class=wy-nav-content-wrap> <nav class=wy-nav-top role=navigation aria-label="Mobile navigation menu"> <i data-toggle=wy-nav-top class="fa fa-bars"></i> <a href=../..>Opossum Search Documentation</a> </nav> <div class=wy-nav-content> <div class=rst-content><div role=navigation aria-label="breadcrumbs navigation"> <ul class=wy-breadcrumbs> <li><a href=../.. class="icon icon-home" aria-label=Docs></a></li> <li class=breadcrumb-item>Technical Reference</li> <li class=breadcrumb-item>Infrastructure</li> <li class="breadcrumb-item active">Image Pipeline</li> <li class=wy-breadcrumbs-aside> </li> </ul> <hr> </div> <div role=main class=document itemscope=itemscope itemtype=http://schema.org/Article> <div class=section itemprop=articleBody> <h1 id=technical-documentation-image-processing-pipeline>Technical Documentation: Image Processing Pipeline<a class=headerlink href=#technical-documentation-image-processing-pipeline title="Permanent link">&para;</a></h1> <h2 id=1-overview>1. Overview<a class=headerlink href=#1-overview title="Permanent link">&para;</a></h2> <p>The Image Processing Pipeline in Opossum Search handles multimodal queries containing images, preparing them for analysis by various AI backends. This pipeline ensures optimal image formatting for different models, performs necessary transformations, and extracts relevant metadata to enhance multimodal understanding.</p> <h2 id=2-processing-stages>2. Processing Stages<a class=headerlink href=#2-processing-stages title="Permanent link">&para;</a></h2> <h3 id=21-initial-processing>2.1 Initial Processing<a class=headerlink href=#21-initial-processing title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>process_incoming_image</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>,</span> <span class=n>image_type</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Process incoming image data for multimodal analysis&quot;&quot;&quot;</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>    <span class=c1># Detect format if not provided</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>image_type</span><span class=p>:</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>        <span class=n>image_type</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_detect_image_format</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>    <span class=c1># Validate image for security</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_validate_image</span><span class=p>(</span><span class=n>image_data</span><span class=p>,</span> <span class=n>image_type</span><span class=p>):</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>        <span class=k>raise</span> <span class=n>InvalidImageError</span><span class=p>(</span><span class=s2>&quot;Invalid or corrupted image data&quot;</span><span class=p>)</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>    <span class=c1># Extract basic metadata</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>    <span class=n>metadata</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_metadata</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>    <span class=c1># Create processing context</span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>    <span class=n>context</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>        <span class=s2>&quot;original_size&quot;</span><span class=p>:</span> <span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;size&quot;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>        <span class=s2>&quot;dimensions&quot;</span><span class=p>:</span> <span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;dimensions&quot;</span><span class=p>,</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)),</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>        <span class=s2>&quot;format&quot;</span><span class=p>:</span> <span class=n>image_type</span><span class=p>,</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>        <span class=s2>&quot;content_type&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;image/</span><span class=si>{</span><span class=n>image_type</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>        <span class=s2>&quot;requires_resize&quot;</span><span class=p>:</span> <span class=nb>any</span><span class=p>(</span><span class=n>dim</span> <span class=o>&gt;</span> <span class=n>Config</span><span class=o>.</span><span class=n>MAX_IMAGE_DIMENSION</span> <span class=k>for</span> <span class=n>dim</span> <span class=ow>in</span> <span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;dimensions&quot;</span><span class=p>,</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)))</span>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>    <span class=p>}</span>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>    <span class=k>return</span> <span class=p>{</span>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>        <span class=s2>&quot;image_data&quot;</span><span class=p>:</span> <span class=n>image_data</span><span class=p>,</span>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>        <span class=s2>&quot;metadata&quot;</span><span class=p>:</span> <span class=n>metadata</span><span class=p>,</span>
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>        <span class=s2>&quot;context&quot;</span><span class=p>:</span> <span class=n>context</span>
<a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>    <span class=p>}</span>
</code></pre></div> <h4 id=format-detection>Format Detection<a class=headerlink href=#format-detection title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>def</span><span class=w> </span><span class=nf>_detect_image_format</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>):</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Detect image format from binary data&quot;&quot;&quot;</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>    <span class=c1># Check magic bytes for common formats</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>    <span class=k>if</span> <span class=n>image_data</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xFF\xD8\xFF</span><span class=s1>&#39;</span><span class=p>):</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>        <span class=k>return</span> <span class=s2>&quot;jpeg&quot;</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>    <span class=k>elif</span> <span class=n>image_data</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x89</span><span class=s1>PNG</span><span class=se>\r\n\x1a\n</span><span class=s1>&#39;</span><span class=p>):</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>        <span class=k>return</span> <span class=s2>&quot;png&quot;</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>    <span class=k>elif</span> <span class=n>image_data</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;GIF87a&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>image_data</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;GIF89a&#39;</span><span class=p>):</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>        <span class=k>return</span> <span class=s2>&quot;gif&quot;</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>    <span class=k>elif</span> <span class=n>image_data</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;RIFF&#39;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>image_data</span><span class=p>[</span><span class=mi>8</span><span class=p>:</span><span class=mi>12</span><span class=p>]</span> <span class=o>==</span> <span class=sa>b</span><span class=s1>&#39;WEBP&#39;</span><span class=p>:</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        <span class=k>return</span> <span class=s2>&quot;webp&quot;</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>    <span class=c1># Use ImageMagick for more complex detection</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>    <span class=k>with</span> <span class=n>wand</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>blob</span><span class=o>=</span><span class=n>image_data</span><span class=p>)</span> <span class=k>as</span> <span class=n>img</span><span class=p>:</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>        <span class=k>return</span> <span class=n>img</span><span class=o>.</span><span class=n>format</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</code></pre></div> <h4 id=metadata-extraction>Metadata Extraction<a class=headerlink href=#metadata-extraction title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>_extract_metadata</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>):</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Extract metadata from image&quot;&quot;&quot;</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>    <span class=n>metadata</span> <span class=o>=</span> <span class=p>{}</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>    <span class=k>with</span> <span class=n>wand</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>blob</span><span class=o>=</span><span class=n>image_data</span><span class=p>)</span> <span class=k>as</span> <span class=n>img</span><span class=p>:</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>        <span class=c1># Basic properties</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>        <span class=n>metadata</span><span class=p>[</span><span class=s2>&quot;dimensions&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>width</span><span class=p>,</span> <span class=n>img</span><span class=o>.</span><span class=n>height</span><span class=p>)</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>        <span class=n>metadata</span><span class=p>[</span><span class=s2>&quot;format&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>format</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>        <span class=n>metadata</span><span class=p>[</span><span class=s2>&quot;size&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>        <span class=n>metadata</span><span class=p>[</span><span class=s2>&quot;colorspace&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>colorspace</span><span class=p>)</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>        <span class=n>metadata</span><span class=p>[</span><span class=s2>&quot;depth&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>depth</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>        <span class=c1># Extract EXIF if available</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=s1>&#39;metadata&#39;</span><span class=p>):</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>            <span class=n>exif</span> <span class=o>=</span> <span class=p>{}</span>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>            <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>img</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a>                <span class=k>if</span> <span class=n>k</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;exif:&#39;</span><span class=p>):</span>
<a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>                    <span class=n>exif_key</span> <span class=o>=</span> <span class=n>k</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
<a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>                    <span class=n>exif</span><span class=p>[</span><span class=n>exif_key</span><span class=p>]</span> <span class=o>=</span> <span class=n>v</span>
<a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>
<a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>            <span class=k>if</span> <span class=n>exif</span><span class=p>:</span>
<a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a>                <span class=n>metadata</span><span class=p>[</span><span class=s2>&quot;exif&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>exif</span>
<a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>
<a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>    <span class=k>return</span> <span class=n>metadata</span>
</code></pre></div> <h3 id=22-transformation-pipeline>2.2 Transformation Pipeline<a class=headerlink href=#22-transformation-pipeline title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>transform_for_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>,</span> <span class=n>target_model</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Transform image for specific model requirements&quot;&quot;&quot;</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=n>context</span> <span class=o>=</span> <span class=n>context</span> <span class=ow>or</span> <span class=p>{}</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    <span class=n>transformations</span> <span class=o>=</span> <span class=p>[]</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    <span class=c1># Determine required transformations based on model</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    <span class=k>if</span> <span class=n>target_model</span> <span class=o>==</span> <span class=s2>&quot;gemini-thinking&quot;</span><span class=p>:</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>        <span class=n>transformations</span> <span class=o>=</span> <span class=p>[</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_resize_image</span><span class=p>(</span><span class=n>max_dimension</span><span class=o>=</span><span class=mi>1024</span><span class=p>),</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_convert_format</span><span class=p>(</span><span class=n>target_format</span><span class=o>=</span><span class=s2>&quot;jpeg&quot;</span><span class=p>,</span> <span class=n>quality</span><span class=o>=</span><span class=mi>90</span><span class=p>)</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>        <span class=p>]</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>    <span class=k>elif</span> <span class=n>target_model</span> <span class=o>==</span> <span class=s2>&quot;llava&quot;</span><span class=p>:</span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>        <span class=n>transformations</span> <span class=o>=</span> <span class=p>[</span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_resize_image</span><span class=p>(</span><span class=n>max_dimension</span><span class=o>=</span><span class=mi>512</span><span class=p>),</span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_convert_format</span><span class=p>(</span><span class=n>target_format</span><span class=o>=</span><span class=s2>&quot;jpeg&quot;</span><span class=p>,</span> <span class=n>quality</span><span class=o>=</span><span class=mi>80</span><span class=p>)</span>
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>        <span class=p>]</span>
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>        <span class=c1># Default transformations</span>
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>        <span class=n>transformations</span> <span class=o>=</span> <span class=p>[</span>
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_resize_image</span><span class=p>(</span><span class=n>max_dimension</span><span class=o>=</span><span class=mi>768</span><span class=p>),</span>
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_convert_format</span><span class=p>(</span><span class=n>target_format</span><span class=o>=</span><span class=s2>&quot;jpeg&quot;</span><span class=p>,</span> <span class=n>quality</span><span class=o>=</span><span class=mi>85</span><span class=p>)</span>
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>        <span class=p>]</span>
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>
<a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>    <span class=c1># Apply transformations in sequence</span>
<a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>    <span class=n>processed_image</span> <span class=o>=</span> <span class=n>image_data</span>
<a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>    <span class=k>for</span> <span class=n>transform_fn</span> <span class=ow>in</span> <span class=n>transformations</span><span class=p>:</span>
<a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>        <span class=n>processed_image</span> <span class=o>=</span> <span class=k>await</span> <span class=n>transform_fn</span><span class=p>(</span><span class=n>processed_image</span><span class=p>)</span>
<a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>
<a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>    <span class=c1># Update context with transformed image details</span>
<a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>    <span class=k>with</span> <span class=n>wand</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>blob</span><span class=o>=</span><span class=n>processed_image</span><span class=p>)</span> <span class=k>as</span> <span class=n>img</span><span class=p>:</span>
<a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a>        <span class=n>context</span><span class=p>[</span><span class=s2>&quot;transformed_size&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>processed_image</span><span class=p>)</span>
<a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a>        <span class=n>context</span><span class=p>[</span><span class=s2>&quot;transformed_dimensions&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>width</span><span class=p>,</span> <span class=n>img</span><span class=o>.</span><span class=n>height</span><span class=p>)</span>
<a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a>
<a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a>    <span class=k>return</span> <span class=n>processed_image</span><span class=p>,</span> <span class=n>context</span>
</code></pre></div> <h4 id=resize-function>Resize Function<a class=headerlink href=#resize-function title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>def</span><span class=w> </span><span class=nf>_resize_image</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_dimension</span><span class=o>=</span><span class=mi>768</span><span class=p>):</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Create a resize transformation function&quot;&quot;&quot;</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>resize_transform</span><span class=p>(</span><span class=n>image_data</span><span class=p>):</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>        <span class=k>with</span> <span class=n>wand</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>blob</span><span class=o>=</span><span class=n>image_data</span><span class=p>)</span> <span class=k>as</span> <span class=n>img</span><span class=p>:</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>            <span class=c1># Check if resize needed</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>            <span class=k>if</span> <span class=n>img</span><span class=o>.</span><span class=n>width</span> <span class=o>&lt;=</span> <span class=n>max_dimension</span> <span class=ow>and</span> <span class=n>img</span><span class=o>.</span><span class=n>height</span> <span class=o>&lt;=</span> <span class=n>max_dimension</span><span class=p>:</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>                <span class=k>return</span> <span class=n>image_data</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>            <span class=c1># Calculate new dimensions maintaining aspect ratio</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>            <span class=n>ratio</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>max_dimension</span> <span class=o>/</span> <span class=n>img</span><span class=o>.</span><span class=n>width</span><span class=p>,</span> <span class=n>max_dimension</span> <span class=o>/</span> <span class=n>img</span><span class=o>.</span><span class=n>height</span><span class=p>)</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>            <span class=n>new_width</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>width</span> <span class=o>*</span> <span class=n>ratio</span><span class=p>)</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>            <span class=n>new_height</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>height</span> <span class=o>*</span> <span class=n>ratio</span><span class=p>)</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>            <span class=c1># Perform resize</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>            <span class=n>img</span><span class=o>.</span><span class=n>resize</span><span class=p>(</span><span class=n>new_width</span><span class=p>,</span> <span class=n>new_height</span><span class=p>)</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>            <span class=c1># Return resized image</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>            <span class=k>return</span> <span class=n>img</span><span class=o>.</span><span class=n>make_blob</span><span class=p>()</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>    <span class=k>return</span> <span class=n>resize_transform</span>
</code></pre></div> <h4 id=format-conversion>Format Conversion<a class=headerlink href=#format-conversion title="Permanent link">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>def</span><span class=w> </span><span class=nf>_convert_format</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>target_format</span><span class=o>=</span><span class=s2>&quot;jpeg&quot;</span><span class=p>,</span> <span class=n>quality</span><span class=o>=</span><span class=mi>85</span><span class=p>):</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Create a format conversion transformation function&quot;&quot;&quot;</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>format_transform</span><span class=p>(</span><span class=n>image_data</span><span class=p>):</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>        <span class=k>with</span> <span class=n>wand</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>blob</span><span class=o>=</span><span class=n>image_data</span><span class=p>)</span> <span class=k>as</span> <span class=n>img</span><span class=p>:</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>            <span class=c1># Set format and quality</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>            <span class=n>img</span><span class=o>.</span><span class=n>format</span> <span class=o>=</span> <span class=n>target_format</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>            <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=s1>&#39;compression_quality&#39;</span><span class=p>):</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>                <span class=n>img</span><span class=o>.</span><span class=n>compression_quality</span> <span class=o>=</span> <span class=n>quality</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>            <span class=c1># Handle transparency for JPEG conversion</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>            <span class=k>if</span> <span class=n>target_format</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s1>&#39;jpeg&#39;</span> <span class=ow>and</span> <span class=n>img</span><span class=o>.</span><span class=n>alpha_channel</span><span class=p>:</span>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>                <span class=c1># Add white background for transparent images</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>                <span class=k>with</span> <span class=n>wand</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span>
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>                    <span class=n>width</span><span class=o>=</span><span class=n>img</span><span class=o>.</span><span class=n>width</span><span class=p>,</span>
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>                    <span class=n>height</span><span class=o>=</span><span class=n>img</span><span class=o>.</span><span class=n>height</span><span class=p>,</span>
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>                    <span class=n>background</span><span class=o>=</span><span class=n>wand</span><span class=o>.</span><span class=n>color</span><span class=o>.</span><span class=n>Color</span><span class=p>(</span><span class=s1>&#39;white&#39;</span><span class=p>)</span>
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>                <span class=p>)</span> <span class=k>as</span> <span class=n>bg</span><span class=p>:</span>
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>                    <span class=n>bg</span><span class=o>.</span><span class=n>composite</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>                    <span class=k>return</span> <span class=n>bg</span><span class=o>.</span><span class=n>make_blob</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=n>target_format</span><span class=p>)</span>
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>            <span class=c1># Standard conversion</span>
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>            <span class=k>return</span> <span class=n>img</span><span class=o>.</span><span class=n>make_blob</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=n>target_format</span><span class=p>)</span>
<a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>
<a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>    <span class=k>return</span> <span class=n>format_transform</span>
</code></pre></div> <h3 id=23-parallel-processing>2.3 Parallel Processing<a class=headerlink href=#23-parallel-processing title="Permanent link">&para;</a></h3> <p>For efficiency, the system processes multiple transformations in parallel:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>parallel_image_processing</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>):</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Process image with parallel transformations&quot;&quot;&quot;</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    <span class=c1># Define processing tasks</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_resize_image</span><span class=p>(</span><span class=n>max_dimension</span><span class=o>=</span><span class=mi>512</span><span class=p>)(</span><span class=n>image_data</span><span class=p>),</span>  <span class=c1># Standard size</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_extract_metadata</span><span class=p>(</span><span class=n>image_data</span><span class=p>),</span>              <span class=c1># Metadata extraction</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_generate_thumbnail</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span>             <span class=c1># Thumbnail generation</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>    <span class=p>]</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>    <span class=c1># Run processing tasks in parallel</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>    <span class=n>resized</span><span class=p>,</span> <span class=n>metadata</span><span class=p>,</span> <span class=n>thumbnail</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>)</span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>    <span class=c1># Combine results</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>    <span class=k>return</span> <span class=p>{</span>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>        <span class=s2>&quot;image&quot;</span><span class=p>:</span> <span class=n>resized</span><span class=p>,</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>        <span class=s2>&quot;metadata&quot;</span><span class=p>:</span> <span class=n>metadata</span><span class=p>,</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>        <span class=s2>&quot;thumbnail&quot;</span><span class=p>:</span> <span class=n>thumbnail</span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>    <span class=p>}</span>
</code></pre></div> <h2 id=3-multimodal-routing>3. Multimodal Routing<a class=headerlink href=#3-multimodal-routing title="Permanent link">&para;</a></h2> <h3 id=31-model-capability-assessment>3.1 Model Capability Assessment<a class=headerlink href=#31-model-capability-assessment title="Permanent link">&para;</a></h3> <p>The system routes images to appropriate models based on their capabilities:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>select_model_for_image</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_context</span><span class=p>,</span> <span class=n>query_text</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Select appropriate model for image processing&quot;&quot;&quot;</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>    <span class=c1># Check for image-specific features</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    <span class=n>has_text</span> <span class=o>=</span> <span class=n>image_context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;has_text&quot;</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    <span class=n>is_chart</span> <span class=o>=</span> <span class=n>image_context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;is_chart&quot;</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>    <span class=n>needs_detail</span> <span class=o>=</span> <span class=n>image_context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;high_detail&quot;</span><span class=p>,</span> <span class=kc>False</span><span class=p>)</span>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    <span class=c1># Score each available model</span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>    <span class=n>scores</span> <span class=o>=</span> <span class=p>{}</span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_available</span><span class=p>(</span><span class=s2>&quot;gemini-thinking&quot;</span><span class=p>):</span>
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>        <span class=n>scores</span><span class=p>[</span><span class=s2>&quot;gemini-thinking&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># Base score</span>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>        <span class=k>if</span> <span class=n>needs_detail</span><span class=p>:</span>
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>            <span class=n>scores</span><span class=p>[</span><span class=s2>&quot;gemini-thinking&quot;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>5</span>  <span class=c1># Good with details</span>
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_available</span><span class=p>(</span><span class=s2>&quot;llava&quot;</span><span class=p>):</span>
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a>        <span class=n>scores</span><span class=p>[</span><span class=s2>&quot;llava&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>8</span>  <span class=c1># Base score</span>
<a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a>        <span class=k>if</span> <span class=n>has_text</span><span class=p>:</span>
<a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a>            <span class=n>scores</span><span class=p>[</span><span class=s2>&quot;llava&quot;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>3</span>  <span class=c1># Good with text in images</span>
<a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a>
<a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a>    <span class=c1># Get highest scoring model</span>
<a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>scores</span><span class=p>:</span>
<a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>        <span class=k>return</span> <span class=n>Config</span><span class=o>.</span><span class=n>DEFAULT_MODEL</span>  <span class=c1># No multimodal models available</span>
<a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a>
<a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>scores</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>])[</span><span class=mi>0</span><span class=p>]</span>
</code></pre></div> <h3 id=32-image-analysis-pre-processing>3.2 Image Analysis Pre-processing<a class=headerlink href=#32-image-analysis-pre-processing title="Permanent link">&para;</a></h3> <p>Before sending to model, images may undergo analysis to guide model selection:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>analyze_image_content</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>):</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Analyze image to determine key characteristics&quot;&quot;&quot;</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=n>analysis</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>        <span class=s2>&quot;has_text&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>        <span class=s2>&quot;is_chart&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>        <span class=s2>&quot;is_photo&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        <span class=s2>&quot;high_detail&quot;</span><span class=p>:</span> <span class=kc>False</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>    <span class=p>}</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>    <span class=c1># Use MiniLM for quick embedding-based classification</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>minilm_embedder</span><span class=p>:</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>        <span class=c1># Extract image features</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>        <span class=n>features</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_extract_image_features</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>        <span class=c1># Compare with feature vectors for different image types</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>        <span class=n>text_score</span> <span class=o>=</span> <span class=n>cosine_similarity</span><span class=p>(</span><span class=n>features</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>text_image_embedding</span><span class=p>)</span>
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>        <span class=n>chart_score</span> <span class=o>=</span> <span class=n>cosine_similarity</span><span class=p>(</span><span class=n>features</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>chart_image_embedding</span><span class=p>)</span>
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>        <span class=n>photo_score</span> <span class=o>=</span> <span class=n>cosine_similarity</span><span class=p>(</span><span class=n>features</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>photo_image_embedding</span><span class=p>)</span>
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>
<a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>        <span class=c1># Set flags based on similarity scores</span>
<a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>        <span class=k>if</span> <span class=n>text_score</span> <span class=o>&gt;</span> <span class=mf>0.65</span><span class=p>:</span>
<a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>            <span class=n>analysis</span><span class=p>[</span><span class=s2>&quot;has_text&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
<a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>        <span class=k>if</span> <span class=n>chart_score</span> <span class=o>&gt;</span> <span class=mf>0.7</span><span class=p>:</span>
<a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a>            <span class=n>analysis</span><span class=p>[</span><span class=s2>&quot;is_chart&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
<a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a>        <span class=k>if</span> <span class=n>photo_score</span> <span class=o>&gt;</span> <span class=mf>0.75</span><span class=p>:</span>
<a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>            <span class=n>analysis</span><span class=p>[</span><span class=s2>&quot;is_photo&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
<a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a>
<a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>    <span class=c1># Check for high detail based on entropy</span>
<a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a>    <span class=n>analysis</span><span class=p>[</span><span class=s2>&quot;high_detail&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_check_image_detail</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span>
<a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a>
<a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a>    <span class=k>return</span> <span class=n>analysis</span>
</code></pre></div> <h2 id=4-image-to-base64-conversion>4. Image-to-Base64 Conversion<a class=headerlink href=#4-image-to-base64-conversion title="Permanent link">&para;</a></h2> <p>For API transmission, images are encoded to base64:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>def</span><span class=w> </span><span class=nf>encode_image_for_api</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>,</span> <span class=n>prefix</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Encode image data as base64 for API transmission&quot;&quot;&quot;</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=c1># Get image format if available</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>    <span class=n>image_format</span> <span class=o>=</span> <span class=s2>&quot;jpeg&quot;</span>  <span class=c1># Default</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>        <span class=k>with</span> <span class=n>wand</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>blob</span><span class=o>=</span><span class=n>image_data</span><span class=p>)</span> <span class=k>as</span> <span class=n>img</span><span class=p>:</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>            <span class=n>image_format</span> <span class=o>=</span> <span class=n>img</span><span class=o>.</span><span class=n>format</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>        <span class=k>pass</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>    <span class=c1># Base64 encode</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>    <span class=n>b64_data</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a>    <span class=c1># Add data URI prefix if requested</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>    <span class=k>if</span> <span class=n>prefix</span><span class=p>:</span>
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&quot;data:image/</span><span class=si>{</span><span class=n>image_format</span><span class=si>}</span><span class=s2>;base64,</span><span class=si>{</span><span class=n>b64_data</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>    <span class=k>return</span> <span class=n>b64_data</span>
</code></pre></div> <h2 id=5-security-considerations>5. Security Considerations<a class=headerlink href=#5-security-considerations title="Permanent link">&para;</a></h2> <h3 id=51-image-validation>5.1 Image Validation<a class=headerlink href=#51-image-validation title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>def</span><span class=w> </span><span class=nf>_validate_image</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>,</span> <span class=n>image_type</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Validate image for security and integrity&quot;&quot;&quot;</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    <span class=c1># Size validation</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>Config</span><span class=o>.</span><span class=n>MAX_IMAGE_SIZE</span><span class=p>:</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Image exceeds maximum size: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span><span class=si>}</span><span class=s2> bytes&quot;</span><span class=p>)</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>        <span class=k>return</span> <span class=kc>False</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>    <span class=c1># Format validation</span>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>    <span class=n>allowed_formats</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;jpeg&#39;</span><span class=p>,</span> <span class=s1>&#39;jpg&#39;</span><span class=p>,</span> <span class=s1>&#39;png&#39;</span><span class=p>,</span> <span class=s1>&#39;gif&#39;</span><span class=p>,</span> <span class=s1>&#39;webp&#39;</span><span class=p>]</span>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a>    <span class=k>if</span> <span class=n>image_type</span> <span class=ow>and</span> <span class=n>image_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>allowed_formats</span><span class=p>:</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Image format not allowed: </span><span class=si>{</span><span class=n>image_type</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>        <span class=k>return</span> <span class=kc>False</span>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>    <span class=c1># Integrity check - attempt to open and process</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>        <span class=k>with</span> <span class=n>wand</span><span class=o>.</span><span class=n>image</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>blob</span><span class=o>=</span><span class=n>image_data</span><span class=p>)</span> <span class=k>as</span> <span class=n>img</span><span class=p>:</span>
<a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a>            <span class=c1># Check for potential dangerous sizes</span>
<a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a>            <span class=k>if</span> <span class=n>img</span><span class=o>.</span><span class=n>width</span> <span class=o>&gt;</span> <span class=mi>10000</span> <span class=ow>or</span> <span class=n>img</span><span class=o>.</span><span class=n>height</span> <span class=o>&gt;</span> <span class=mi>10000</span><span class=p>:</span>
<a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a>                <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Suspicious image dimensions: </span><span class=si>{</span><span class=n>img</span><span class=o>.</span><span class=n>width</span><span class=si>}</span><span class=s2>x</span><span class=si>{</span><span class=n>img</span><span class=o>.</span><span class=n>height</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a>                <span class=k>return</span> <span class=kc>False</span>
<a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a>
<a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a>            <span class=c1># Additional validation can be performed here</span>
<a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a>
<a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a>            <span class=c1># Image passed all checks</span>
<a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a>            <span class=k>return</span> <span class=kc>True</span>
<a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a>        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Image validation failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-10-28 name=__codelineno-10-28 href=#__codelineno-10-28></a>        <span class=k>return</span> <span class=kc>False</span>
</code></pre></div> <h3 id=52-malware-scanning>5.2 Malware Scanning<a class=headerlink href=#52-malware-scanning title="Permanent link">&para;</a></h3> <p>For production environments, the system can integrate with ClamAV:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>scan_image_for_malware</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>):</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Scan image for malware (requires ClamAV)&quot;&quot;&quot;</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    <span class=c1># Skip if scanning disabled</span>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>Config</span><span class=o>.</span><span class=n>ENABLE_MALWARE_SCAN</span><span class=p>:</span>
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>        <span class=k>return</span> <span class=kc>True</span>
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>
<a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>    <span class=c1># Connect to ClamAV daemon</span>
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>        <span class=n>clamd</span> <span class=o>=</span> <span class=n>clamd</span><span class=o>.</span><span class=n>ClamdNetworkSocket</span><span class=p>(</span>
<a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>            <span class=n>host</span><span class=o>=</span><span class=n>Config</span><span class=o>.</span><span class=n>CLAMAV_HOST</span><span class=p>,</span>
<a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a>            <span class=n>port</span><span class=o>=</span><span class=n>Config</span><span class=o>.</span><span class=n>CLAMAV_PORT</span>
<a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a>        <span class=p>)</span>
<a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a>
<a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a>        <span class=c1># Scan the image data</span>
<a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a>        <span class=n>scan_result</span> <span class=o>=</span> <span class=n>clamd</span><span class=o>.</span><span class=n>instream</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>(</span><span class=n>image_data</span><span class=p>))</span>
<a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a>
<a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a>        <span class=c1># Check result</span>
<a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a>        <span class=n>status</span> <span class=o>=</span> <span class=n>scan_result</span><span class=p>[</span><span class=s1>&#39;stream&#39;</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
<a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a>        <span class=k>if</span> <span class=n>status</span> <span class=o>==</span> <span class=s1>&#39;OK&#39;</span><span class=p>:</span>
<a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a>            <span class=k>return</span> <span class=kc>True</span>
<a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a>        <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Malware scan detected: </span><span class=si>{</span><span class=n>status</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a>            <span class=k>return</span> <span class=kc>False</span>
<a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Malware scan error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a>        <span class=c1># Fail open or closed based on config</span>
<a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a>        <span class=k>return</span> <span class=ow>not</span> <span class=n>Config</span><span class=o>.</span><span class=n>FAIL_CLOSED_ON_SCAN_ERROR</span>
</code></pre></div> <h2 id=6-performance-optimization>6. Performance Optimization<a class=headerlink href=#6-performance-optimization title="Permanent link">&para;</a></h2> <h3 id=61-image-processing-caching>6.1 Image Processing Caching<a class=headerlink href=#61-image-processing-caching title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_processed_image</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_hash</span><span class=p>,</span> <span class=n>target_model</span><span class=p>):</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Get processed image from cache or process it&quot;&quot;&quot;</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    <span class=n>cache_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;image:processed:</span><span class=si>{</span><span class=n>image_hash</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>target_model</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>    <span class=c1># Check cache</span>
<a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>    <span class=n>cached</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cache_key</span><span class=p>)</span>
<a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>    <span class=k>if</span> <span class=n>cached</span><span class=p>:</span>
<a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>        <span class=k>return</span> <span class=n>pickle</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>cached</span><span class=p>)</span>
<a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>
<a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>    <span class=c1># Process image if not cached</span>
<a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>    <span class=n>original</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_original_image</span><span class=p>(</span><span class=n>image_hash</span><span class=p>)</span>
<a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>original</span><span class=p>:</span>
<a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>        <span class=k>return</span> <span class=kc>None</span>
<a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a>
<a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>    <span class=c1># Process for target model</span>
<a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a>    <span class=n>processed</span><span class=p>,</span> <span class=n>context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform_for_model</span><span class=p>(</span><span class=n>original</span><span class=p>,</span> <span class=n>target_model</span><span class=p>)</span>
<a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a>
<a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>    <span class=c1># Cache processed version</span>
<a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span>
<a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a>        <span class=n>cache_key</span><span class=p>,</span>
<a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a>        <span class=n>Config</span><span class=o>.</span><span class=n>IMAGE_CACHE_TTL</span><span class=p>,</span>
<a id=__codelineno-12-22 name=__codelineno-12-22 href=#__codelineno-12-22></a>        <span class=n>pickle</span><span class=o>.</span><span class=n>dumps</span><span class=p>((</span><span class=n>processed</span><span class=p>,</span> <span class=n>context</span><span class=p>))</span>
<a id=__codelineno-12-23 name=__codelineno-12-23 href=#__codelineno-12-23></a>    <span class=p>)</span>
<a id=__codelineno-12-24 name=__codelineno-12-24 href=#__codelineno-12-24></a>
<a id=__codelineno-12-25 name=__codelineno-12-25 href=#__codelineno-12-25></a>    <span class=k>return</span> <span class=n>processed</span><span class=p>,</span> <span class=n>context</span>
</code></pre></div> <h3 id=62-image-compression-strategies>6.2 Image Compression Strategies<a class=headerlink href=#62-image-compression-strategies title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>optimize_for_bandwidth</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_data</span><span class=p>,</span> <span class=n>context</span><span class=p>):</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Optimize image based on network conditions&quot;&quot;&quot;</span>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>    <span class=c1># Get network context</span>
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>    <span class=n>bandwidth</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;bandwidth&quot;</span><span class=p>,</span> <span class=s2>&quot;high&quot;</span><span class=p>)</span>
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>    <span class=k>if</span> <span class=n>bandwidth</span> <span class=o>==</span> <span class=s2>&quot;low&quot;</span><span class=p>:</span>
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>        <span class=c1># Aggressive optimization for low bandwidth</span>
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_apply_transformations</span><span class=p>(</span><span class=n>image_data</span><span class=p>,</span> <span class=p>[</span>
<a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_resize_image</span><span class=p>(</span><span class=n>max_dimension</span><span class=o>=</span><span class=mi>384</span><span class=p>),</span>
<a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_convert_format</span><span class=p>(</span><span class=n>target_format</span><span class=o>=</span><span class=s2>&quot;jpeg&quot;</span><span class=p>,</span> <span class=n>quality</span><span class=o>=</span><span class=mi>65</span><span class=p>)</span>
<a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>        <span class=p>])</span>
<a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a>    <span class=k>elif</span> <span class=n>bandwidth</span> <span class=o>==</span> <span class=s2>&quot;medium&quot;</span><span class=p>:</span>
<a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a>        <span class=c1># Moderate optimization</span>
<a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_apply_transformations</span><span class=p>(</span><span class=n>image_data</span><span class=p>,</span> <span class=p>[</span>
<a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_resize_image</span><span class=p>(</span><span class=n>max_dimension</span><span class=o>=</span><span class=mi>512</span><span class=p>),</span>
<a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_convert_format</span><span class=p>(</span><span class=n>target_format</span><span class=o>=</span><span class=s2>&quot;jpeg&quot;</span><span class=p>,</span> <span class=n>quality</span><span class=o>=</span><span class=mi>75</span><span class=p>)</span>
<a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a>        <span class=p>])</span>
<a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a>        <span class=c1># High bandwidth - minimal optimization</span>
<a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_apply_transformations</span><span class=p>(</span><span class=n>image_data</span><span class=p>,</span> <span class=p>[</span>
<a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_resize_image</span><span class=p>(</span><span class=n>max_dimension</span><span class=o>=</span><span class=mi>768</span><span class=p>),</span>
<a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_convert_format</span><span class=p>(</span><span class=n>target_format</span><span class=o>=</span><span class=s2>&quot;jpeg&quot;</span><span class=p>,</span> <span class=n>quality</span><span class=o>=</span><span class=mi>85</span><span class=p>)</span>
<a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a>        <span class=p>])</span>
</code></pre></div> <h2 id=7-integration-with-llm-pipeline>7. Integration with LLM Pipeline<a class=headerlink href=#7-integration-with-llm-pipeline title="Permanent link">&para;</a></h2> <h3 id=71-multimodal-message-construction>7.1 Multimodal Message Construction<a class=headerlink href=#71-multimodal-message-construction title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>def</span><span class=w> </span><span class=nf>construct_multimodal_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text_query</span><span class=p>,</span> <span class=n>image_data</span><span class=p>,</span> <span class=n>model</span><span class=p>):</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Construct multimodal message for different backends&quot;&quot;&quot;</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>    <span class=k>if</span> <span class=n>model</span> <span class=o>==</span> <span class=s2>&quot;gemini-thinking&quot;</span><span class=p>:</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>        <span class=c1># Gemini API format</span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>        <span class=k>return</span> <span class=p>{</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>            <span class=s2>&quot;contents&quot;</span><span class=p>:</span> <span class=p>[</span>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a>                <span class=p>{</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a>                    <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>                    <span class=s2>&quot;parts&quot;</span><span class=p>:</span> <span class=p>[</span>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a>                        <span class=p>{</span><span class=s2>&quot;text&quot;</span><span class=p>:</span> <span class=n>text_query</span><span class=p>},</span>
<a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a>                        <span class=p>{</span><span class=s2>&quot;inline_data&quot;</span><span class=p>:</span> <span class=p>{</span>
<a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>                            <span class=s2>&quot;mime_type&quot;</span><span class=p>:</span> <span class=s2>&quot;image/jpeg&quot;</span><span class=p>,</span>
<a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a>                            <span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>encode_image_for_api</span><span class=p>(</span><span class=n>image_data</span><span class=p>,</span> <span class=n>prefix</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a>                        <span class=p>}}</span>
<a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a>                    <span class=p>]</span>
<a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a>                <span class=p>}</span>
<a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a>            <span class=p>]</span>
<a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a>        <span class=p>}</span>
<a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a>    <span class=k>elif</span> <span class=n>model</span> <span class=o>==</span> <span class=s2>&quot;llava&quot;</span><span class=p>:</span>
<a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a>        <span class=c1># Ollama format for LLaVA</span>
<a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a>        <span class=k>return</span> <span class=p>{</span>
<a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a>            <span class=s2>&quot;model&quot;</span><span class=p>:</span> <span class=n>Config</span><span class=o>.</span><span class=n>LLAVA_MODEL</span><span class=p>,</span>
<a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a>            <span class=s2>&quot;prompt&quot;</span><span class=p>:</span> <span class=n>text_query</span><span class=p>,</span>
<a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a>            <span class=s2>&quot;images&quot;</span><span class=p>:</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>encode_image_for_api</span><span class=p>(</span><span class=n>image_data</span><span class=p>,</span> <span class=n>prefix</span><span class=o>=</span><span class=kc>False</span><span class=p>)]</span>
<a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a>        <span class=p>}</span>
<a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a>        <span class=c1># Default format</span>
<a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a>        <span class=k>return</span> <span class=p>{</span>
<a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a>            <span class=s2>&quot;query&quot;</span><span class=p>:</span> <span class=n>text_query</span><span class=p>,</span>
<a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a>            <span class=s2>&quot;image&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>encode_image_for_api</span><span class=p>(</span><span class=n>image_data</span><span class=p>)</span>
<a id=__codelineno-14-31 name=__codelineno-14-31 href=#__codelineno-14-31></a>        <span class=p>}</span>
</code></pre></div> <h2 id=8-error-handling>8. Error Handling<a class=headerlink href=#8-error-handling title="Permanent link">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>class</span><span class=w> </span><span class=nc>ImageProcessingError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Base class for image processing errors&quot;&quot;&quot;</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>    <span class=k>pass</span>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=k>class</span><span class=w> </span><span class=nc>InvalidImageError</span><span class=p>(</span><span class=n>ImageProcessingError</span><span class=p>):</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Invalid image data or format&quot;&quot;&quot;</span>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>    <span class=k>pass</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=k>class</span><span class=w> </span><span class=nc>ImageTooLargeError</span><span class=p>(</span><span class=n>ImageProcessingError</span><span class=p>):</span>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Image exceeds size limits&quot;&quot;&quot;</span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>    <span class=k>pass</span>
<a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a>
<a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=k>class</span><span class=w> </span><span class=nc>ProcessingFailedError</span><span class=p>(</span><span class=n>ImageProcessingError</span><span class=p>):</span>
<a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Generic processing failure&quot;&quot;&quot;</span>
<a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a>    <span class=k>pass</span>
<a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a>
<a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>handle_processing_error</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>error</span><span class=p>,</span> <span class=n>image_context</span><span class=p>):</span>
<a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Handle image processing errors gracefully&quot;&quot;&quot;</span>
<a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>error</span><span class=p>,</span> <span class=n>InvalidImageError</span><span class=p>):</span>
<a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a>        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=s2>&quot;Invalid image format or corrupted data&quot;</span><span class=p>}</span>
<a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a>    <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>error</span><span class=p>,</span> <span class=n>ImageTooLargeError</span><span class=p>):</span>
<a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a>        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Image too large. Maximum size: </span><span class=si>{</span><span class=n>Config</span><span class=o>.</span><span class=n>MAX_IMAGE_SIZE</span><span class=o>/</span><span class=mi>1024</span><span class=o>/</span><span class=mi>1024</span><span class=si>}</span><span class=s2>MB&quot;</span><span class=p>}</span>
<a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a>    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a>        <span class=c1># Log unexpected errors</span>
<a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Image processing error: </span><span class=si>{</span><span class=n>error</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a>        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=s2>&quot;Failed to process image&quot;</span><span class=p>}</span>
</code></pre></div> <h2 id=9-future-enhancements>9. Future Enhancements<a class=headerlink href=#9-future-enhancements title="Permanent link">&para;</a></h2> <p>The image processing pipeline roadmap includes:</p> <ol> <li><strong>Content-Aware Processing</strong>: Adjusting processing based on image content (text, faces, etc.)</li> <li><strong>Progressive Image Loading</strong>: Sending low-res versions first, then upgrading</li> <li><strong>Format-Specific Optimizations</strong>: Custom processing for WebP, AVIF, etc.</li> <li><strong>ML-Based Image Analysis</strong>: Pre-classification of images before sending to LLMs</li> <li><strong>Animated GIF/WebP Support</strong>: Handling of animated content</li> </ol> <p>This image processing pipeline provides Opossum Search with robust multimodal capabilities while ensuring optimal performance, security, and compatibility with various LLM backends.</p> </div> </div><footer> <div class=rst-footer-buttons role=navigation aria-label="Footer Navigation"> <a href=../redis-caching-architecture/ class="btn btn-neutral float-left" title="Redis Caching"><span class="icon icon-circle-arrow-left"></span> Previous</a> <a href=../opentelemetry-integration/ class="btn btn-neutral float-right" title=OpenTelemetry>Next <span class="icon icon-circle-arrow-right"></span></a> </div> <hr> <div role=contentinfo> <!-- Copyright etc --> </div> Built with <a href=https://www.mkdocs.org/ >MkDocs</a> using a <a href=https://github.com/readthedocs/sphinx_rtd_theme>theme</a> provided by <a href=https://readthedocs.org>Read the Docs</a>. </footer> </div> </div> </section> </div> <div class=rst-versions role=note aria-label=Versions> <span class=rst-current-version data-toggle=rst-current-version> <span><a href=../redis-caching-architecture/ style="color: #fcfcfc">&laquo; Previous</a></span> <span><a href=../opentelemetry-integration/ style="color: #fcfcfc">Next &raquo;</a></span> </span> </div> <script src=../../js/jquery-3.6.0.min.js></script> <script>var base_url = "../..";</script> <script src=../../js/theme_extra.js></script> <script src=../../js/theme.js></script> <script src=../../search/main.js></script> <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script> </body> </html> 