<!DOCTYPE html>
<html class="writer-html5" lang="en"> <head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="bebo" name="author"/><link href="../../img/favicon.ico" rel="shortcut icon"/><title>Response Generation - Opossum Search Documentation</title><link href="../../css/theme.css" rel="stylesheet"/><link href="../../css/theme_extra.css" rel="stylesheet"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/><script>
        // Current page data
        var mkdocs_page_name = "Response Generation";
        var mkdocs_page_input_path = "conversation\\response-generation.md";
        var mkdocs_page_url = null;
      </script><!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script><script>hljs.highlightAll();</script></head> <body class="wy-body-for-nav" role="document"> <div class="wy-grid-for-nav"> <nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift"> <div class="wy-side-scroll"> <div class="wy-side-nav-search"> <a class="icon icon-home" href="../.."> Opossum Search Documentation </a><div role="search"> <form action="../../search.html" class="wy-form" id="rtd-search-form" method="get"> <input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/> </form> </div> </div> <div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation"> <ul> <li class="toctree-l1"><a class="reference internal" href="../..">Home</a> </li> </ul> <p class="caption"><span class="caption-text">Technical &amp; Development</span></p> <ul> <li class="toctree-l1"><a class="reference internal">Architecture</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/system-architecture-overview/">System Architecture Overview</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Core Components</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/redis-caching-architecture/">Redis Caching Architecture</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/hybrid-model-selection/">Hybrid Model Selection</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/image-processing-pipeline/">Image Processing Pipeline</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/graphql-api/">GraphQL API</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/opentelemetry-integration/">OpenTelemetry Integration</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/svg-markup/">SVG Markup</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/devops-guide/">DevOps Guide</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Development Workflow</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/getting-started/">Getting Started</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Operations</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/security-model/">Security Model</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/error-handling-resilience/">Error Handling &amp; Resilience</a> </li> </ul> </li> </ul> <p class="caption"><span class="caption-text">Service Availability</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/context-and-scope/">Context and Scope</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/quality-requirements/">Quality Requirements</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/architecture-constraints/">Architecture Constraints</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/availability-monitoring/">Availability Monitoring</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/service-outage/">Error Handling</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/rate-limiting-throttling/">Rate Limiting</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/log-alerts/">Logging and Alerts</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/testing-validation/">Testing and Validation</a> </li> </ul> <p class="caption"><span class="caption-text">Conversation Management</span></p> <ul class="current"> <li class="toctree-l1"><a class="reference internal" href="../topic-detection/">Topic Detection</a> </li> <li class="toctree-l1"><a class="reference internal" href="../conversation-flow/">Conversation Flow</a> </li> <li class="toctree-l1 current"><a class="reference internal current" href="#">Response Generation</a> <ul class="current"> <li class="toctree-l2"><a class="reference internal" href="#core-components">Core Components</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#responsegenerator">ResponseGenerator</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#engagement-management">Engagement Management</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#reengagement-prompts">Reengagement Prompts</a> </li> <li class="toctree-l3"><a class="reference internal" href="#engagement-detection">Engagement Detection</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#context-aware-generation">Context-Aware Generation</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#prompt-creation">Prompt Creation</a> </li> <li class="toctree-l3"><a class="reference internal" href="#response-assembly">Response Assembly</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#integration-with-model-backends">Integration with Model Backends</a> </li> <li class="toctree-l2"><a class="reference internal" href="#performance-considerations">Performance Considerations</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#caching-strategy">Caching Strategy</a> </li> <li class="toctree-l3"><a class="reference internal" href="#response-times">Response Times</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#error-handling">Error Handling</a> </li> <li class="toctree-l2"><a class="reference internal" href="#monitoring-and-metrics">Monitoring and Metrics</a> </li> <li class="toctree-l2"><a class="reference internal" href="#example-flow">Example Flow</a> </li> <li class="toctree-l2"><a class="reference internal" href="#sample-code">Sample Code</a> </li> <li class="toctree-l2"><a class="reference internal" href="#re-engagement-strategies">Re-engagement Strategies</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal" href="../nlp-components/">NLP Components</a> </li> <li class="toctree-l1"><a class="reference internal" href="../markov-generation/">Markov Chain Text</a> </li> </ul> <p class="caption"><span class="caption-text">Image Processing</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/overview/">Overview</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/effects/">Effects and Filters</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/svg-generation/">SVG Generation</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/optimization/">Performance Optimization</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/caching/">Caching Strategy</a> </li> </ul> <p class="caption"><span class="caption-text">Model Integration</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../model-integration/architecture/">Architecture</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../model-integration/backend-selection/">Backend Selection</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../model-integration/capability-matrix/">Capability Matrix</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../model-integration/providers/">Provider Integration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../model-integration/configuration/">Model Configuration</a> </li> </ul> <p class="caption"><span class="caption-text">API Reference</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../api/getting-started/">Getting Started</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/routes/">Routes</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/oauth-configuration/">OAuth Configuration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/request-response/">Request/Response</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/error-codes/">Error Codes</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/rate-limits/">Rate Limits</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/webhooks/">Webhook Integration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/health-endpoints/">Health Endpoints</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/compliance/">Compliance</a> </li> </ul> <p class="caption"><span class="caption-text">Features</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../features/national-day/">Opossum National Day</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/easter-eggs/">Easter Eggs</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/special-events/">Special Events</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/background-stories/">Background Stories</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/service-vizualizations/">Service Visualizations</a> </li> </ul> <p class="caption"><span class="caption-text">About</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../about/history/">Project History</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/team/">Team</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/roadmap/">Roadmap</a> </li> </ul> <p class="caption"><span class="caption-text">Infrastructure</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../infrastructure/optimization-strategies/">Optimization Strategies</a> </li> </ul> </div> </div> </nav> <section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"> <nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation"> <i class="fa fa-bars" data-toggle="wy-nav-top"></i> <a href="../..">Opossum Search Documentation</a> </nav> <div class="wy-nav-content"> <div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation"> <ul class="wy-breadcrumbs"> <li><a aria-label="Docs" class="icon icon-home" href="../.."></a></li> <li class="breadcrumb-item">Conversation Management</li> <li class="breadcrumb-item active">Response Generation</li> <li class="wy-breadcrumbs-aside"> </li> </ul> <hr/> </div> <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main"> <div class="section" itemprop="articleBody"> <h1 id="response-generation">Response Generation<a class="headerlink" href="#response-generation" title="Permanent link">¶</a></h1> <p>The response generation system combines sentiment analysis, conversation state, and model backend selection to generate contextually appropriate responses.</p> <h2 id="core-components">Core Components<a class="headerlink" href="#core-components" title="Permanent link">¶</a></h2> <h3 id="responsegenerator">ResponseGenerator<a class="headerlink" href="#responsegenerator" title="Permanent link">¶</a></h3> <p>The <code>ResponseGenerator</code> class orchestrates: - Topic-aware prompt creation - Sentiment-based response adjustment - Engagement monitoring and reengagement - Backend model selection</p> <h2 id="engagement-management">Engagement Management<a class="headerlink" href="#engagement-management" title="Permanent link">¶</a></h2> <p>The system maintains user engagement through:</p> <h3 id="reengagement-prompts">Reengagement Prompts<a class="headerlink" href="#reengagement-prompts" title="Permanent link">¶</a></h3> <div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="n">reengagement_prompts</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="s2">"snake_resistance"</span><span class="p">:</span> <span class="p">[</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="s2">"Would you like to know more about how opossums handle encounters with snakes?"</span><span class="p">,</span>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="s2">"Did you know opossums have fascinating adaptations for dealing with venomous snakes?"</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="p">],</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="s2">"diet_query"</span><span class="p">:</span> <span class="p">[</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="s2">"I know some interesting facts about opossum dietary preferences."</span><span class="p">,</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="s2">"Would you like to learn about the unique things opossums eat?"</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>    <span class="p">]</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="c1"># ... other topic-specific prompts</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">}</span>
</code></pre></div> <h3 id="engagement-detection">Engagement Detection<a class="headerlink" href="#engagement-detection" title="Permanent link">¶</a></h3> <ul> <li>Monitors message length</li> <li>Tracks sentiment trends</li> <li>Identifies follow-up questions</li> <li>Measures topic coherence</li> </ul> <h2 id="context-aware-generation">Context-Aware Generation<a class="headerlink" href="#context-aware-generation" title="Permanent link">¶</a></h2> <h3 id="prompt-creation">Prompt Creation<a class="headerlink" href="#prompt-creation" title="Permanent link">¶</a></h3> <p>The system builds prompts that include: 1. Current conversation stage 2. Recent message history 3. User sentiment analysis 4. Topic relevance scores</p> <p>Example prompt structure: <div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>Current topic: {conversation_state.current_stage}
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>User sentiment: {sentiment_analysis['sentiment']['polarity']}
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>Recent context:
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>{context_window}
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>User message: {user_message}
</code></pre></div></p> <h3 id="response-assembly">Response Assembly<a class="headerlink" href="#response-assembly" title="Permanent link">¶</a></h3> <ol> <li>Base response generation from model</li> <li>Engagement prompt addition when needed</li> <li>Message history updates</li> <li>Metadata attachment</li> </ol> <h2 id="integration-with-model-backends">Integration with Model Backends<a class="headerlink" href="#integration-with-model-backends" title="Permanent link">¶</a></h2> <p>The response generator works with multiple model backends:</p> <ol> <li><strong>Gemini Backend</strong></li> <li>High-capability responses</li> <li>Multimodal processing</li> <li> <p>Advanced reasoning</p> </li> <li> <p><strong>Ollama Backend</strong></p> </li> <li>Local processing</li> <li>Custom model support</li> <li> <p>Efficient response generation</p> </li> <li> <p><strong>Transformers Backend</strong></p> </li> <li>Fallback capability</li> <li>Offline operation</li> <li>Basic response generation</li> </ol> <h2 id="performance-considerations">Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permanent link">¶</a></h2> <h3 id="caching-strategy">Caching Strategy<a class="headerlink" href="#caching-strategy" title="Permanent link">¶</a></h3> <ul> <li>Caches complete responses</li> <li>Stores sentiment analysis</li> <li>Preserves context windows</li> </ul> <h3 id="response-times">Response Times<a class="headerlink" href="#response-times" title="Permanent link">¶</a></h3> <table> <thead> <tr> <th>Operation</th> <th>Target Time</th> </tr> </thead> <tbody> <tr> <td>Basic Response</td> <td>&lt; 1s</td> </tr> <tr> <td>With Context</td> <td>&lt; 2s</td> </tr> <tr> <td>With Image</td> <td>&lt; 3s</td> </tr> </tbody> </table> <h2 id="error-handling">Error Handling<a class="headerlink" href="#error-handling" title="Permanent link">¶</a></h2> <ol> <li> <p><strong>Graceful Degradation</strong> <div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">if</span> <span class="n">sentiment_tracker</span><span class="o">.</span><span class="n">get_engagement_summary</span><span class="p">()[</span><span class="s2">"needs_reengagement"</span><span class="p">]:</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span class="n">response_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_engagement_prompt</span><span class="p">(</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>        <span class="n">response_text</span><span class="p">,</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>        <span class="n">next_stage</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>    <span class="p">)</span>
</code></pre></div></p> </li> <li> <p><strong>Fallback Responses</strong></p> </li> <li>Default to simpler responses</li> <li>Preserve conversation context</li> <li>Maintain user engagement</li> </ol> <h2 id="monitoring-and-metrics">Monitoring and Metrics<a class="headerlink" href="#monitoring-and-metrics" title="Permanent link">¶</a></h2> <p>The system tracks: - Response generation times - Engagement success rates - Sentiment trends - Topic transition effectiveness</p> <h2 id="example-flow">Example Flow<a class="headerlink" href="#example-flow" title="Permanent link">¶</a></h2> <pre class="mermaid"><code>graph TD
    A[User Input] --&gt; B[Context Assembly]
    B --&gt; C[Sentiment Analysis]
    C --&gt; D[Topic Detection]
    D --&gt; E[Prompt Creation]
    E --&gt; F[Model Generation]
    F --&gt; G[Engagement Check]
    G --&gt; H[Response Assembly]
    H --&gt; I[Final Response]
</code></pre> <h2 id="sample-code">Sample Code<a class="headerlink" href="#sample-code" title="Permanent link">¶</a></h2> <div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_response</span><span class="p">(</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a>    <span class="bp">self</span><span class="p">,</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="n">user_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="n">conversation_state</span><span class="p">:</span> <span class="n">ConversationState</span><span class="p">,</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>    <span class="n">sentiment_tracker</span><span class="p">:</span> <span class="n">SentimentTracker</span><span class="p">,</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>    <span class="n">model_backend</span><span class="p">:</span> <span class="n">Any</span>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="c1"># Analyze message sentiment</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="n">sentiment_analysis</span> <span class="o">=</span> <span class="n">sentiment_tracker</span><span class="o">.</span><span class="n">analyze_message</span><span class="p">(</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>        <span class="n">user_message</span><span class="p">,</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_is_follow_up</span><span class="p">(</span><span class="n">user_message</span><span class="p">)</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="p">)</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="c1"># Determine next conversation stage</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>    <span class="n">next_stage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topic_detector</span><span class="o">.</span><span class="n">determine_next_stage</span><span class="p">(</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>        <span class="n">user_message</span><span class="p">,</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>        <span class="n">conversation_state</span><span class="o">.</span><span class="n">current_stage</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>    <span class="p">)</span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>    <span class="c1"># Update conversation state</span>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>    <span class="n">conversation_state</span><span class="o">.</span><span class="n">update_stage</span><span class="p">(</span><span class="n">next_stage</span><span class="p">)</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>    <span class="c1"># Generate base response</span>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>    <span class="n">base_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_prompt</span><span class="p">(</span>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>        <span class="n">user_message</span><span class="p">,</span>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>        <span class="n">conversation_state</span><span class="p">,</span>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>        <span class="n">sentiment_analysis</span>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>    <span class="p">)</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>    <span class="n">response_text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">model_backend</span><span class="o">.</span><span class="n">generate_response</span><span class="p">(</span>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>        <span class="n">base_prompt</span><span class="p">,</span>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>        <span class="n">next_stage</span>
<a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>    <span class="p">)</span>
<a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>
<a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>    <span class="c1"># Add engagement prompts if needed</span>
<a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>    <span class="k">if</span> <span class="n">sentiment_tracker</span><span class="o">.</span><span class="n">get_engagement_summary</span><span class="p">()[</span><span class="s2">"needs_reengagement"</span><span class="p">]:</span>
<a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>        <span class="n">response_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_engagement_prompt</span><span class="p">(</span>
<a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>            <span class="n">response_text</span><span class="p">,</span>
<a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>            <span class="n">next_stage</span>
<a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a>        <span class="p">)</span>
<a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a>
<a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>    <span class="c1"># Record the interaction</span>
<a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>    <span class="n">conversation_state</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a>
<a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>    <span class="k">return</span> <span class="p">{</span>
<a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>        <span class="s2">"response"</span><span class="p">:</span> <span class="n">response_text</span><span class="p">,</span>
<a href="#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a>        <span class="s2">"next_stage"</span><span class="p">:</span> <span class="n">next_stage</span><span class="p">,</span>
<a href="#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a>        <span class="s2">"sentiment"</span><span class="p">:</span> <span class="n">sentiment_analysis</span><span class="p">,</span>
<a href="#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a>        <span class="s2">"needs_reengagement"</span><span class="p">:</span> <span class="n">sentiment_tracker</span><span class="o">.</span><span class="n">get_engagement_summary</span><span class="p">()[</span><span class="s2">"needs_reengagement"</span><span class="p">]</span>
<a href="#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a>    <span class="p">}</span>
</code></pre></div> <h2 id="re-engagement-strategies">Re-engagement Strategies<a class="headerlink" href="#re-engagement-strategies" title="Permanent link">¶</a></h2> <p>The system can detect waning user interest and automatically add re-engagement prompts:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">_add_engagement_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="sd">"""Add an engagement prompt to the response if appropriate."""</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>    <span class="k">if</span> <span class="n">stage</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reengagement_prompts</span><span class="p">:</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>        <span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reengagement_prompts</span><span class="p">[</span><span class="n">stage</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">"</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>    <span class="k">return</span> <span class="n">response</span>
</code></pre></div> </div> </div><footer> <div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation"> <a class="btn btn-neutral float-left" href="../conversation-flow/" title="Conversation Flow"><span class="icon icon-circle-arrow-left"></span> Previous</a> <a class="btn btn-neutral float-right" href="../nlp-components/" title="NLP Components">Next <span class="icon icon-circle-arrow-right"></span></a> </div> <hr/> <div role="contentinfo"> <!-- Copyright etc --> </div> Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. </footer> </div> </div> </section> </div> <div aria-label="Versions" class="rst-versions" role="note"> <span class="rst-current-version" data-toggle="rst-current-version"> <span><a href="../conversation-flow/" style="color: #fcfcfc">« Previous</a></span> <span><a href="../nlp-components/" style="color: #fcfcfc">Next »</a></span> </span> </div> <script src="../../js/jquery-3.6.0.min.js"></script> <script>var base_url = "../..";</script> <script src="../../js/theme_extra.js"></script> <script src="../../js/theme.js"></script> <script src="../../search/main.js"></script> <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script> <script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body> </html> 