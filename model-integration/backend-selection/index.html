<!DOCTYPE html>
<html class="writer-html5" lang="en"> <head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="bebo" name="author"/><link href="../../img/favicon.ico" rel="shortcut icon"/><title>Backend Selection - Opossum Search Documentation</title><link href="../../css/theme.css" rel="stylesheet"/><link href="../../css/theme_extra.css" rel="stylesheet"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/><script>
        // Current page data
        var mkdocs_page_name = "Backend Selection";
        var mkdocs_page_input_path = "model-integration\\backend-selection.md";
        var mkdocs_page_url = null;
      </script><!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script><script>hljs.highlightAll();</script></head> <body class="wy-body-for-nav" role="document"> <div class="wy-grid-for-nav"> <nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift"> <div class="wy-side-scroll"> <div class="wy-side-nav-search"> <a class="icon icon-home" href="../.."> Opossum Search Documentation </a><div role="search"> <form action="../../search.html" class="wy-form" id="rtd-search-form" method="get"> <input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/> </form> </div> </div> <div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation"> <ul> <li class="toctree-l1"><a class="reference internal" href="../..">Home</a> </li> </ul> <p class="caption"><span class="caption-text">Technical &amp; Development</span></p> <ul> <li class="toctree-l1"><a class="reference internal">Architecture</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/system-architecture-overview/">System Architecture Overview</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Core Components</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/redis-caching-architecture/">Redis Caching Architecture</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/hybrid-model-selection/">Hybrid Model Selection</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/image-processing-pipeline/">Image Processing Pipeline</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/graphql-api/">GraphQL API</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/opentelemetry-integration/">OpenTelemetry Integration</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/svg-markup/">SVG Markup</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/devops-guide/">DevOps Guide</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Development Workflow</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/getting-started/">Getting Started</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Operations</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/security-model/">Security Model</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/error-handling-resilience/">Error Handling &amp; Resilience</a> </li> </ul> </li> </ul> <p class="caption"><span class="caption-text">Service Availability</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/context-and-scope/">Context and Scope</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/quality-requirements/">Quality Requirements</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/architecture-constraints/">Architecture Constraints</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/availability-monitoring/">Availability Monitoring</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/service-outage/">Error Handling</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/rate-limiting-throttling/">Rate Limiting</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/log-alerts/">Logging and Alerts</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/testing-validation/">Testing and Validation</a> </li> </ul> <p class="caption"><span class="caption-text">Conversation Management</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../conversation/topic-detection/">Topic Detection</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../conversation/conversation-flow/">Conversation Flow</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../conversation/response-generation/">Response Generation</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../conversation/nlp-components/">NLP Components</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../conversation/markov-generation/">Markov Chain Text</a> </li> </ul> <p class="caption"><span class="caption-text">Image Processing</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/overview/">Overview</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/effects/">Effects and Filters</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/svg-generation/">SVG Generation</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/optimization/">Performance Optimization</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/caching/">Caching Strategy</a> </li> </ul> <p class="caption"><span class="caption-text">Model Integration</span></p> <ul class="current"> <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a> </li> <li class="toctree-l1 current"><a class="reference internal current" href="#">Backend Selection</a> <ul class="current"> <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a> </li> <li class="toctree-l2"><a class="reference internal" href="#selection-process">Selection Process</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#request-analysis">Request Analysis</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#scoring-system">Scoring System</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#capability-matching">Capability Matching</a> </li> <li class="toctree-l3"><a class="reference internal" href="#performance-considerations">Performance Considerations</a> </li> <li class="toctree-l3"><a class="reference internal" href="#cost-optimization">Cost Optimization</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#selection-algorithm">Selection Algorithm</a> </li> <li class="toctree-l2"><a class="reference internal" href="#fallback-mechanism">Fallback Mechanism</a> </li> <li class="toctree-l2"><a class="reference internal" href="#decision-factors">Decision Factors</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#1-capability-requirements">1. Capability Requirements</a> </li> <li class="toctree-l3"><a class="reference internal" href="#2-service-characteristics">2. Service Characteristics</a> </li> <li class="toctree-l3"><a class="reference internal" href="#3-operational-factors">3. Operational Factors</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#selection-examples">Selection Examples</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#example-1-general-knowledge-query">Example 1: General Knowledge Query</a> </li> <li class="toctree-l3"><a class="reference internal" href="#example-2-image-analysis-with-unavailable-primary">Example 2: Image Analysis with Unavailable Primary</a> </li> <li class="toctree-l3"><a class="reference internal" href="#example-3-complex-code-analysis">Example 3: Complex Code Analysis</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#configuration-options">Configuration Options</a> </li> <li class="toctree-l2"><a class="reference internal" href="#monitoring-and-telemetry">Monitoring and Telemetry</a> </li> <li class="toctree-l2"><a class="reference internal" href="#related-documentation">Related Documentation</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal" href="../capability-matrix/">Capability Matrix</a> </li> <li class="toctree-l1"><a class="reference internal" href="../providers/">Provider Integration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../configuration/">Model Configuration</a> </li> </ul> <p class="caption"><span class="caption-text">API Reference</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../api/getting-started/">Getting Started</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/routes/">Routes</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/oauth-configuration/">OAuth Configuration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/request-response/">Request/Response</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/error-codes/">Error Codes</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/rate-limits/">Rate Limits</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/webhooks/">Webhook Integration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/health-endpoints/">Health Endpoints</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/compliance/">Compliance</a> </li> </ul> <p class="caption"><span class="caption-text">Features</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../features/national-day/">Opossum National Day</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/easter-eggs/">Easter Eggs</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/special-events/">Special Events</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/background-stories/">Background Stories</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/service-vizualizations/">Service Visualizations</a> </li> </ul> <p class="caption"><span class="caption-text">About</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../about/history/">Project History</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/team/">Team</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/roadmap/">Roadmap</a> </li> </ul> <p class="caption"><span class="caption-text">Infrastructure</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../infrastructure/optimization-strategies/">Optimization Strategies</a> </li> </ul> </div> </div> </nav> <section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"> <nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation"> <i class="fa fa-bars" data-toggle="wy-nav-top"></i> <a href="../..">Opossum Search Documentation</a> </nav> <div class="wy-nav-content"> <div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation"> <ul class="wy-breadcrumbs"> <li><a aria-label="Docs" class="icon icon-home" href="../.."></a></li> <li class="breadcrumb-item">Model Integration</li> <li class="breadcrumb-item active">Backend Selection</li> <li class="wy-breadcrumbs-aside"> </li> </ul> <hr/> </div> <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main"> <div class="section" itemprop="articleBody"> <h1 id="backend-selection">Backend Selection<a class="headerlink" href="#backend-selection" title="Permanent link">¶</a></h1> <h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¶</a></h2> <p>Opossum Search implements a sophisticated backend selection system that dynamically chooses the optimal AI model for each request. This selection process considers multiple factors including request characteristics, model capabilities, service availability, and performance requirements to make intelligent routing decisions.</p> <h2 id="selection-process">Selection Process<a class="headerlink" href="#selection-process" title="Permanent link">¶</a></h2> <p>The backend selection process follows this general flow:</p> <pre class="mermaid"><code>flowchart TD
    A[Incoming Request] --&gt; B[Analyze Request]
    B --&gt; C[Extract Capability Requirements]
    C --&gt; D[Check Service Availability]
    D --&gt; E[Score Available Backends]
    E --&gt; F[Select Highest Scoring Backend]
    F --&gt; G[Process Request]
    G --&gt;|Success| H[Return Response]
    G --&gt;|Failure| I[Select Fallback Backend]
    I --&gt; J[Process with Fallback]
    J --&gt; H
</code></pre> <h3 id="request-analysis">Request Analysis<a class="headerlink" href="#request-analysis" title="Permanent link">¶</a></h3> <p>The first step is analyzing the request to determine its characteristics and requirements:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">analyze_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="sd">"""Analyze request to determine capabilities needed"""</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"general_knowledge"</span><span class="p">]</span>  <span class="c1"># Base capability for all requests</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>    <span class="c1"># Check for multimodal content</span>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">has_images</span><span class="p">():</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>        <span class="n">capabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"image_understanding"</span><span class="p">)</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="c1"># Specific image capabilities</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="k">if</span> <span class="n">detect_image_type</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="s2">"chart"</span><span class="p">:</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>            <span class="n">capabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"chart_analysis"</span><span class="p">)</span>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="c1"># Check for code-related queries</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>    <span class="k">if</span> <span class="n">is_code_related</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">):</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="n">capabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"code_understanding"</span><span class="p">)</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="c1"># Specific programming language</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">lang</span> <span class="o">=</span> <span class="n">detect_language</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="k">if</span> <span class="n">lang</span><span class="p">:</span>
<a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>            <span class="n">capabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">lang</span><span class="si">}</span><span class="s2">_expertise"</span><span class="p">)</span>
<a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="c1"># Check for specialized domains</span>
<a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="n">domain</span> <span class="o">=</span> <span class="n">detect_domain</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
<a href="#__codelineno-0-25" id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
<a href="#__codelineno-0-26" id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="n">capabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">_knowledge"</span><span class="p">)</span>
<a href="#__codelineno-0-27" id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a href="#__codelineno-0-28" id="__codelineno-0-28" name="__codelineno-0-28"></a>    <span class="c1"># Check complexity for resource allocation</span>
<a href="#__codelineno-0-29" id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="k">if</span> <span class="n">estimate_complexity</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">COMPLEXITY_THRESHOLD</span><span class="p">:</span>
<a href="#__codelineno-0-30" id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">capabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"high_complexity_handling"</span><span class="p">)</span>
<a href="#__codelineno-0-31" id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a href="#__codelineno-0-32" id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="k">return</span> <span class="n">capabilities</span>
</code></pre></div> <h2 id="scoring-system">Scoring System<a class="headerlink" href="#scoring-system" title="Permanent link">¶</a></h2> <p>The backend selection system uses a weighted scoring approach to rank available backends:</p> <h3 id="capability-matching">Capability Matching<a class="headerlink" href="#capability-matching" title="Permanent link">¶</a></h3> <p>Each backend is scored based on how well it matches the required capabilities:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">score_backend_capabilities</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">required_capabilities</span><span class="p">):</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="sd">"""Score a backend based on capability matching"""</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span class="c1"># Get backend capabilities from the capability matrix</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>    <span class="n">backend_capabilities</span> <span class="o">=</span> <span class="n">capability_matrix</span><span class="o">.</span><span class="n">get_capabilities</span><span class="p">(</span><span class="n">backend_name</span><span class="p">)</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>    <span class="k">for</span> <span class="n">capability</span> <span class="ow">in</span> <span class="n">required_capabilities</span><span class="p">:</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="c1"># Check if backend supports this capability</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="k">if</span> <span class="n">capability</span> <span class="ow">in</span> <span class="n">backend_capabilities</span><span class="p">:</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>            <span class="n">capability_score</span> <span class="o">=</span> <span class="n">capability_matrix</span><span class="o">.</span><span class="n">get_score</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">capability</span><span class="p">)</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>            <span class="n">score</span> <span class="o">+=</span> <span class="n">capability_score</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>            <span class="c1"># Penalize missing critical capabilities</span>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>            <span class="k">if</span> <span class="n">capability</span> <span class="ow">in</span> <span class="n">CRITICAL_CAPABILITIES</span><span class="p">:</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>                <span class="n">score</span> <span class="o">-=</span> <span class="n">CRITICAL_CAPABILITY_PENALTY</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>    <span class="k">return</span> <span class="n">score</span>
</code></pre></div> <h3 id="performance-considerations">Performance Considerations<a class="headerlink" href="#performance-considerations" title="Permanent link">¶</a></h3> <p>Performance characteristics are factored into the selection:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">score_backend_performance</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="sd">"""Score a backend based on performance characteristics"""</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="n">performance_score</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="c1"># Response time considerations</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">requires_low_latency</span><span class="p">():</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>        <span class="n">response_time_score</span> <span class="o">=</span> <span class="n">performance_metrics</span><span class="o">.</span><span class="n">get_response_time_score</span><span class="p">(</span><span class="n">backend_name</span><span class="p">)</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span class="n">performance_score</span> <span class="o">+=</span> <span class="n">LATENCY_WEIGHT</span> <span class="o">*</span> <span class="n">response_time_score</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>    <span class="c1"># Resource efficiency</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_resource_intensive</span><span class="p">():</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>        <span class="n">efficiency_score</span> <span class="o">=</span> <span class="n">performance_metrics</span><span class="o">.</span><span class="n">get_efficiency_score</span><span class="p">(</span><span class="n">backend_name</span><span class="p">)</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="n">performance_score</span> <span class="o">+=</span> <span class="n">EFFICIENCY_WEIGHT</span> <span class="o">*</span> <span class="n">efficiency_score</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>    <span class="c1"># Reliability score based on recent performance</span>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>    <span class="n">reliability_score</span> <span class="o">=</span> <span class="n">performance_metrics</span><span class="o">.</span><span class="n">get_reliability_score</span><span class="p">(</span><span class="n">backend_name</span><span class="p">)</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>    <span class="n">performance_score</span> <span class="o">+=</span> <span class="n">RELIABILITY_WEIGHT</span> <span class="o">*</span> <span class="n">reliability_score</span>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>    <span class="k">return</span> <span class="n">performance_score</span>
</code></pre></div> <h3 id="cost-optimization">Cost Optimization<a class="headerlink" href="#cost-optimization" title="Permanent link">¶</a></h3> <p>For systems with usage-based pricing (like Gemini API), cost factors are considered:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">score_backend_cost</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="sd">"""Score a backend based on cost considerations"""</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="c1"># Base cost for this backend</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>    <span class="n">base_cost</span> <span class="o">=</span> <span class="n">cost_model</span><span class="o">.</span><span class="n">get_base_cost</span><span class="p">(</span><span class="n">backend_name</span><span class="p">)</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="c1"># Estimated tokens for this request</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>    <span class="n">estimated_tokens</span> <span class="o">=</span> <span class="n">estimate_tokens</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="c1"># Calculate estimated cost</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="n">estimated_cost</span> <span class="o">=</span> <span class="n">base_cost</span> <span class="o">*</span> <span class="n">estimated_tokens</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>    <span class="c1"># Convert to score (lower cost = higher score)</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="n">max_cost</span> <span class="o">=</span> <span class="n">cost_model</span><span class="o">.</span><span class="n">get_max_cost</span><span class="p">()</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>    <span class="n">cost_score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">estimated_cost</span> <span class="o">/</span> <span class="n">max_cost</span><span class="p">)</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>    <span class="k">return</span> <span class="n">cost_score</span> <span class="o">*</span> <span class="n">COST_WEIGHT</span>
</code></pre></div> <h2 id="selection-algorithm">Selection Algorithm<a class="headerlink" href="#selection-algorithm" title="Permanent link">¶</a></h2> <p>The core selection algorithm combines multiple factors to choose the optimal backend:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">select_backend</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="sd">"""Select the optimal backend for a request"""</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a>    <span class="c1"># Analyze request</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a>    <span class="n">required_capabilities</span> <span class="o">=</span> <span class="n">analyze_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a>    <span class="c1"># Get available backends</span>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a>    <span class="n">available_backends</span> <span class="o">=</span> <span class="n">service_availability</span><span class="o">.</span><span class="n">get_available_backends</span><span class="p">()</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">available_backends</span><span class="p">:</span>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a>        <span class="c1"># If no backends are available, use local transformers as last resort</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"No backends available, falling back to local transformers"</span><span class="p">)</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a>        <span class="k">return</span> <span class="n">backends</span><span class="p">[</span><span class="s1">'transformers'</span><span class="p">]</span>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a>    <span class="c1"># Score each available backend</span>
<a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a>    <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a>    <span class="k">for</span> <span class="n">backend_name</span> <span class="ow">in</span> <span class="n">available_backends</span><span class="p">:</span>
<a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a>        <span class="c1"># Calculate capability score (weighted highest)</span>
<a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a>        <span class="n">capability_score</span> <span class="o">=</span> <span class="n">score_backend_capabilities</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">required_capabilities</span><span class="p">)</span>
<a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>
<a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a>        <span class="c1"># Calculate performance score</span>
<a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a>        <span class="n">performance_score</span> <span class="o">=</span> <span class="n">score_backend_performance</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a>
<a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="c1"># Calculate cost score if applicable</span>
<a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a>        <span class="n">cost_score</span> <span class="o">=</span> <span class="n">score_backend_cost</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a>
<a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a>        <span class="c1"># Calculate overall score with appropriate weights</span>
<a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a>        <span class="n">scores</span><span class="p">[</span><span class="n">backend_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a>            <span class="n">CAPABILITY_WEIGHT</span> <span class="o">*</span> <span class="n">capability_score</span> <span class="o">+</span>
<a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a>            <span class="n">PERFORMANCE_WEIGHT</span> <span class="o">*</span> <span class="n">performance_score</span> <span class="o">+</span>
<a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a>            <span class="n">COST_WEIGHT</span> <span class="o">*</span> <span class="n">cost_score</span>
<a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a>        <span class="p">)</span>
<a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a>
<a href="#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a>    <span class="c1"># Select backend with highest score</span>
<a href="#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a>    <span class="n">selected_backend</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a href="#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a>
<a href="#__codelineno-4-37" id="__codelineno-4-37" name="__codelineno-4-37"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Selected backend </span><span class="si">{</span><span class="n">selected_backend</span><span class="si">}</span><span class="s2"> with score </span><span class="si">{</span><span class="n">scores</span><span class="p">[</span><span class="n">selected_backend</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-38" id="__codelineno-4-38" name="__codelineno-4-38"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">"All backend scores: </span><span class="si">{</span><span class="n">scores</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-4-39" id="__codelineno-4-39" name="__codelineno-4-39"></a>
<a href="#__codelineno-4-40" id="__codelineno-4-40" name="__codelineno-4-40"></a>    <span class="k">return</span> <span class="n">backends</span><span class="p">[</span><span class="n">selected_backend</span><span class="p">]</span>
</code></pre></div> <h2 id="fallback-mechanism">Fallback Mechanism<a class="headerlink" href="#fallback-mechanism" title="Permanent link">¶</a></h2> <p>When a selected backend fails, the system implements a sophisticated fallback mechanism:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">select_fallback</span><span class="p">(</span><span class="n">failed_backend</span><span class="p">,</span> <span class="n">required_capabilities</span><span class="p">):</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="sd">"""Select a fallback backend when the primary choice fails"""</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a>    <span class="c1"># Define the default fallback chain</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a>    <span class="n">fallback_chain</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a>        <span class="s1">'gemini'</span><span class="p">:</span> <span class="s1">'ollama'</span><span class="p">,</span>
<a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a>        <span class="s1">'ollama'</span><span class="p">:</span> <span class="s1">'transformers'</span><span class="p">,</span>
<a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a>        <span class="s1">'transformers'</span><span class="p">:</span> <span class="s1">'gemini'</span>  <span class="c1"># Circular as last resort</span>
<a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="p">}</span>
<a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a>
<a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a>    <span class="c1"># Try the default fallback if available</span>
<a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a>    <span class="n">next_backend</span> <span class="o">=</span> <span class="n">fallback_chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">failed_backend</span><span class="p">,</span> <span class="s1">'transformers'</span><span class="p">)</span>
<a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a>    <span class="k">if</span> <span class="n">service_availability</span><span class="o">.</span><span class="n">is_available</span><span class="p">(</span><span class="n">next_backend</span><span class="p">):</span>
<a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a>        <span class="k">return</span> <span class="n">backends</span><span class="p">[</span><span class="n">next_backend</span><span class="p">]</span>
<a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>
<a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a>    <span class="c1"># If default fallback isn't available, score remaining backends</span>
<a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a>    <span class="n">available_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">service_availability</span><span class="o">.</span><span class="n">get_available_backends</span><span class="p">()</span> 
<a href="#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a>                         <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">failed_backend</span><span class="p">]</span>
<a href="#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a>
<a href="#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">available_backends</span><span class="p">:</span>
<a href="#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a>        <span class="c1"># If nothing else is available, use transformers as final fallback</span>
<a href="#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a>        <span class="c1"># (assumes transformers can always run locally)</span>
<a href="#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No available fallbacks for </span><span class="si">{</span><span class="n">failed_backend</span><span class="si">}</span><span class="s2">, using transformers as last resort"</span><span class="p">)</span>
<a href="#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a>        <span class="k">return</span> <span class="n">backends</span><span class="p">[</span><span class="s1">'transformers'</span><span class="p">]</span>
<a href="#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a>
<a href="#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a>    <span class="c1"># Score available backends for this specific request</span>
<a href="#__codelineno-5-27" id="__codelineno-5-27" name="__codelineno-5-27"></a>    <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-5-28" id="__codelineno-5-28" name="__codelineno-5-28"></a>    <span class="k">for</span> <span class="n">backend_name</span> <span class="ow">in</span> <span class="n">available_backends</span><span class="p">:</span>
<a href="#__codelineno-5-29" id="__codelineno-5-29" name="__codelineno-5-29"></a>        <span class="n">capability_score</span> <span class="o">=</span> <span class="n">score_backend_capabilities</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">required_capabilities</span><span class="p">)</span>
<a href="#__codelineno-5-30" id="__codelineno-5-30" name="__codelineno-5-30"></a>        <span class="n">scores</span><span class="p">[</span><span class="n">backend_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">capability_score</span>
<a href="#__codelineno-5-31" id="__codelineno-5-31" name="__codelineno-5-31"></a>
<a href="#__codelineno-5-32" id="__codelineno-5-32" name="__codelineno-5-32"></a>    <span class="c1"># Select highest scoring available backend</span>
<a href="#__codelineno-5-33" id="__codelineno-5-33" name="__codelineno-5-33"></a>    <span class="n">selected_fallback</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a href="#__codelineno-5-34" id="__codelineno-5-34" name="__codelineno-5-34"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Selected </span><span class="si">{</span><span class="n">selected_fallback</span><span class="si">}</span><span class="s2"> as fallback for </span><span class="si">{</span><span class="n">failed_backend</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<a href="#__codelineno-5-35" id="__codelineno-5-35" name="__codelineno-5-35"></a>
<a href="#__codelineno-5-36" id="__codelineno-5-36" name="__codelineno-5-36"></a>    <span class="k">return</span> <span class="n">backends</span><span class="p">[</span><span class="n">selected_fallback</span><span class="p">]</span>
</code></pre></div> <h2 id="decision-factors">Decision Factors<a class="headerlink" href="#decision-factors" title="Permanent link">¶</a></h2> <p>The backend selection considers these key factors:</p> <h3 id="1-capability-requirements">1. Capability Requirements<a class="headerlink" href="#1-capability-requirements" title="Permanent link">¶</a></h3> <p>Different request types require different model capabilities:</p> <table> <thead> <tr> <th>Request Type</th> <th>Key Capabilities</th> </tr> </thead> <tbody> <tr> <td>Text-only queries</td> <td><code>general_knowledge</code>, <code>text_understanding</code></td> </tr> <tr> <td>Image analysis</td> <td><code>image_understanding</code>, <code>visual_reasoning</code></td> </tr> <tr> <td>Code questions</td> <td><code>code_understanding</code>, <code>[language]_expertise</code></td> </tr> <tr> <td>Creative tasks</td> <td><code>creative_generation</code>, <code>long_context</code></td> </tr> <tr> <td>Technical domains</td> <td><code>technical_knowledge</code>, <code>domain_expertise</code></td> </tr> </tbody> </table> <h3 id="2-service-characteristics">2. Service Characteristics<a class="headerlink" href="#2-service-characteristics" title="Permanent link">¶</a></h3> <p>Each backend has different characteristics that affect selection:</p> <table> <thead> <tr> <th>Backend</th> <th>Strengths</th> <th>Limitations</th> </tr> </thead> <tbody> <tr> <td>Gemini</td> <td>Advanced reasoning, multimodal, up-to-date knowledge</td> <td>External dependency, cost, potential latency</td> </tr> <tr> <td>Ollama</td> <td>Local deployment, customization, no data sharing</td> <td>Limited context window, less powerful than Gemini</td> </tr> <tr> <td>Transformers</td> <td>Maximum control, always available locally</td> <td>Most limited capabilities, higher resource usage</td> </tr> </tbody> </table> <h3 id="3-operational-factors">3. Operational Factors<a class="headerlink" href="#3-operational-factors" title="Permanent link">¶</a></h3> <p>Operational considerations that influence selection:</p> <ul> <li><strong>Availability</strong>: Current status of each service</li> <li><strong>Response time</strong>: Historical and current latency</li> <li><strong>Cost</strong>: Usage-based pricing considerations</li> <li><strong>Resource usage</strong>: CPU, memory, and GPU utilization</li> <li><strong>Error rates</strong>: Recent failure patterns</li> </ul> <h2 id="selection-examples">Selection Examples<a class="headerlink" href="#selection-examples" title="Permanent link">¶</a></h2> <h3 id="example-1-general-knowledge-query">Example 1: General Knowledge Query<a class="headerlink" href="#example-1-general-knowledge-query" title="Permanent link">¶</a></h3> <p>For a straightforward factual question:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>Query: "What is the capital of France?"
</code></pre></div> <p>Selection process: 1. Required capabilities: <code>["general_knowledge"]</code> 2. All backends support this capability 3. Assuming all are available, scores might be: - Gemini: 0.95 (highest accuracy) - Ollama: 0.85 (good accuracy, lower latency) - Transformers: 0.70 (limited knowledge) 4. Selected: Gemini</p> <h3 id="example-2-image-analysis-with-unavailable-primary">Example 2: Image Analysis with Unavailable Primary<a class="headerlink" href="#example-2-image-analysis-with-unavailable-primary" title="Permanent link">¶</a></h3> <p>For an image analysis request when Gemini is unavailable:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a>Query: "What's shown in this image?" with attached image
</code></pre></div> <p>Selection process: 1. Required capabilities: <code>["image_understanding"]</code> 2. Gemini scores highest but is unavailable 3. Fallback scores: - Ollama: 0.75 (limited image capabilities) - Transformers: 0.60 (basic image understanding) 4. Selected: Ollama as fallback</p> <h3 id="example-3-complex-code-analysis">Example 3: Complex Code Analysis<a class="headerlink" href="#example-3-complex-code-analysis" title="Permanent link">¶</a></h3> <p>For a complex programming question:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>Query: "Explain this Python decorator pattern and suggest improvements"
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>with code snippet
</code></pre></div> <p>Selection process: 1. Required capabilities: <code>["code_understanding", "python_expertise"]</code> 2. Scores: - Gemini: 0.92 (strong code understanding) - Ollama: 0.88 (good code capabilities with CodeLlama) - Transformers: 0.65 (limited code analysis) 3. If optimizing for cost: Ollama might be selected despite slightly lower score 4. If optimizing for quality: Gemini would be selected</p> <h2 id="configuration-options">Configuration Options<a class="headerlink" href="#configuration-options" title="Permanent link">¶</a></h2> <p>The backend selection system offers several configuration options:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nt">backend_selection</span><span class="p">:</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">  </span><span class="c1"># Scoring weights</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">  </span><span class="nt">weights</span><span class="p">:</span>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="nt">capability</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.6</span><span class="w">  </span><span class="c1"># Capability matching importance</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="nt">performance</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.3</span><span class="w">  </span><span class="c1"># Performance considerations</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="nt">cost</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w">  </span><span class="c1"># Cost optimization (if applicable)</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">  </span><span class="c1"># Selection preferences</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">  </span><span class="nt">preferences</span><span class="p">:</span>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="nt">prefer_local</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Prefer local models when capabilities are similar</span>
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="nt">cost_sensitive</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Increase cost factor importance</span>
<a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="nt">latency_threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500</span><span class="w">  </span><span class="c1"># Max acceptable latency in ms</span>
<a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a>
<a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">  </span><span class="c1"># Fallback configuration</span>
<a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">  </span><span class="nt">fallbacks</span><span class="p">:</span>
<a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="nt">retry_original</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Whether to retry original backend after timeout</span>
<a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="nt">fallback_chain</span><span class="p">:</span>
<a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">      </span><span class="nt">gemini</span><span class="p">:</span><span class="w"> </span><span class="s">"ollama"</span>
<a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">      </span><span class="nt">ollama</span><span class="p">:</span><span class="w"> </span><span class="s">"transformers"</span>
<a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">      </span><span class="nt">transformers</span><span class="p">:</span><span class="w"> </span><span class="s">"gemini"</span>
<a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">    </span><span class="nt">max_fallbacks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w">  </span><span class="c1"># Maximum number of fallbacks to attempt</span>
<a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a>
<a href="#__codelineno-9-23" id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">  </span><span class="c1"># Feature flags</span>
<a href="#__codelineno-9-24" id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">  </span><span class="nt">features</span><span class="p">:</span>
<a href="#__codelineno-9-25" id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">    </span><span class="nt">dynamic_scoring</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Adjust scores based on historical performance</span>
<a href="#__codelineno-9-26" id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">    </span><span class="nt">context_aware</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Consider conversation context in selection</span>
<a href="#__codelineno-9-27" id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="nt">adaptive_routing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># Learn from successful/failed selections</span>
</code></pre></div> <h2 id="monitoring-and-telemetry">Monitoring and Telemetry<a class="headerlink" href="#monitoring-and-telemetry" title="Permanent link">¶</a></h2> <p>The backend selection system collects detailed telemetry to improve decision quality:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">record_selection_telemetry</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">selected_backend</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">duration_ms</span><span class="p">):</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="sd">"""Record telemetry data for backend selection"""</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span class="n">telemetry</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
<a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a>        <span class="s2">"request_type"</span><span class="p">:</span> <span class="n">categorize_request</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
<a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>        <span class="s2">"required_capabilities"</span><span class="p">:</span> <span class="n">analyze_request</span><span class="p">(</span><span class="n">request</span><span class="p">),</span>
<a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="s2">"selected_backend"</span><span class="p">:</span> <span class="n">selected_backend</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="s2">"success"</span><span class="p">:</span> <span class="n">success</span><span class="p">,</span>
<a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a>        <span class="s2">"duration_ms"</span><span class="p">:</span> <span class="n">duration_ms</span><span class="p">,</span>
<a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="s2">"fallback_used"</span><span class="p">:</span> <span class="n">selected_backend</span><span class="o">.</span><span class="n">is_fallback</span><span class="p">,</span>
<a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a>        <span class="s2">"scores"</span><span class="p">:</span> <span class="n">backend_scores</span>  <span class="c1"># Scores from selection process</span>
<a href="#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a>    <span class="p">}</span>
<a href="#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a>
<a href="#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a>    <span class="c1"># Save telemetry</span>
<a href="#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a>    <span class="n">telemetry_store</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">telemetry</span><span class="p">)</span>
<a href="#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a>
<a href="#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a>    <span class="c1"># Update metrics for monitoring</span>
<a href="#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a>    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a href="#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="sa">f</span><span class="s2">"backend.</span><span class="si">{</span><span class="n">selected_backend</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.success"</span><span class="p">)</span>
<a href="#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a>    <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-10-22" id="__codelineno-10-22" name="__codelineno-10-22"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="sa">f</span><span class="s2">"backend.</span><span class="si">{</span><span class="n">selected_backend</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.failure"</span><span class="p">)</span>
<a href="#__codelineno-10-23" id="__codelineno-10-23" name="__codelineno-10-23"></a>
<a href="#__codelineno-10-24" id="__codelineno-10-24" name="__codelineno-10-24"></a>    <span class="n">metrics</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="sa">f</span><span class="s2">"backend.</span><span class="si">{</span><span class="n">selected_backend</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.duration"</span><span class="p">,</span> <span class="n">duration_ms</span><span class="p">)</span>
</code></pre></div> <p>This telemetry data enables: - Optimization of scoring weights - Identification of backend strengths and weaknesses - Detection of patterns in backend performance - Continuous improvement of selection accuracy</p> <h2 id="related-documentation">Related Documentation<a class="headerlink" href="#related-documentation" title="Permanent link">¶</a></h2> <ul> <li>Model Integration Architecture: Overall architecture of the model integration system</li> <li>Capability Matrix: Detailed mapping of model capabilities</li> <li>Provider Integration: Implementation details for each provider</li> <li>Model Configuration: Configuration options for model backends</li> <li>Service Availability: How service availability is monitored</li> </ul> </div> </div><footer> <div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation"> <a class="btn btn-neutral float-left" href="../architecture/" title="Architecture"><span class="icon icon-circle-arrow-left"></span> Previous</a> <a class="btn btn-neutral float-right" href="../capability-matrix/" title="Capability Matrix">Next <span class="icon icon-circle-arrow-right"></span></a> </div> <hr/> <div role="contentinfo"> <!-- Copyright etc --> </div> Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. </footer> </div> </div> </section> </div> <div aria-label="Versions" class="rst-versions" role="note"> <span class="rst-current-version" data-toggle="rst-current-version"> <span><a href="../architecture/" style="color: #fcfcfc">« Previous</a></span> <span><a href="../capability-matrix/" style="color: #fcfcfc">Next »</a></span> </span> </div> <script src="../../js/jquery-3.6.0.min.js"></script> <script>var base_url = "../..";</script> <script src="../../js/theme_extra.js"></script> <script src="../../js/theme.js"></script> <script src="../../search/main.js"></script> <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script> <script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body> </html> 