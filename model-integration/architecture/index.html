<!DOCTYPE html>
<html class="writer-html5" lang="en"> <head><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="bebo" name="author"/><link href="../../img/favicon.ico" rel="shortcut icon"/><title>Architecture - Opossum Search Documentation</title><link href="../../css/theme.css" rel="stylesheet"/><link href="../../css/theme_extra.css" rel="stylesheet"/><link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/><script>
        // Current page data
        var mkdocs_page_name = "Architecture";
        var mkdocs_page_input_path = "model-integration\\architecture.md";
        var mkdocs_page_url = null;
      </script><!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script><script>hljs.highlightAll();</script></head> <body class="wy-body-for-nav" role="document"> <div class="wy-grid-for-nav"> <nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift"> <div class="wy-side-scroll"> <div class="wy-side-nav-search"> <a class="icon icon-home" href="../.."> Opossum Search Documentation </a><div role="search"> <form action="../../search.html" class="wy-form" id="rtd-search-form" method="get"> <input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/> </form> </div> </div> <div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation"> <ul> <li class="toctree-l1"><a class="reference internal" href="../..">Home</a> </li> </ul> <p class="caption"><span class="caption-text">Technical &amp; Development</span></p> <ul> <li class="toctree-l1"><a class="reference internal">Architecture</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/system-architecture-overview/">System Architecture Overview</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Core Components</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/redis-caching-architecture/">Redis Caching Architecture</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/hybrid-model-selection/">Hybrid Model Selection</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/image-processing-pipeline/">Image Processing Pipeline</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/graphql-api/">GraphQL API</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/opentelemetry-integration/">OpenTelemetry Integration</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/svg-markup/">SVG Markup</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/devops-guide/">DevOps Guide</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Development Workflow</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/getting-started/">Getting Started</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal">Operations</a> <ul> <li class="toctree-l2"><a class="reference internal" href="../../technical/security-model/">Security Model</a> </li> <li class="toctree-l2"><a class="reference internal" href="../../technical/error-handling-resilience/">Error Handling &amp; Resilience</a> </li> </ul> </li> </ul> <p class="caption"><span class="caption-text">Service Availability</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/context-and-scope/">Context and Scope</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/quality-requirements/">Quality Requirements</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/architecture-constraints/">Architecture Constraints</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/availability-monitoring/">Availability Monitoring</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/service-outage/">Error Handling</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/rate-limiting-throttling/">Rate Limiting</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/log-alerts/">Logging and Alerts</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../service-availability/testing-validation/">Testing and Validation</a> </li> </ul> <p class="caption"><span class="caption-text">Conversation Management</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../conversation/topic-detection/">Topic Detection</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../conversation/conversation-flow/">Conversation Flow</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../conversation/response-generation/">Response Generation</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../conversation/nlp-components/">NLP Components</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../conversation/markov-generation/">Markov Chain Text</a> </li> </ul> <p class="caption"><span class="caption-text">Image Processing</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/overview/">Overview</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/effects/">Effects and Filters</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/svg-generation/">SVG Generation</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/optimization/">Performance Optimization</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../image-processing/caching/">Caching Strategy</a> </li> </ul> <p class="caption"><span class="caption-text">Model Integration</span></p> <ul class="current"> <li class="toctree-l1 current"><a class="reference internal current" href="#">Architecture</a> <ul class="current"> <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a> </li> <li class="toctree-l2"><a class="reference internal" href="#architectural-principles">Architectural Principles</a> </li> <li class="toctree-l2"><a class="reference internal" href="#core-components">Core Components</a> <ul> <li class="toctree-l3"><a class="reference internal" href="#key-components">Key Components</a> </li> </ul> </li> <li class="toctree-l2"><a class="reference internal" href="#request-flow">Request Flow</a> </li> <li class="toctree-l2"><a class="reference internal" href="#hybrid-model-backend">Hybrid Model Backend</a> </li> <li class="toctree-l2"><a class="reference internal" href="#service-availability">Service Availability</a> </li> <li class="toctree-l2"><a class="reference internal" href="#multi-modal-handling">Multi-Modal Handling</a> </li> <li class="toctree-l2"><a class="reference internal" href="#resilience-patterns">Resilience Patterns</a> </li> <li class="toctree-l2"><a class="reference internal" href="#configuration-example">Configuration Example</a> </li> <li class="toctree-l2"><a class="reference internal" href="#related-documentation">Related Documentation</a> </li> </ul> </li> <li class="toctree-l1"><a class="reference internal" href="../backend-selection/">Backend Selection</a> </li> <li class="toctree-l1"><a class="reference internal" href="../capability-matrix/">Capability Matrix</a> </li> <li class="toctree-l1"><a class="reference internal" href="../providers/">Provider Integration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../configuration/">Model Configuration</a> </li> </ul> <p class="caption"><span class="caption-text">API Reference</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../api/getting-started/">Getting Started</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/routes/">Routes</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/oauth-configuration/">OAuth Configuration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/request-response/">Request/Response</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/error-codes/">Error Codes</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/rate-limits/">Rate Limits</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/webhooks/">Webhook Integration</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/health-endpoints/">Health Endpoints</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../api/compliance/">Compliance</a> </li> </ul> <p class="caption"><span class="caption-text">Features</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../features/national-day/">Opossum National Day</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/easter-eggs/">Easter Eggs</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/special-events/">Special Events</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/background-stories/">Background Stories</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../features/service-vizualizations/">Service Visualizations</a> </li> </ul> <p class="caption"><span class="caption-text">About</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../about/history/">Project History</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/team/">Team</a> </li> <li class="toctree-l1"><a class="reference internal" href="../../about/roadmap/">Roadmap</a> </li> </ul> <p class="caption"><span class="caption-text">Infrastructure</span></p> <ul> <li class="toctree-l1"><a class="reference internal" href="../../infrastructure/optimization-strategies/">Optimization Strategies</a> </li> </ul> </div> </div> </nav> <section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"> <nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation"> <i class="fa fa-bars" data-toggle="wy-nav-top"></i> <a href="../..">Opossum Search Documentation</a> </nav> <div class="wy-nav-content"> <div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation"> <ul class="wy-breadcrumbs"> <li><a aria-label="Docs" class="icon icon-home" href="../.."></a></li> <li class="breadcrumb-item">Model Integration</li> <li class="breadcrumb-item active">Architecture</li> <li class="wy-breadcrumbs-aside"> </li> </ul> <hr/> </div> <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main"> <div class="section" itemprop="articleBody"> <h1 id="model-integration-architecture">Model Integration Architecture<a class="headerlink" href="#model-integration-architecture" title="Permanent link">¶</a></h1> <h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">¶</a></h2> <p>The Opossum Search system implements a sophisticated model integration architecture that dynamically selects and utilizes various AI models based on request characteristics, service availability, and capability requirements. This hybrid approach enables resilience, flexibility, and optimal performance across diverse search scenarios.</p> <h2 id="architectural-principles">Architectural Principles<a class="headerlink" href="#architectural-principles" title="Permanent link">¶</a></h2> <p>The model integration architecture follows several key principles:</p> <ol> <li><strong>Service Independence</strong>: No hard dependencies on any single AI service provider</li> <li><strong>Graceful Degradation</strong>: System continues functioning when services are unavailable</li> <li><strong>Capability-Based Routing</strong>: Requests are directed to models best suited to fulfill them</li> <li><strong>Transparent Fallbacks</strong>: Fallback mechanisms operate without requiring client awareness</li> <li><strong>Consistent Interface</strong>: Uniform API regardless of underlying model implementation</li> </ol> <h2 id="core-components">Core Components<a class="headerlink" href="#core-components" title="Permanent link">¶</a></h2> <pre class="mermaid"><code>graph TD
    A[Client Request] --&gt; B[API Gateway]
    B --&gt; C[Request Analyzer]
    C --&gt; D[Model Selector]
    D --&gt; E{Service Availability}

    E --&gt;|Primary Option| F[Gemini Backend]
    E --&gt;|Fallback Option| G[Ollama Backend]
    E --&gt;|Local Fallback| H[Transformers Backend]

    F --&gt; I[Response Formatter]
    G --&gt; I
    H --&gt; I
    I --&gt; J[Client Response]

    K[Capability Matrix] -.-&gt; D
    L[Configuration] -.-&gt; D
    M[Service Monitor] -.-&gt; E
</code></pre> <h3 id="key-components">Key Components<a class="headerlink" href="#key-components" title="Permanent link">¶</a></h3> <ol> <li> <p><strong>Request Analyzer</strong>: Examines incoming requests to determine their characteristics and requirements.</p> </li> <li> <p><strong>Model Selector</strong>: The central decision-making component that determines which model backend to use for a given request.</p> </li> <li> <p><strong>Service Availability</strong>: Monitors the status and availability of each model service.</p> </li> <li> <p><strong>Capability Matrix</strong>: Defines the capabilities of each model backend and their suitability for different request types.</p> </li> <li> <p><strong>Model Backends</strong>:</p> </li> <li><strong>Gemini Backend</strong>: Integration with Google's Gemini API</li> <li><strong>Ollama Backend</strong>: Integration with locally deployed Ollama models</li> <li> <p><strong>Transformers Backend</strong>: Direct integration with Hugging Face Transformers</p> </li> <li> <p><strong>Response Formatter</strong>: Ensures consistent response format regardless of the model used.</p> </li> </ol> <h2 id="request-flow">Request Flow<a class="headerlink" href="#request-flow" title="Permanent link">¶</a></h2> <p>The typical flow of a request through the model integration system:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<a href="#__codelineno-0-2" id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="sd">"""Process an incoming request through the model integration pipeline"""</span>
<a href="#__codelineno-0-3" id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a href="#__codelineno-0-4" id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="c1"># 1. Analyze request to determine characteristics and requirements</span>
<a href="#__codelineno-0-5" id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="n">request_profile</span> <span class="o">=</span> <span class="n">RequestAnalyzer</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a href="#__codelineno-0-6" id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a href="#__codelineno-0-7" id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="c1"># 2. Select optimal model based on request profile and current availability</span>
<a href="#__codelineno-0-8" id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="n">selected_model</span> <span class="o">=</span> <span class="n">ModelSelector</span><span class="o">.</span><span class="n">select_model</span><span class="p">(</span>
<a href="#__codelineno-0-9" id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="n">request_profile</span><span class="o">=</span><span class="n">request_profile</span><span class="p">,</span>
<a href="#__codelineno-0-10" id="__codelineno-0-10" name="__codelineno-0-10"></a>        <span class="n">capability_requirements</span><span class="o">=</span><span class="n">request_profile</span><span class="o">.</span><span class="n">capabilities_needed</span>
<a href="#__codelineno-0-11" id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="p">)</span>
<a href="#__codelineno-0-12" id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a href="#__codelineno-0-13" id="__codelineno-0-13" name="__codelineno-0-13"></a>    <span class="c1"># 3. Process request with selected model</span>
<a href="#__codelineno-0-14" id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-0-15" id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">selected_model</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-0-16" id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="k">return</span> <span class="n">format_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a href="#__codelineno-0-17" id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="k">except</span> <span class="n">ModelUnavailableError</span><span class="p">:</span>
<a href="#__codelineno-0-18" id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="c1"># 4. Handle failures with automatic fallback</span>
<a href="#__codelineno-0-19" id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">fallback_model</span> <span class="o">=</span> <span class="n">ModelSelector</span><span class="o">.</span><span class="n">select_fallback</span><span class="p">(</span>
<a href="#__codelineno-0-20" id="__codelineno-0-20" name="__codelineno-0-20"></a>            <span class="n">primary_model</span><span class="o">=</span><span class="n">selected_model</span><span class="p">,</span>
<a href="#__codelineno-0-21" id="__codelineno-0-21" name="__codelineno-0-21"></a>            <span class="n">request_profile</span><span class="o">=</span><span class="n">request_profile</span>
<a href="#__codelineno-0-22" id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="p">)</span>
<a href="#__codelineno-0-23" id="__codelineno-0-23" name="__codelineno-0-23"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">fallback_model</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
<a href="#__codelineno-0-24" id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="k">return</span> <span class="n">format_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div> <h2 id="hybrid-model-backend">Hybrid Model Backend<a class="headerlink" href="#hybrid-model-backend" title="Permanent link">¶</a></h2> <p>The core of the architecture is the <code>HybridModelBackend</code> class, which encapsulates the logic for selecting between different model backends:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">HybridModelBackend</span><span class="p">:</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="sd">"""Manages multiple model backends with intelligent selection and fallback"""</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backends</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a>            <span class="s1">'gemini'</span><span class="p">:</span> <span class="n">GeminiBackend</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">'gemini'</span><span class="p">]),</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a>            <span class="s1">'ollama'</span><span class="p">:</span> <span class="n">OllamaBackend</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">'ollama'</span><span class="p">]),</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>            <span class="s1">'transformers'</span><span class="p">:</span> <span class="n">TransformersBackend</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">'transformers'</span><span class="p">])</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a>        <span class="p">}</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">availability</span> <span class="o">=</span> <span class="n">ServiceAvailability</span><span class="p">()</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">capability_matrix</span> <span class="o">=</span> <span class="n">CapabilityMatrix</span><span class="p">()</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="sd">"""Process a query using the optimal model backend"""</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a>        <span class="n">selected_backend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_backend</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a>        <span class="k">try</span><span class="p">:</span>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a>            <span class="k">return</span> <span class="n">selected_backend</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a>        <span class="k">except</span> <span class="n">ServiceUnavailableError</span><span class="p">:</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>            <span class="c1"># Mark service as unavailable and try fallback</span>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="o">.</span><span class="n">mark_unavailable</span><span class="p">(</span><span class="n">selected_backend</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>            <span class="n">fallback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_fallback</span><span class="p">(</span><span class="n">selected_backend</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span>
<a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>            <span class="k">return</span> <span class="n">fallback</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>
<a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">        </span><span class="sd">"""Select the optimal backend based on query and requirements"""</span>
<a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>        <span class="c1"># Default requirements if none specified</span>
<a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>        <span class="n">requirements</span> <span class="o">=</span> <span class="n">requirements</span> <span class="ow">or</span> <span class="p">[</span><span class="s1">'general_knowledge'</span><span class="p">]</span>
<a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>
<a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>        <span class="c1"># Get available backends</span>
<a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>        <span class="n">available_backends</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>            <span class="n">name</span><span class="p">:</span> <span class="n">backend</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">backend</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="o">.</span><span class="n">is_available</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>        <span class="p">}</span>
<a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>
<a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">available_backends</span><span class="p">:</span>
<a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>            <span class="c1"># If nothing is available, try the local transformers backend</span>
<a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>            <span class="c1"># which should always be available as a last resort</span>
<a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backends</span><span class="p">[</span><span class="s1">'transformers'</span><span class="p">]</span>
<a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>
<a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a>        <span class="c1"># Score each available backend based on capability matrix</span>
<a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
<a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">backend</span> <span class="ow">in</span> <span class="n">available_backends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a>            <span class="n">scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">capability_matrix</span><span class="o">.</span><span class="n">score_backend</span><span class="p">(</span>
<a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a>                <span class="n">backend_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a>                <span class="n">requirements</span><span class="o">=</span><span class="n">requirements</span><span class="p">,</span>
<a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a>                <span class="n">query</span><span class="o">=</span><span class="n">query</span>
<a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>            <span class="p">)</span>
<a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a>
<a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>        <span class="c1"># Select backend with highest score</span>
<a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a>        <span class="n">selected_name</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backends</span><span class="p">[</span><span class="n">selected_name</span><span class="p">]</span>
<a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a>
<a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_select_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">failed_backend</span><span class="p">,</span> <span class="n">requirements</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">        </span><span class="sd">"""Select a fallback backend when the primary choice fails"""</span>
<a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a>        <span class="c1"># Define fallback chain</span>
<a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a>        <span class="n">fallback_chain</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>            <span class="s1">'gemini'</span><span class="p">:</span> <span class="s1">'ollama'</span><span class="p">,</span>
<a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>            <span class="s1">'ollama'</span><span class="p">:</span> <span class="s1">'transformers'</span><span class="p">,</span>
<a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a>            <span class="s1">'transformers'</span><span class="p">:</span> <span class="s1">'gemini'</span>  <span class="c1"># Circular as last resort</span>
<a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a>        <span class="p">}</span>
<a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a>
<a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a>        <span class="c1"># Try the next backend in the fallback chain</span>
<a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a>        <span class="n">next_backend</span> <span class="o">=</span> <span class="n">fallback_chain</span><span class="p">[</span><span class="n">failed_backend</span><span class="p">]</span>
<a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a>
<a href="#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a>        <span class="c1"># If that's available, use it</span>
<a href="#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="o">.</span><span class="n">is_available</span><span class="p">(</span><span class="n">next_backend</span><span class="p">):</span>
<a href="#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backends</span><span class="p">[</span><span class="n">next_backend</span><span class="p">]</span>
<a href="#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a>
<a href="#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>        <span class="c1"># Otherwise find any available backend</span>
<a href="#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">backend</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a href="#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a>            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">failed_backend</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">availability</span><span class="o">.</span><span class="n">is_available</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<a href="#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a>                <span class="k">return</span> <span class="n">backend</span>
<a href="#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a>
<a href="#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a>        <span class="c1"># If all else fails, use transformers as last resort</span>
<a href="#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">backends</span><span class="p">[</span><span class="s1">'transformers'</span><span class="p">]</span>
</code></pre></div> <h2 id="service-availability">Service Availability<a class="headerlink" href="#service-availability" title="Permanent link">¶</a></h2> <p>The <code>ServiceAvailability</code> component monitors the health and availability of model services:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ServiceAvailability</span><span class="p">:</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="sd">"""Tracks availability of model services and implements circuit breaker pattern"""</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a>            <span class="s1">'gemini'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'available'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'last_checked'</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()},</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a>            <span class="s1">'ollama'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'available'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'last_checked'</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()},</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a>            <span class="s1">'transformers'</span><span class="p">:</span> <span class="p">{</span><span class="s1">'available'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'last_checked'</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span class="p">}</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failure_thresholds</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a>            <span class="s1">'gemini'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a>            <span class="s1">'ollama'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a>            <span class="s1">'transformers'</span><span class="p">:</span> <span class="mi">5</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span class="p">}</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failure_counts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'gemini'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'ollama'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'transformers'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">recovery_intervals</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a>            <span class="s1">'gemini'</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>  <span class="c1"># 5 minutes</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a>            <span class="s1">'ollama'</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>   <span class="c1"># 1 minute</span>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a>            <span class="s1">'transformers'</span><span class="p">:</span> <span class="mi">120</span>  <span class="c1"># 2 minutes</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a>        <span class="p">}</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>
<a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_available</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">):</span>
<a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">        </span><span class="sd">"""Check if a service is currently available"""</span>
<a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a>        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">'available'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a>        <span class="c1"># If service is marked unavailable, check if recovery interval has passed</span>
<a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">[</span><span class="s1">'available'</span><span class="p">]:</span>
<a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a>            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">status</span><span class="p">[</span><span class="s1">'last_checked'</span><span class="p">]</span>
<a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a>            <span class="k">if</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">recovery_intervals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="mi">300</span><span class="p">):</span>
<a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a>                <span class="c1"># Time to retry this service</span>
<a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">service_name</span><span class="p">][</span><span class="s1">'available'</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">failure_counts</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a>
<a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="p">{</span><span class="s1">'available'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})[</span><span class="s1">'available'</span><span class="p">]</span>
<a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a>
<a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mark_unavailable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">):</span>
<a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">        </span><span class="sd">"""Mark a service as unavailable after failure"""</span>
<a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failure_counts</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a>
<a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a>        <span class="c1"># If we've hit the threshold, mark service as unavailable</span>
<a href="#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_counts</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_thresholds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
<a href="#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a>                <span class="s1">'available'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a href="#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a>                <span class="s1">'last_checked'</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a href="#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a>            <span class="p">}</span>
<a href="#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Service </span><span class="si">{</span><span class="n">service_name</span><span class="si">}</span><span class="s2"> marked unavailable after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">failure_counts</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span><span class="si">}</span><span class="s2"> failures"</span><span class="p">)</span>
<a href="#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a>
<a href="#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mark_successful</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">):</span>
<a href="#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a><span class="w">        </span><span class="sd">"""Mark a successful service call to reset failure count"""</span>
<a href="#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failure_counts</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a href="#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a href="#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a>            <span class="s1">'available'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a href="#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a>            <span class="s1">'last_checked'</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a href="#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a>        <span class="p">}</span>
</code></pre></div> <h2 id="multi-modal-handling">Multi-Modal Handling<a class="headerlink" href="#multi-modal-handling" title="Permanent link">¶</a></h2> <p>The model integration architecture supports multi-modal requests involving text, images, and structured data:</p> <div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_multimodal_request</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">structured_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="sd">"""Process a request containing multiple input modalities"""</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="c1"># Determine required capabilities based on input types</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>    <span class="n">capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'text_understanding'</span><span class="p">]</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="k">if</span> <span class="n">images</span><span class="p">:</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a>        <span class="n">capabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'image_understanding'</span><span class="p">)</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a>    <span class="k">if</span> <span class="n">structured_data</span><span class="p">:</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>        <span class="n">capabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'structured_data_processing'</span><span class="p">)</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>    <span class="c1"># Select model based on required capabilities</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">ModelSelector</span><span class="o">.</span><span class="n">select_model</span><span class="p">(</span><span class="n">capabilities</span><span class="o">=</span><span class="n">capabilities</span><span class="p">)</span>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a>    <span class="c1"># Process with selected model</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a>    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">supports_multimodal_input</span><span class="p">():</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a>        <span class="c1"># Model can process all modalities together</span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a>        <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">process_multimodal</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">structured_data</span><span class="p">)</span>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a>    <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>        <span class="c1"># Handle with separate processing and integration</span>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>        <span class="n">text_result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">process_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>        <span class="k">if</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">supports_capability</span><span class="p">(</span><span class="s1">'image_understanding'</span><span class="p">):</span>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>            <span class="n">image_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">process_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>            <span class="c1"># Fallback to image-specific model</span>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>            <span class="n">image_model</span> <span class="o">=</span> <span class="n">ModelSelector</span><span class="o">.</span><span class="n">select_model</span><span class="p">(</span><span class="n">capabilities</span><span class="o">=</span><span class="p">[</span><span class="s1">'image_understanding'</span><span class="p">])</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>            <span class="n">image_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_model</span><span class="o">.</span><span class="n">process_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>        <span class="c1"># Integrate results</span>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>        <span class="k">return</span> <span class="n">integrate_multimodal_results</span><span class="p">(</span><span class="n">text_result</span><span class="p">,</span> <span class="n">image_results</span><span class="p">,</span> <span class="n">structured_data</span><span class="p">)</span>
</code></pre></div> <h2 id="resilience-patterns">Resilience Patterns<a class="headerlink" href="#resilience-patterns" title="Permanent link">¶</a></h2> <p>The architecture implements several resilience patterns:</p> <ol> <li><strong>Circuit Breaker</strong>: Temporarily disables services after consecutive failures</li> <li><strong>Fallback Chain</strong>: Defines explicit fallback paths when services fail</li> <li><strong>Capability Degradation</strong>: Adjusts capabilities based on available services</li> <li><strong>Automatic Retry</strong>: Implements retry with backoff for transient errors</li> <li><strong>Health Monitoring</strong>: Proactively checks service health</li> </ol> <h2 id="configuration-example">Configuration Example<a class="headerlink" href="#configuration-example" title="Permanent link">¶</a></h2> <div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nt">model_integration</span><span class="p">:</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">  </span><span class="nt">default_backend</span><span class="p">:</span><span class="w"> </span><span class="s">"gemini"</span>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">  </span><span class="nt">backends</span><span class="p">:</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="nt">gemini</span><span class="p">:</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">"${GEMINI_API_KEY}"</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">      </span><span class="nt">max_retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">      </span><span class="nt">model</span><span class="p">:</span><span class="w"> </span><span class="s">"gemini-pro"</span>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="nt">ollama</span><span class="p">:</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">"localhost"</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">11434</span>
<a href="#__codelineno-4-14" id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">      </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<a href="#__codelineno-4-15" id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">      </span><span class="nt">models</span><span class="p">:</span>
<a href="#__codelineno-4-16" id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"llama2"</span>
<a href="#__codelineno-4-17" id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">          </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a href="#__codelineno-4-18" id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"mistral"</span>
<a href="#__codelineno-4-19" id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"vicuna"</span>
<a href="#__codelineno-4-20" id="__codelineno-4-20" name="__codelineno-4-20"></a>
<a href="#__codelineno-4-21" id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">    </span><span class="nt">transformers</span><span class="p">:</span>
<a href="#__codelineno-4-22" id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">      </span><span class="nt">model_path</span><span class="p">:</span><span class="w"> </span><span class="s">"./models/local"</span>
<a href="#__codelineno-4-23" id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">      </span><span class="nt">default_model</span><span class="p">:</span><span class="w"> </span><span class="s">"microsoft/phi-2"</span>
<a href="#__codelineno-4-24" id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">      </span><span class="nt">quantization</span><span class="p">:</span><span class="w"> </span><span class="s">"int8"</span>
<a href="#__codelineno-4-25" id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">      </span><span class="nt">device</span><span class="p">:</span><span class="w"> </span><span class="s">"cuda"</span>
<a href="#__codelineno-4-26" id="__codelineno-4-26" name="__codelineno-4-26"></a>
<a href="#__codelineno-4-27" id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">  </span><span class="nt">availability</span><span class="p">:</span>
<a href="#__codelineno-4-28" id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">    </span><span class="nt">check_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a href="#__codelineno-4-29" id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">    </span><span class="nt">failure_thresholds</span><span class="p">:</span>
<a href="#__codelineno-4-30" id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">      </span><span class="nt">gemini</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a href="#__codelineno-4-31" id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">      </span><span class="nt">ollama</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<a href="#__codelineno-4-32" id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">      </span><span class="nt">transformers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a href="#__codelineno-4-33" id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">    </span><span class="nt">recovery_intervals</span><span class="p">:</span>
<a href="#__codelineno-4-34" id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">      </span><span class="nt">gemini</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">300</span>
<a href="#__codelineno-4-35" id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">      </span><span class="nt">ollama</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<a href="#__codelineno-4-36" id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">      </span><span class="nt">transformers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">120</span>
</code></pre></div> <h2 id="related-documentation">Related Documentation<a class="headerlink" href="#related-documentation" title="Permanent link">¶</a></h2> <ul> <li>Backend Selection: Details on how models are selected for specific requests</li> <li>Capability Matrix: Comprehensive mapping of model capabilities</li> <li>Provider Integration: Specific implementation details for each provider</li> <li>Model Configuration: Configuration options for model backends</li> </ul> </div> </div><footer> <div aria-label="Footer Navigation" class="rst-footer-buttons" role="navigation"> <a class="btn btn-neutral float-left" href="../../image-processing/caching/" title="Caching Strategy"><span class="icon icon-circle-arrow-left"></span> Previous</a> <a class="btn btn-neutral float-right" href="../backend-selection/" title="Backend Selection">Next <span class="icon icon-circle-arrow-right"></span></a> </div> <hr/> <div role="contentinfo"> <!-- Copyright etc --> </div> Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. </footer> </div> </div> </section> </div> <div aria-label="Versions" class="rst-versions" role="note"> <span class="rst-current-version" data-toggle="rst-current-version"> <span><a href="../../image-processing/caching/" style="color: #fcfcfc">« Previous</a></span> <span><a href="../backend-selection/" style="color: #fcfcfc">Next »</a></span> </span> </div> <script src="../../js/jquery-3.6.0.min.js"></script> <script>var base_url = "../..";</script> <script src="../../js/theme_extra.js"></script> <script src="../../js/theme.js"></script> <script src="../../search/main.js"></script> <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script> <script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body> </html> 