<!DOCTYPE html><html class=writer-html5 lang=en> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=author content=bebo><link rel="shortcut icon" href=../../img/favicon.ico><title>Provider Integration - Opossum Search Documentation</title><link rel=stylesheet href=../../css/theme.css><link rel=stylesheet href=../../css/theme_extra.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css><link href=../../assets/_mkdocstrings.css rel=stylesheet><link href=../../stylesheets/extra.css rel=stylesheet><script>
        // Current page data
        var mkdocs_page_name = "Provider Integration";
        var mkdocs_page_input_path = "model-integration\\providers.md";
        var mkdocs_page_url = null;
      </script><!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]--><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js></script><script>hljs.highlightAll();</script></head> <body class=wy-body-for-nav role=document> <div class=wy-grid-for-nav> <nav data-toggle=wy-nav-shift class="wy-nav-side stickynav"> <div class=wy-side-scroll> <div class=wy-side-nav-search> <a href=../.. class="icon icon-home"> Opossum Search Documentation </a><div role=search> <form id=rtd-search-form class=wy-form action=../../search.html method=get> <input type=text name=q placeholder="Search docs" aria-label="Search docs" title="Type search term here"> </form> </div> </div> <div class="wy-menu wy-menu-vertical" data-spy=affix role=navigation aria-label="Navigation menu"> <ul> <li class=toctree-l1><a class="reference internal" href=../..>Home</a> </li> </ul> <p class=caption><span class=caption-text>Getting Started</span></p> <ul> <li class=toctree-l1><a href=../../technical/getting-started/ class="reference internal">First Steps</a> </li> <li class=toctree-l1><a href=../../technical/system-architecture-overview/ class="reference internal">System Overview</a> </li> <li class=toctree-l1><a href=../../api/getting-started/ class="reference internal">API Reference</a> </li> <li class=toctree-l1><a href=../../technical/devops-guide/ class="reference internal">Developer Quickstart</a> </li> </ul> <p class=caption><span class=caption-text>Core Components</span></p> <ul class=current> <li class=toctree-l1><a class="reference internal">Architecture</a> <ul> <li class=toctree-l2><a href=../../technical/system-architecture-overview/ class="reference internal">System Overview</a> </li> <li class=toctree-l2><a href=../../technical/graphql-api/ class="reference internal">GraphQL API</a> </li> <li class=toctree-l2><a href=../../technical/security-model/ class="reference internal">Security Model</a> </li> <li class=toctree-l2><a href=../../technical/prompt-management/ class="reference internal">Prompt Management</a> </li> </ul> </li> <li class="toctree-l1 current"><a class="reference internal current">Model Integration</a> <ul class=current> <li class=toctree-l2><a href=../architecture/ class="reference internal">Architecture</a> </li> <li class=toctree-l2><a href=../backend-selection/ class="reference internal">Backend Selection</a> </li> <li class=toctree-l2><a href=../capability-matrix/ class="reference internal">Capability Matrix</a> </li> <li class="toctree-l2 current"><a class="reference internal current" href=#>Provider Integration</a> <ul class=current> <li class=toctree-l3><a class="reference internal" href=#overview>Overview</a> </li> <li class=toctree-l3><a class="reference internal" href=#supported-providers>Supported Providers</a> </li> <li class=toctree-l3><a class="reference internal" href=#gemini-integration>Gemini Integration</a> <ul> <li class=toctree-l4><a class="reference internal" href=#authentication>Authentication</a> </li> <li class=toctree-l4><a class="reference internal" href=#request-processing>Request Processing</a> </li> <li class=toctree-l4><a class="reference internal" href=#multimodal-handling>Multimodal Handling</a> </li> <li class=toctree-l4><a class="reference internal" href=#usage-tracking>Usage Tracking</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#ollama-integration>Ollama Integration</a> <ul> <li class=toctree-l4><a class="reference internal" href=#connection-setup>Connection Setup</a> </li> <li class=toctree-l4><a class="reference internal" href=#request-processing_1>Request Processing</a> </li> <li class=toctree-l4><a class="reference internal" href=#model-management>Model Management</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#transformers-integration>Transformers Integration</a> <ul> <li class=toctree-l4><a class="reference internal" href=#initialization>Initialization</a> </li> <li class=toctree-l4><a class="reference internal" href=#request-processing_2>Request Processing</a> </li> <li class=toctree-l4><a class="reference internal" href=#memory-management>Memory Management</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#error-handling>Error Handling</a> </li> <li class=toctree-l3><a class="reference internal" href=#provider-specific-considerations>Provider-Specific Considerations</a> <ul> <li class=toctree-l4><a class="reference internal" href=#gemini>Gemini</a> </li> <li class=toctree-l4><a class="reference internal" href=#ollama>Ollama</a> </li> <li class=toctree-l4><a class="reference internal" href=#transformers>Transformers</a> </li> </ul> </li> <li class=toctree-l3><a class="reference internal" href=#related-documentation>Related Documentation</a> </li> </ul> </li> <li class=toctree-l2><a href=../configuration/ class="reference internal">Configuration</a> </li> <li class=toctree-l2><a href=../../technical/hybrid-model-selection/ class="reference internal">Hybrid Selection</a> </li> <li class=toctree-l2><a href=../../technical/prompt-management/ class="reference internal">Prompt Management</a> </li> <li class=toctree-l2><a href=../dspy-integration/ class="reference internal">DSPy Integration</a> </li> <li class=toctree-l2><a href=../dspy-technical/ class="reference internal">DSPy Technical Implementation</a> </li> <li class=toctree-l2><a href=../dspy-examples/ class="reference internal">DSPy Usage Examples</a> </li> <li class=toctree-l2><a href=../dspy-metrics/ class="reference internal">DSPy Metrics & Performance</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Service Availability</a> <ul> <li class=toctree-l2><a href=../../service-availability/context-and-scope/ class="reference internal">Context and Scope</a> </li> <li class=toctree-l2><a href=../../service-availability/quality-requirements/ class="reference internal">Quality Requirements</a> </li> <li class=toctree-l2><a href=../../service-availability/architecture-constraints/ class="reference internal">Architecture Constraints</a> </li> <li class=toctree-l2><a href=../../service-availability/availability-monitoring/ class="reference internal">Availability Monitoring</a> </li> <li class=toctree-l2><a href=../../service-availability/service-outage/ class="reference internal">Error Handling</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Resilience Patterns</a> <ul> <li class=toctree-l2><a href=../../technical/resilience-patterns/ class="reference internal">Core Strategies</a> </li> <li class=toctree-l2><a href=../../technical/error-handling-resilience/ class="reference internal">Error Handling</a> </li> <li class=toctree-l2><a href=../../service-availability/rate-limiting-throttling/ class="reference internal">Rate Limiting</a> </li> <li class=toctree-l2><a href=../../service-availability/log-alerts/ class="reference internal">Logging and Alerts</a> </li> <li class=toctree-l2><a href=../../service-availability/testing-validation/ class="reference internal">Testing and Validation</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>Features</span></p> <ul> <li class=toctree-l1><a class="reference internal">Conversation</a> <ul> <li class=toctree-l2><a href=../../conversation/topic-detection/ class="reference internal">Topic Detection</a> </li> <li class=toctree-l2><a href=../../conversation/conversation-flow/ class="reference internal">Conversation Flow</a> </li> <li class=toctree-l2><a href=../../conversation/response-generation/ class="reference internal">Response Generation</a> </li> <li class=toctree-l2><a href=../../conversation/nlp-components/ class="reference internal">NLP Components</a> </li> <li class=toctree-l2><a href=../../conversation/markov-generation/ class="reference internal">Markov Generation</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Image Processing</a> <ul> <li class=toctree-l2><a href=../../image-processing/overview/ class="reference internal">Overview</a> </li> <li class=toctree-l2><a href=../../image-processing/effects/ class="reference internal">Effects and Filters</a> </li> <li class=toctree-l2><a href=../../image-processing/svg-generation/ class="reference internal">SVG Generation</a> </li> <li class=toctree-l2><a href=../../image-processing/optimization/ class="reference internal">Performance Optimization</a> </li> <li class=toctree-l2><a href=../../image-processing/caching/ class="reference internal">Caching Strategy</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">Visualizations & Fun</a> <ul> <li class=toctree-l2><a href=../../features/service-vizualizations/ class="reference internal">Service Visualizations</a> </li> <li class=toctree-l2><a href=../../features/national-day/ class="reference internal">National Opossum Day</a> </li> <li class=toctree-l2><a href=../../features/easter-eggs/ class="reference internal">Easter Eggs</a> </li> <li class=toctree-l2><a href=../../features/special-events/ class="reference internal">Special Events</a> </li> <li class=toctree-l2><a href=../../features/background-stories/ class="reference internal">Background Stories</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>Technical Reference</span></p> <ul> <li class=toctree-l1><a class="reference internal">Infrastructure</a> <ul> <li class=toctree-l2><a href=../../technical/redis-caching-architecture/ class="reference internal">Redis Caching</a> </li> <li class=toctree-l2><a href=../../technical/image-processing-pipeline/ class="reference internal">Image Pipeline</a> </li> <li class=toctree-l2><a href=../../technical/opentelemetry-integration/ class="reference internal">OpenTelemetry</a> </li> <li class=toctree-l2><a href=../../technical/svg-markup/ class="reference internal">SVG Markup</a> </li> <li class=toctree-l2><a href=../../technical/bot-user-simulation/ class="reference internal">Bot User Simulation</a> </li> <li class=toctree-l2><a href=../../infrastructure/optimization-strategies/ class="reference internal">Optimization Strategies</a> </li> <li class=toctree-l2><a href=../../infrastructure/pipeline-optimization/ class="reference internal">Pipeline Optimization</a> </li> <li class=toctree-l2><a href=../../infrastructure/constraint-mapping/ class="reference internal">Constraint Mapping</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">API Documentation</a> <ul> <li class=toctree-l2><a href=../../api/routes/ class="reference internal">Routes</a> </li> <li class=toctree-l2><a href=../../api/request-response/ class="reference internal">Request/Response</a> </li> <li class=toctree-l2><a href=../../api/oauth-configuration/ class="reference internal">OAuth Configuration</a> </li> <li class=toctree-l2><a href=../../api/error-codes/ class="reference internal">Error Codes</a> </li> <li class=toctree-l2><a href=../../api/rate-limits/ class="reference internal">Rate Limits</a> </li> <li class=toctree-l2><a href=../../api/webhooks/ class="reference internal">Webhook Integration</a> </li> <li class=toctree-l2><a href=../../api/health-endpoints/ class="reference internal">Health Endpoints</a> </li> <li class=toctree-l2><a href=../../api/compliance/ class="reference internal">Compliance</a> </li> </ul> </li> <li class=toctree-l1><a class="reference internal">DSPy Tutorials</a> <ul> <li class=toctree-l2><a href=../../tutorials/dspy/getting-started/ class="reference internal">Getting Started with DSPy</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/optimizing-prompts/ class="reference internal">Optimizing Prompts</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/building-pipelines/ class="reference internal">Building Pipelines</a> </li> <li class=toctree-l2><a href=../../tutorials/dspy/advanced-reasoning/ class="reference internal">Advanced Reasoning</a> </li> </ul> </li> </ul> <p class=caption><span class=caption-text>About</span></p> <ul> <li class=toctree-l1><a href=../../about/history/ class="reference internal">Project History</a> </li> <li class=toctree-l1><a href=../../about/team/ class="reference internal">Team</a> </li> <li class=toctree-l1><a href=../../about/roadmap/ class="reference internal">Roadmap</a> </li> </ul> </div> </div> </nav> <section data-toggle=wy-nav-shift class=wy-nav-content-wrap> <nav class=wy-nav-top role=navigation aria-label="Mobile navigation menu"> <i data-toggle=wy-nav-top class="fa fa-bars"></i> <a href=../..>Opossum Search Documentation</a> </nav> <div class=wy-nav-content> <div class=rst-content><div role=navigation aria-label="breadcrumbs navigation"> <ul class=wy-breadcrumbs> <li><a href=../.. class="icon icon-home" aria-label=Docs></a></li> <li class=breadcrumb-item>Core Components</li> <li class=breadcrumb-item>Model Integration</li> <li class="breadcrumb-item active">Provider Integration</li> <li class=wy-breadcrumbs-aside> </li> </ul> <hr> </div> <div role=main class=document itemscope=itemscope itemtype=http://schema.org/Article> <div class=section itemprop=articleBody> <h1 id=provider-integration>Provider Integration<a class=headerlink href=#provider-integration title="Permanent link">&para;</a></h1> <h2 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h2> <p>Opossum Search integrates with multiple AI model providers to deliver resilient, high-quality responses. This document details the implementation specifics for each supported provider, including authentication, request/response handling, and provider-specific optimizations.</p> <h2 id=supported-providers>Supported Providers<a class=headerlink href=#supported-providers title="Permanent link">&para;</a></h2> <p>The system currently integrates with these model providers:</p> <table> <thead> <tr> <th>Provider</th> <th>Type</th> <th>Primary Use Cases</th> <th>Integration Type</th> </tr> </thead> <tbody> <tr> <td>Gemini</td> <td>Cloud API</td> <td>Advanced reasoning, multimodal</td> <td>REST API</td> </tr> <tr> <td>Ollama</td> <td>Local deployment</td> <td>Cost-effective, private deployment</td> <td>HTTP API</td> </tr> <tr> <td>Transformers</td> <td>Local library</td> <td>Fallback, specialized models</td> <td>Direct library</td> </tr> </tbody> </table> <h2 id=gemini-integration>Gemini Integration<a class=headerlink href=#gemini-integration title="Permanent link">&para;</a></h2> <p>Gemini provides state-of-the-art AI capabilities through Google's API service.</p> <h3 id=authentication>Authentication<a class=headerlink href=#authentication title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>class</span><span class=w> </span><span class=nc>GeminiBackend</span><span class=p>:</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>        <span class=bp>self</span><span class=o>.</span><span class=n>api_key</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;api_key&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;GEMINI_API_KEY&#39;</span><span class=p>)</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>api_key</span><span class=p>:</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>            <span class=k>raise</span> <span class=n>ConfigurationError</span><span class=p>(</span><span class=s2>&quot;Gemini API key not provided&quot;</span><span class=p>)</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;model&#39;</span><span class=p>,</span> <span class=s1>&#39;gemini-pro&#39;</span><span class=p>)</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;timeout&#39;</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>        <span class=bp>self</span><span class=o>.</span><span class=n>retries</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_retries&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>        <span class=c1># Initialize client</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>genai</span><span class=o>.</span><span class=n>Client</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>api_key</span><span class=p>)</span>
</code></pre></div> <h3 id=request-processing>Request Processing<a class=headerlink href=#request-processing title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>def</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Process a query using Gemini API&quot;&quot;&quot;</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>        <span class=c1># Build generation config</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>        <span class=n>generation_config</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>            <span class=s2>&quot;temperature&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>temperature</span><span class=p>,</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>            <span class=s2>&quot;top_p&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>top_p</span><span class=p>,</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>            <span class=s2>&quot;top_k&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>top_k</span><span class=p>,</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>            <span class=s2>&quot;max_output_tokens&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_tokens</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>        <span class=p>}</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>        <span class=c1># Prepare context if provided</span>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>        <span class=n>safety_settings</span> <span class=o>=</span> <span class=p>[</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>            <span class=p>{</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>                <span class=s2>&quot;category&quot;</span><span class=p>:</span> <span class=s2>&quot;HARM_CATEGORY_HARASSMENT&quot;</span><span class=p>,</span>
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>                <span class=s2>&quot;threshold&quot;</span><span class=p>:</span> <span class=s2>&quot;BLOCK_ONLY_HIGH&quot;</span>
<a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>            <span class=p>},</span>
<a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>            <span class=c1># Other safety settings...</span>
<a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>        <span class=p>]</span>
<a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>
<a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a>        <span class=c1># Create model instance</span>
<a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a>        <span class=n>model</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>)</span>
<a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a>
<a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a>        <span class=c1># Build prompt with context if available</span>
<a id=__codelineno-1-25 name=__codelineno-1-25 href=#__codelineno-1-25></a>        <span class=n>content</span> <span class=o>=</span> <span class=p>[</span><span class=n>query</span><span class=p>]</span>
<a id=__codelineno-1-26 name=__codelineno-1-26 href=#__codelineno-1-26></a>        <span class=k>if</span> <span class=n>context</span><span class=p>:</span>
<a id=__codelineno-1-27 name=__codelineno-1-27 href=#__codelineno-1-27></a>            <span class=n>content</span> <span class=o>=</span> <span class=n>context</span> <span class=o>+</span> <span class=p>[</span><span class=n>query</span><span class=p>]</span>
<a id=__codelineno-1-28 name=__codelineno-1-28 href=#__codelineno-1-28></a>
<a id=__codelineno-1-29 name=__codelineno-1-29 href=#__codelineno-1-29></a>        <span class=c1># Generate response</span>
<a id=__codelineno-1-30 name=__codelineno-1-30 href=#__codelineno-1-30></a>        <span class=n>response</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>generate_content</span><span class=p>(</span>
<a id=__codelineno-1-31 name=__codelineno-1-31 href=#__codelineno-1-31></a>            <span class=n>content</span><span class=p>,</span>
<a id=__codelineno-1-32 name=__codelineno-1-32 href=#__codelineno-1-32></a>            <span class=n>generation_config</span><span class=o>=</span><span class=n>generation_config</span><span class=p>,</span>
<a id=__codelineno-1-33 name=__codelineno-1-33 href=#__codelineno-1-33></a>            <span class=n>safety_settings</span><span class=o>=</span><span class=n>safety_settings</span>
<a id=__codelineno-1-34 name=__codelineno-1-34 href=#__codelineno-1-34></a>        <span class=p>)</span>
<a id=__codelineno-1-35 name=__codelineno-1-35 href=#__codelineno-1-35></a>
<a id=__codelineno-1-36 name=__codelineno-1-36 href=#__codelineno-1-36></a>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span>
<a id=__codelineno-1-37 name=__codelineno-1-37 href=#__codelineno-1-37></a>
<a id=__codelineno-1-38 name=__codelineno-1-38 href=#__codelineno-1-38></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-1-39 name=__codelineno-1-39 href=#__codelineno-1-39></a>        <span class=c1># Handle different error types</span>
<a id=__codelineno-1-40 name=__codelineno-1-40 href=#__codelineno-1-40></a>        <span class=k>if</span> <span class=s2>&quot;rate limit&quot;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
<a id=__codelineno-1-41 name=__codelineno-1-41 href=#__codelineno-1-41></a>            <span class=k>raise</span> <span class=n>RateLimitError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Gemini rate limit exceeded: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-1-42 name=__codelineno-1-42 href=#__codelineno-1-42></a>        <span class=k>elif</span> <span class=s2>&quot;quota&quot;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
<a id=__codelineno-1-43 name=__codelineno-1-43 href=#__codelineno-1-43></a>            <span class=k>raise</span> <span class=n>QuotaExceededError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Gemini quota exceeded: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-1-44 name=__codelineno-1-44 href=#__codelineno-1-44></a>        <span class=k>elif</span> <span class=s2>&quot;unavailable&quot;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>or</span> <span class=s2>&quot;timeout&quot;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
<a id=__codelineno-1-45 name=__codelineno-1-45 href=#__codelineno-1-45></a>            <span class=k>raise</span> <span class=n>ServiceUnavailableError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Gemini service unavailable: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-1-46 name=__codelineno-1-46 href=#__codelineno-1-46></a>        <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-1-47 name=__codelineno-1-47 href=#__codelineno-1-47></a>            <span class=k>raise</span> <span class=n>ModelProcessingError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error processing with Gemini: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=multimodal-handling>Multimodal Handling<a class=headerlink href=#multimodal-handling title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>def</span><span class=w> </span><span class=nf>process_multimodal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>,</span> <span class=n>images</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Process a multimodal query with text and images&quot;&quot;&quot;</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>        <span class=c1># Create multimodal prompt</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>        <span class=n>parts</span> <span class=o>=</span> <span class=p>[</span><span class=n>text</span><span class=p>]</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>        <span class=c1># Add images if provided</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>        <span class=k>if</span> <span class=n>images</span><span class=p>:</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>            <span class=k>for</span> <span class=n>image</span> <span class=ow>in</span> <span class=n>images</span><span class=p>:</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>                    <span class=c1># Image is a URL or file path</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>                    <span class=k>if</span> <span class=n>image</span><span class=o>.</span><span class=n>startswith</span><span class=p>((</span><span class=s1>&#39;http://&#39;</span><span class=p>,</span> <span class=s1>&#39;https://&#39;</span><span class=p>)):</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>                        <span class=n>img_data</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>                    <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>                        <span class=n>img_data</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>from_file</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>                <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a>                    <span class=c1># Image is already a binary object</span>
<a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>                    <span class=n>img_data</span> <span class=o>=</span> <span class=n>image</span>
<a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>
<a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>                <span class=n>parts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>img_data</span><span class=p>)</span>
<a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>
<a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a>        <span class=c1># Generate response</span>
<a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>        <span class=n>model</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>get_model</span><span class=p>(</span><span class=s2>&quot;gemini-pro-vision&quot;</span><span class=p>)</span>
<a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>        <span class=n>response</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>generate_content</span><span class=p>(</span><span class=n>parts</span><span class=p>)</span>
<a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a>
<a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span>
<a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a>
<a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a>        <span class=c1># Handle errors</span>
<a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error in multimodal processing: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a>        <span class=k>raise</span> <span class=n>ModelProcessingError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error processing multimodal content: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=usage-tracking>Usage Tracking<a class=headerlink href=#usage-tracking title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>def</span><span class=w> </span><span class=nf>track_usage</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>response</span><span class=p>):</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Track token usage for monitoring and quota management&quot;&quot;&quot;</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>response</span><span class=p>,</span> <span class=s1>&#39;usage_metadata&#39;</span><span class=p>):</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>        <span class=n>usage</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>            <span class=s1>&#39;prompt_tokens&#39;</span><span class=p>:</span> <span class=n>response</span><span class=o>.</span><span class=n>usage_metadata</span><span class=o>.</span><span class=n>prompt_token_count</span><span class=p>,</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>            <span class=s1>&#39;completion_tokens&#39;</span><span class=p>:</span> <span class=n>response</span><span class=o>.</span><span class=n>usage_metadata</span><span class=o>.</span><span class=n>candidates_token_count</span><span class=p>,</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>            <span class=s1>&#39;total_tokens&#39;</span><span class=p>:</span> <span class=p>(</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>                <span class=n>response</span><span class=o>.</span><span class=n>usage_metadata</span><span class=o>.</span><span class=n>prompt_token_count</span> <span class=o>+</span> 
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>                <span class=n>response</span><span class=o>.</span><span class=n>usage_metadata</span><span class=o>.</span><span class=n>candidates_token_count</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>            <span class=p>)</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>        <span class=p>}</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>        <span class=c1># Record usage in telemetry</span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>        <span class=n>telemetry</span><span class=o>.</span><span class=n>record_model_usage</span><span class=p>(</span><span class=s1>&#39;gemini&#39;</span><span class=p>,</span> <span class=n>usage</span><span class=p>)</span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>        <span class=k>return</span> <span class=n>usage</span>
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>    <span class=k>return</span> <span class=kc>None</span>
</code></pre></div> <h2 id=ollama-integration>Ollama Integration<a class=headerlink href=#ollama-integration title="Permanent link">&para;</a></h2> <p>Ollama provides locally deployed open-source models with a simple API.</p> <h3 id=connection-setup>Connection Setup<a class=headerlink href=#connection-setup title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>class</span><span class=w> </span><span class=nc>OllamaBackend</span><span class=p>:</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>        <span class=bp>self</span><span class=o>.</span><span class=n>host</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;host&#39;</span><span class=p>,</span> <span class=s1>&#39;localhost&#39;</span><span class=p>)</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>port</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;port&#39;</span><span class=p>,</span> <span class=mi>11434</span><span class=p>)</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;timeout&#39;</span><span class=p>,</span> <span class=mi>15</span><span class=p>)</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>        <span class=c1># Get default model</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>models</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;models&#39;</span><span class=p>,</span> <span class=p>[{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;llama2&#39;</span><span class=p>,</span> <span class=s1>&#39;default&#39;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}])</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>        <span class=bp>self</span><span class=o>.</span><span class=n>default_model</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>            <span class=p>(</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>models</span> <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;default&#39;</span><span class=p>)),</span> 
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>            <span class=s1>&#39;llama2&#39;</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>        <span class=p>)</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>        <span class=c1># Build base URL</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>        <span class=bp>self</span><span class=o>.</span><span class=n>base_url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;http://</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>host</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>port</span><span class=si>}</span><span class=s2>&quot;</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>        <span class=c1># Verify connection</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_verify_connection</span><span class=p>()</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>    <span class=k>def</span><span class=w> </span><span class=nf>_verify_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Verify connection to Ollama server&quot;&quot;&quot;</span>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>        <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a>            <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a>                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base_url</span><span class=si>}</span><span class=s2>/api/tags&quot;</span><span class=p>,</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a>                <span class=n>timeout</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>timeout</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a>            <span class=p>)</span>
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a>            <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a>            <span class=n>available_models</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;models&#39;</span><span class=p>,</span> <span class=p>[])</span>
<a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a>
<a id=__codelineno-4-30 name=__codelineno-4-30 href=#__codelineno-4-30></a>            <span class=c1># Check if our models are available</span>
<a id=__codelineno-4-31 name=__codelineno-4-31 href=#__codelineno-4-31></a>            <span class=k>for</span> <span class=n>required_model</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>:</span>
<a id=__codelineno-4-32 name=__codelineno-4-32 href=#__codelineno-4-32></a>                <span class=n>model_name</span> <span class=o>=</span> <span class=n>required_model</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span>
<a id=__codelineno-4-33 name=__codelineno-4-33 href=#__codelineno-4-33></a>                <span class=k>if</span> <span class=ow>not</span> <span class=nb>any</span><span class=p>(</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>model_name</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>available_models</span><span class=p>):</span>
<a id=__codelineno-4-34 name=__codelineno-4-34 href=#__codelineno-4-34></a>                    <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Model </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2> not found in Ollama server&quot;</span><span class=p>)</span>
<a id=__codelineno-4-35 name=__codelineno-4-35 href=#__codelineno-4-35></a>
<a id=__codelineno-4-36 name=__codelineno-4-36 href=#__codelineno-4-36></a>        <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>RequestException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-4-37 name=__codelineno-4-37 href=#__codelineno-4-37></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Failed to connect to Ollama server: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-4-38 name=__codelineno-4-38 href=#__codelineno-4-38></a>            <span class=c1># Don&#39;t raise here - allow system to try connection when needed</span>
</code></pre></div> <h3 id=request-processing_1>Request Processing<a class=headerlink href=#request-processing_1 title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>def</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Process a query using Ollama API&quot;&quot;&quot;</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>        <span class=n>model</span> <span class=o>=</span> <span class=n>model</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>default_model</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>        <span class=c1># Prepare request body</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>        <span class=n>request_body</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>            <span class=s2>&quot;model&quot;</span><span class=p>:</span> <span class=n>model</span><span class=p>,</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>            <span class=s2>&quot;prompt&quot;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>            <span class=s2>&quot;stream&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>            <span class=s2>&quot;options&quot;</span><span class=p>:</span> <span class=p>{</span>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>                <span class=s2>&quot;temperature&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>temperature</span><span class=p>,</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>                <span class=s2>&quot;top_p&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>top_p</span><span class=p>,</span>
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>                <span class=s2>&quot;num_ctx&quot;</span><span class=p>:</span> <span class=mi>2048</span>  <span class=c1># Context window size</span>
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>            <span class=p>}</span>
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>        <span class=p>}</span>
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>        <span class=c1># Add system context if provided</span>
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>        <span class=k>if</span> <span class=n>context</span><span class=p>:</span>
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>            <span class=n>request_body</span><span class=p>[</span><span class=s2>&quot;system&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span>
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>        <span class=c1># Send request to Ollama API</span>
<a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
<a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>            <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base_url</span><span class=si>}</span><span class=s2>/api/generate&quot;</span><span class=p>,</span>
<a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>            <span class=n>json</span><span class=o>=</span><span class=n>request_body</span><span class=p>,</span>
<a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>            <span class=n>timeout</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>timeout</span>
<a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>        <span class=p>)</span>
<a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
<a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
<a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a>
<a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;response&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
<a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a>
<a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>Timeout</span><span class=p>:</span>
<a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a>        <span class=k>raise</span> <span class=n>ServiceUnavailableError</span><span class=p>(</span><span class=s2>&quot;Ollama request timed out&quot;</span><span class=p>)</span>
<a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>ConnectionError</span><span class=p>:</span>
<a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a>        <span class=k>raise</span> <span class=n>ServiceUnavailableError</span><span class=p>(</span><span class=s2>&quot;Unable to connect to Ollama server&quot;</span><span class=p>)</span>
<a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a>    <span class=k>except</span> <span class=n>requests</span><span class=o>.</span><span class=n>exceptions</span><span class=o>.</span><span class=n>HTTPError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-5-38 name=__codelineno-5-38 href=#__codelineno-5-38></a>        <span class=k>raise</span> <span class=n>ModelProcessingError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Ollama HTTP error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-5-39 name=__codelineno-5-39 href=#__codelineno-5-39></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-5-40 name=__codelineno-5-40 href=#__codelineno-5-40></a>        <span class=k>raise</span> <span class=n>ModelProcessingError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error processing with Ollama: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=model-management>Model Management<a class=headerlink href=#model-management title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>def</span><span class=w> </span><span class=nf>list_available_models</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;List models available on the Ollama server&quot;&quot;&quot;</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>            <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base_url</span><span class=si>}</span><span class=s2>/api/tags&quot;</span><span class=p>,</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>            <span class=n>timeout</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>timeout</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>        <span class=p>)</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;models&#39;</span><span class=p>,</span> <span class=p>[])</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error listing Ollama models: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>        <span class=k>return</span> <span class=p>[]</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=k>def</span><span class=w> </span><span class=nf>pull_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_name</span><span class=p>):</span>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Pull a model to the Ollama server if not already available&quot;&quot;&quot;</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>        <span class=c1># Check if model exists</span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>        <span class=n>available_models</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>list_available_models</span><span class=p>()</span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>        <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=o>==</span> <span class=n>model_name</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>available_models</span><span class=p>):</span>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Model </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2> already available&quot;</span><span class=p>)</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>            <span class=k>return</span> <span class=kc>True</span>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>        <span class=c1># Pull model</span>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Pulling model </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2> to Ollama server...&quot;</span><span class=p>)</span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>        <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>            <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base_url</span><span class=si>}</span><span class=s2>/api/pull&quot;</span><span class=p>,</span>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>            <span class=n>json</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>model_name</span><span class=p>},</span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a>            <span class=n>timeout</span><span class=o>=</span><span class=mi>300</span>  <span class=c1># Longer timeout for model pulls</span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a>        <span class=p>)</span>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a>        <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a>        <span class=k>return</span> <span class=kc>True</span>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error pulling model </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a>        <span class=k>return</span> <span class=kc>False</span>
</code></pre></div> <h2 id=transformers-integration>Transformers Integration<a class=headerlink href=#transformers-integration title="Permanent link">&para;</a></h2> <p>Hugging Face Transformers provides a flexible library for running models locally.</p> <h3 id=initialization>Initialization<a class=headerlink href=#initialization title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>class</span><span class=w> </span><span class=nc>TransformersBackend</span><span class=p>:</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>):</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>        <span class=bp>self</span><span class=o>.</span><span class=n>model_path</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;model_path&#39;</span><span class=p>,</span> <span class=s1>&#39;./models/local&#39;</span><span class=p>)</span>
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>default_model</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;default_model&#39;</span><span class=p>,</span> <span class=s1>&#39;microsoft/phi-2&#39;</span><span class=p>)</span>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>quantization</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;quantization&#39;</span><span class=p>,</span> <span class=s1>&#39;int8&#39;</span><span class=p>)</span>
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>        <span class=c1># Determine device (CPU/GPU)</span>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>        <span class=bp>self</span><span class=o>.</span><span class=n>device</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;device&#39;</span><span class=p>,</span> <span class=s1>&#39;auto&#39;</span><span class=p>)</span>
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>device</span> <span class=o>==</span> <span class=s1>&#39;auto&#39;</span><span class=p>:</span>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>            <span class=bp>self</span><span class=o>.</span><span class=n>device</span> <span class=o>=</span> <span class=s1>&#39;cuda&#39;</span> <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>()</span> <span class=k>else</span> <span class=s1>&#39;cpu&#39;</span>
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>        <span class=c1># Load default model</span>
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>        <span class=bp>self</span><span class=o>.</span><span class=n>models</span> <span class=o>=</span> <span class=p>{}</span>
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_load_model</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>default_model</span><span class=p>)</span>
<a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>
<a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a>    <span class=k>def</span><span class=w> </span><span class=nf>_load_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_name</span><span class=p>):</span>
<a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Load a model if not already loaded&quot;&quot;&quot;</span>
<a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a>        <span class=k>if</span> <span class=n>model_name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>:</span>
<a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>[</span><span class=n>model_name</span><span class=p>]</span>
<a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a>
<a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a>        <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Loading Transformers model: </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>
<a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a>            <span class=c1># Load model with appropriate quantization</span>
<a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>quantization</span> <span class=o>==</span> <span class=s1>&#39;int8&#39;</span><span class=p>:</span>
<a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a>                <span class=n>model</span> <span class=o>=</span> <span class=n>AutoModelForCausalLM</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span>
<a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a>                    <span class=n>model_name</span><span class=p>,</span>
<a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a>                    <span class=n>device_map</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>device</span><span class=p>,</span>
<a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a>                    <span class=n>load_in_8bit</span><span class=o>=</span><span class=kc>True</span>
<a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a>                <span class=p>)</span>
<a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a>            <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>quantization</span> <span class=o>==</span> <span class=s1>&#39;int4&#39;</span><span class=p>:</span>
<a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a>                <span class=n>model</span> <span class=o>=</span> <span class=n>AutoModelForCausalLM</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span>
<a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a>                    <span class=n>model_name</span><span class=p>,</span>
<a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a>                    <span class=n>device_map</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>device</span><span class=p>,</span>
<a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a>                    <span class=n>load_in_4bit</span><span class=o>=</span><span class=kc>True</span>
<a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a>                <span class=p>)</span>
<a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a>            <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a>                <span class=n>model</span> <span class=o>=</span> <span class=n>AutoModelForCausalLM</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span>
<a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a>                    <span class=n>model_name</span><span class=p>,</span> 
<a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a>                    <span class=n>device_map</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>device</span>
<a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a>                <span class=p>)</span>
<a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a>
<a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a>            <span class=c1># Load tokenizer</span>
<a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a>            <span class=n>tokenizer</span> <span class=o>=</span> <span class=n>AutoTokenizer</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
<a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a>
<a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a>            <span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>[</span><span class=n>model_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
<a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a>                <span class=s1>&#39;model&#39;</span><span class=p>:</span> <span class=n>model</span><span class=p>,</span>
<a id=__codelineno-7-48 name=__codelineno-7-48 href=#__codelineno-7-48></a>                <span class=s1>&#39;tokenizer&#39;</span><span class=p>:</span> <span class=n>tokenizer</span><span class=p>,</span>
<a id=__codelineno-7-49 name=__codelineno-7-49 href=#__codelineno-7-49></a>                <span class=s1>&#39;last_used&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<a id=__codelineno-7-50 name=__codelineno-7-50 href=#__codelineno-7-50></a>            <span class=p>}</span>
<a id=__codelineno-7-51 name=__codelineno-7-51 href=#__codelineno-7-51></a>
<a id=__codelineno-7-52 name=__codelineno-7-52 href=#__codelineno-7-52></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>[</span><span class=n>model_name</span><span class=p>]</span>
<a id=__codelineno-7-53 name=__codelineno-7-53 href=#__codelineno-7-53></a>
<a id=__codelineno-7-54 name=__codelineno-7-54 href=#__codelineno-7-54></a>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-7-55 name=__codelineno-7-55 href=#__codelineno-7-55></a>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error loading model </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-7-56 name=__codelineno-7-56 href=#__codelineno-7-56></a>            <span class=k>raise</span> <span class=n>ModelInitializationError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Failed to load </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=request-processing_2>Request Processing<a class=headerlink href=#request-processing_2 title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>def</span><span class=w> </span><span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>context</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>model_name</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Process a query using Transformers&quot;&quot;&quot;</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=k>try</span><span class=p>:</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>        <span class=n>model_name</span> <span class=o>=</span> <span class=n>model_name</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>default_model</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>        <span class=c1># Load model if not already loaded</span>
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        <span class=k>if</span> <span class=n>model_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>:</span>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_load_model</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>        <span class=n>model_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>[</span><span class=n>model_name</span><span class=p>]</span>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>        <span class=n>model</span> <span class=o>=</span> <span class=n>model_data</span><span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>]</span>
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>        <span class=n>tokenizer</span> <span class=o>=</span> <span class=n>model_data</span><span class=p>[</span><span class=s1>&#39;tokenizer&#39;</span><span class=p>]</span>
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>        <span class=c1># Update last used timestamp</span>
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>        <span class=n>model_data</span><span class=p>[</span><span class=s1>&#39;last_used&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>        <span class=c1># Prepare input text with context if provided</span>
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>        <span class=k>if</span> <span class=n>context</span><span class=p>:</span>
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>            <span class=n>input_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>User: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Assistant:&quot;</span>
<a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>        <span class=k>else</span><span class=p>:</span>
<a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>            <span class=n>input_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;User: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Assistant:&quot;</span>
<a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>
<a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>        <span class=c1># Tokenize input</span>
<a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a>        <span class=n>inputs</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=p>(</span><span class=n>input_text</span><span class=p>,</span> <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&quot;pt&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>device</span><span class=p>)</span>
<a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a>
<a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>        <span class=c1># Generate response</span>
<a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a>        <span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
<a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>            <span class=n>output</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span>
<a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a>                <span class=n>inputs</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>],</span>
<a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a>                <span class=n>max_new_tokens</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span>
<a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a>                <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
<a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a>                <span class=n>top_p</span><span class=o>=</span><span class=mf>0.9</span><span class=p>,</span>
<a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a>                <span class=n>do_sample</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a>                <span class=n>pad_token_id</span><span class=o>=</span><span class=n>tokenizer</span><span class=o>.</span><span class=n>eos_token_id</span>
<a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a>            <span class=p>)</span>
<a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a>
<a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a>        <span class=c1># Decode and clean response</span>
<a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a>        <span class=n>response_text</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>output</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>skip_special_tokens</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a>        <span class=n>response_text</span> <span class=o>=</span> <span class=n>response_text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=n>input_text</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
<a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a>
<a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a>        <span class=c1># Unload rarely used models to save memory</span>
<a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_manage_loaded_models</span><span class=p>()</span>
<a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a>
<a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a>        <span class=k>return</span> <span class=n>response_text</span>
<a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a>
<a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a>    <span class=k>except</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>OutOfMemoryError</span><span class=p>:</span>
<a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;CUDA out of memory while processing with </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-8-48 name=__codelineno-8-48 href=#__codelineno-8-48></a>        <span class=k>raise</span> <span class=n>ResourceExhaustedError</span><span class=p>(</span><span class=s2>&quot;GPU memory exhausted&quot;</span><span class=p>)</span>
<a id=__codelineno-8-49 name=__codelineno-8-49 href=#__codelineno-8-49></a>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
<a id=__codelineno-8-50 name=__codelineno-8-50 href=#__codelineno-8-50></a>        <span class=k>raise</span> <span class=n>ModelProcessingError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error processing with Transformers: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=memory-management>Memory Management<a class=headerlink href=#memory-management title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>def</span><span class=w> </span><span class=nf>_manage_loaded_models</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Unload models that haven&#39;t been used recently to free memory&quot;&quot;&quot;</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>    <span class=n>unload_threshold</span> <span class=o>=</span> <span class=mi>3600</span>  <span class=c1># 1 hour</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>    <span class=c1># Don&#39;t unload if only one model is loaded</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>:</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>        <span class=k>return</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>    <span class=c1># Check each model&#39;s last used time</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>    <span class=k>for</span> <span class=n>model_name</span><span class=p>,</span> <span class=n>model_data</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=o>.</span><span class=n>items</span><span class=p>()):</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>        <span class=c1># Skip default model</span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a>        <span class=k>if</span> <span class=n>model_name</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>default_model</span><span class=p>:</span>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a>            <span class=k>continue</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>        <span class=c1># Unload if unused for threshold period</span>
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>        <span class=k>if</span> <span class=n>now</span> <span class=o>-</span> <span class=n>model_data</span><span class=p>[</span><span class=s1>&#39;last_used&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>unload_threshold</span><span class=p>:</span>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Unloading unused model: </span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
<a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a>            <span class=c1># Remove from loaded models</span>
<a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a>            <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>[</span><span class=n>model_name</span><span class=p>]</span>
<a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a>
<a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a>            <span class=c1># Force garbage collection</span>
<a id=__codelineno-9-23 name=__codelineno-9-23 href=#__codelineno-9-23></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>device</span> <span class=o>==</span> <span class=s1>&#39;cuda&#39;</span><span class=p>:</span>
<a id=__codelineno-9-24 name=__codelineno-9-24 href=#__codelineno-9-24></a>                <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>empty_cache</span><span class=p>()</span>
<a id=__codelineno-9-25 name=__codelineno-9-25 href=#__codelineno-9-25></a>            <span class=n>gc</span><span class=o>.</span><span class=n>collect</span><span class=p>()</span>
</code></pre></div> <h2 id=error-handling>Error Handling<a class=headerlink href=#error-handling title="Permanent link">&para;</a></h2> <p>Each provider has specific error types that require specialized handling:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>class</span><span class=w> </span><span class=nc>ModelError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Base class for model-related errors&quot;&quot;&quot;</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    <span class=k>pass</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=k>class</span><span class=w> </span><span class=nc>ModelInitializationError</span><span class=p>(</span><span class=n>ModelError</span><span class=p>):</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Error initializing a model&quot;&quot;&quot;</span>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a>    <span class=k>pass</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>
<a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=k>class</span><span class=w> </span><span class=nc>ModelProcessingError</span><span class=p>(</span><span class=n>ModelError</span><span class=p>):</span>
<a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Error processing a request&quot;&quot;&quot;</span>
<a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>    <span class=k>pass</span>
<a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>
<a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=k>class</span><span class=w> </span><span class=nc>ServiceUnavailableError</span><span class=p>(</span><span class=n>ModelError</span><span class=p>):</span>
<a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Model service is unavailable&quot;&quot;&quot;</span>
<a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>    <span class=k>pass</span>
<a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>
<a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=k>class</span><span class=w> </span><span class=nc>RateLimitError</span><span class=p>(</span><span class=n>ModelError</span><span class=p>):</span>
<a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Rate limit exceeded&quot;&quot;&quot;</span>
<a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a>    <span class=k>pass</span>
<a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a>
<a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=k>class</span><span class=w> </span><span class=nc>QuotaExceededError</span><span class=p>(</span><span class=n>ModelError</span><span class=p>):</span>
<a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Usage quota exceeded&quot;&quot;&quot;</span>
<a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a>    <span class=k>pass</span>
<a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a>
<a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a><span class=k>class</span><span class=w> </span><span class=nc>ResourceExhaustedError</span><span class=p>(</span><span class=n>ModelError</span><span class=p>):</span>
<a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Computational resources exhausted&quot;&quot;&quot;</span>
<a id=__codelineno-10-27 name=__codelineno-10-27 href=#__codelineno-10-27></a>    <span class=k>pass</span>
</code></pre></div> <h2 id=provider-specific-considerations>Provider-Specific Considerations<a class=headerlink href=#provider-specific-considerations title="Permanent link">&para;</a></h2> <h3 id=gemini>Gemini<a class=headerlink href=#gemini title="Permanent link">&para;</a></h3> <ul> <li><strong>Rate Limiting</strong>: Implements exponential backoff for rate limit errors</li> <li><strong>API Key Rotation</strong>: Supports multiple API keys with automatic rotation</li> <li><strong>Quota Tracking</strong>: Monitors token usage to prevent quota overruns</li> <li><strong>Safety Settings</strong>: Configurable content safety parameters</li> </ul> <h3 id=ollama>Ollama<a class=headerlink href=#ollama title="Permanent link">&para;</a></h3> <ul> <li><strong>Health Checks</strong>: Periodic verification of server availability</li> <li><strong>Model Loading</strong>: Dynamic loading of models as needed</li> <li><strong>Resource Monitoring</strong>: Tracks resource usage to prevent overloading</li> <li><strong>Concurrency Control</strong>: Limits parallel requests to prevent resource contention</li> </ul> <h3 id=transformers>Transformers<a class=headerlink href=#transformers title="Permanent link">&para;</a></h3> <ul> <li><strong>GPU Management</strong>: Dynamic allocation of GPU resources</li> <li><strong>Memory Optimization</strong>: Automatic model unloading to preserve memory</li> <li><strong>Quantization</strong>: Support for different quantization levels (4-bit, 8-bit)</li> <li><strong>Model Caching</strong>: Efficient loading and caching of model weights</li> </ul> <h2 id=related-documentation>Related Documentation<a class=headerlink href=#related-documentation title="Permanent link">&para;</a></h2> <ul> <li>Model Integration Architecture</li> <li>Backend Selection</li> <li>Capability Matrix</li> <li>Model Configuration</li> </ul> </div> </div><footer> <div class=rst-footer-buttons role=navigation aria-label="Footer Navigation"> <a href=../capability-matrix/ class="btn btn-neutral float-left" title="Capability Matrix"><span class="icon icon-circle-arrow-left"></span> Previous</a> <a href=../configuration/ class="btn btn-neutral float-right" title=Configuration>Next <span class="icon icon-circle-arrow-right"></span></a> </div> <hr> <div role=contentinfo> <!-- Copyright etc --> </div> Built with <a href=https://www.mkdocs.org/ >MkDocs</a> using a <a href=https://github.com/readthedocs/sphinx_rtd_theme>theme</a> provided by <a href=https://readthedocs.org>Read the Docs</a>. </footer> </div> </div> </section> </div> <div class=rst-versions role=note aria-label=Versions> <span class=rst-current-version data-toggle=rst-current-version> <span><a href=../capability-matrix/ style="color: #fcfcfc">&laquo; Previous</a></span> <span><a href=../configuration/ style="color: #fcfcfc">Next &raquo;</a></span> </span> </div> <script src=../../js/jquery-3.6.0.min.js></script> <script>var base_url = "../..";</script> <script src=../../js/theme_extra.js></script> <script src=../../js/theme.js></script> <script src=../../search/main.js></script> <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script> </body> </html> 